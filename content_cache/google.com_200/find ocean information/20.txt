<!doctype html>
<html lang="en">
 <head> 
  <meta charset="utf-8"> 
  <meta name="apple-mobile-web-app-capable" content="yes"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <meta name="apple-mobile-web-app-status-bar-style" content="black"> 
  <link rel="shortcut icon" href="/assets/flat-ui/images/favicon.ico"> 
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://ropensci.org/feed.xml"> 
  <link rel="stylesheet" href="/assets/flat-ui/bootstrap/css/bootstrap.css"> 
  <link rel="stylesheet" href="/assets/flat-ui/css/flat-ui.css"> 
  <link rel="stylesheet" href="/assets/common-files/css/icon-font.css"> 
  <link rel="stylesheet" href="/assets/common-files/css/animations.css"> 
  <link rel="stylesheet" href="/static/css/style.css"> 
  <link href="/assets/css/ss-social/webfonts/ss-social.css" rel="stylesheet"> 
  <link href="/assets/css/ss-standard/webfonts/ss-standard.css" rel="stylesheet"> 
  <link rel="stylesheet" href="/static/css/github.css"> 
  <script type="text/javascript" src="//use.typekit.net/djn7rbd.js"></script> 
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script> 
  <script src="/static/highlight.pack.js"></script> 
  <script>hljs.initHighlightingOnLoad();</script> 
  <title>Extracting and Enriching Ocean Biogeographic Information System (OBIS) Data with R</title> 
  <meta name="keywords" content="R, community, biodiversity, taxize, spenv, worrms"> 
  <meta name="description" content=""> 
  <meta name="resource_type" content="website"> 
  <!-- RDFa Metadata (in DublinCore) --> 
  <meta property="dc:title" content="Extracting and Enriching Ocean Biogeographic Information System (OBIS) Data with R"> 
  <meta property="dc:creator" content=""> 
  <meta property="dc:date" content=""> 
  <meta property="dc:format" content="text/html"> 
  <meta property="dc:language" content="en"> 
  <meta property="dc:identifier" content="/blog/blog/2017/01/25/obis"> 
  <meta property="dc:rights" content="CC0"> 
  <meta property="dc:source" content=""> 
  <meta property="dc:subject" content="Ecology"> 
  <meta property="dc:type" content="website"> 
  <!-- RDFa Metadata (in OpenGraph) --> 
  <meta property="og:title" content="Extracting and Enriching Ocean Biogeographic Information System (OBIS) Data with R"> 
  <meta property="og:author" content="/index.html#me"> 
  <!-- Should be Liquid? URI? --> 
  <meta property="http://ogp.me/ns/profile#first_name" content=""> 
  <meta property="http://ogp.me/ns/profile#last_name" content=""> 
  <meta property="http://ogp.me/ns/article#published_time" content=""> 
  <meta property="og:site_name" content=""> 
  <!-- Same as dc:source? --> 
  <meta property="og:url" content="/blog/blog/2017/01/25/obis"> 
  <meta property="og:type" content="website"> 
  <!-- Google Scholar Metadata --> 
  <meta name="citation_author" content=""> 
  <meta name="citation_date" content=""> 
  <meta name="citation_title" content="Extracting and Enriching Ocean Biogeographic Information System (OBIS) Data with R"> 
  <meta name="citation_journal_title" content=""> 
 </head> 
 <body> 
  <div class="page-wrapper"> 
   <header class="header-10"> 
    <div class="container"> 
     <div class="row"> 
      <div class="navbar col-sm-12" role="navigation"> 
       <div class="navbar-header navlogo"> 
        <button type="button" class="navbar-toggle"></button> 
        <a class="brand" href="/"><img src="/assets/common-files/img/header/nav_small.png"></a> 
       </div> 
       <div class="collapse navbar-collapse pull-right"> 
        <ul class="nav pull-left"> 
         <li><a href="/">HOME</a></li> 
         <li><a href="/blog/">BLOG</a></li> 
         <li><a href="/packages/">PACKAGES</a></li> 
         <li><a href="/community/">COMMUNITY</a></li> 
         <li><a href="http://discuss.ropensci.org/">DISCUSS</a></li> 
         <li><a href="/contact.html">CONTACT</a></li> 
        </ul> 
       </div> 
      </div> 
     </div> 
    </div> 
    <div class="header-background"></div> 
   </header> 
   <section class="blog-3"> 
    <div class="container"> 
     <div class="title"> 
      <img src="/assets/common-files/img/content/blog_header_logo.png" alt=""> 
      <h3>Extracting and Enriching Ocean Biogeographic Information System (OBIS) Data with R</h3> 
      <div class="submitted"> 
       <!-- author goes here --> 
       <a href="https://www.shef.ac.uk/aps/staff-and-students/acadstaff/webb" target="_blank"> Tom Webb </a>&nbsp; 
       <!-- end author --> 
      </div> 
      <div class="submitted">
       January 25, 2017 
      </div> 
     </div> 
     <div class="row"> 
      <div class="col-sm-8 col-sm-offset-2"> 
       <p>Programmatic access to biodiversity data is revolutionising large-scale, reproducible biodiversity research. In the marine realm, the largest global database of species occurrence records is the Ocean Biogeographic Information System, <a href="http://www.iobis.org/">OBIS</a>. As of January 2017, OBIS contains 47.78 million occurrences of 117,345 species, all openly available and accessible via the <a href="http://www.iobis.org/manual/api/">OBIS API</a>. The number of questions to address using these kinds of resources is as large as the number of investigators, but certain operations commonly crop up in many workflows. In my group, <a href="https://shefmeme.org/">shefmeme.org</a>, these typically involve checking the taxonomy of a list of species, extracting occurrence records for each species, mapping these and matching them to various environmental and geographic data layers, all using R. I recently wrote up these common operations in a <a href="http://www.iobis.org/2016/11/22/sorbycollection/">detailed tutorial for OBIS</a>, with <a href="https://github.com/iobis/training/tree/master/sorbycollection">associated code and data on GitHub</a>. This tutorial made extensive use of <a href="https://ropensci.org/">rOpenSci</a> packages and expertise, and so I’m delighted to have the opportunity to present an edited version here. (Please note that the code chunks included here are a subset of our original code, and are for illustration - if you want to run these examples we suggest visiting the original post.)</p> 
       <hr> 
       <h1 id="starting-point-journey-and-destination">Starting point, journey, and destination</h1> 
       <p>We start with a list of taxonomic names of unknown quality. In our experience this is a common situation: you may have obtained a dataset from a collaborator, or from the literature, which documents some characteristics of a number of taxa, and you wish to tidy up this dataset and enrich it with some occurrence data. We generated a taxon list from a museum exhibit in the <a href="http://www.sheffield.ac.uk/aps">Department of Animal and Plant Sciences at the University of Sheffield</a>: a collection of 80 marine specimens created by the 19th Century Sheffield microscopist, geologist, and naturalist <a href="https://en.wikipedia.org/wiki/Henry_Clifton_Sorby">Henry Clifton Sorby</a>. This provides a useful test-case for modern biodiversity computational methods, as there is considerable taxonomic breadth (including fish as well as numerous invertebrate groups), but the names recorded are of inconsistent taxonomic rank, and - having been recorded well over 100 years ago - many are almost certainly no longer current.</p> 
       <p>The first stage of our journey then - after transcribing the names into a spreadsheet - is to check their <strong>taxonomy</strong>. Once we are confident in the names, and have restricted the dataset to a suitable taxonomic rank (species, here), we can start to examine <strong>occurrences</strong> as recorded in OBIS. Once we have done this, for individual species and for groups of species, we can start to enrich the basic occurrence data in various ways. In particular, we show how to match the occurrences to various <strong>environmental layers</strong>, including depth and climate. And we show how to perform more sophisticated geographic searches using <strong>georeferenced boundaries and regions</strong>.</p> 
       <hr> 
       <h1 id="taxonomy">Taxonomy</h1> 
       <p>OBIS uses the <a href="http://www.marinespecies.org/">WoRMS</a> standard taxonomy. This means that names within OBIS’s realisation of the WoRMS Aphia database will be matched correctly, but it is still often worthwhile to check your taxonomy in advance, especially if you are working with large sets of taxa (as macroecologists frequently are), or with unusual sets of names, such as the Sorby Collection. This will help to identify any potential problems or ambiguities, and also gives more flexibility for identifying and dealing with minor typos and misspellings. The tools provided by rOpenSci have made it possible to rapidly match names to WoRMS by calling the WoRMS web services directly from within R. In our original post, we provide examples using the <a href="https://github.com/ropensci/taxizesoap">taxizesoap</a> package. WoRMS have recently updated their web services, and here we use instead the new rOpenSci package <a href="https://github.com/ropensci/worrms">worrms</a> - now incorporated into <a href="https://github.com/ropensci/taxize">taxize</a>. Both options provide much of the WoRMS taxon matching functionality, for instance fuzzy (or approximate) name matching is possible, and is a convenient, scripted way of generating a taxonomically robust dataset. </p> 
       <p>First, load the required libraries:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span><span class="kn">library</span><span class="p">(</span>worrms<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span>
</code></pre>
       </div> 
       <h2 id="check-taxonomy-of-a-single-taxon">Check taxonomy of a single taxon</h2> 
       <p>Get the WoRMS ID for a single species - here, Atlantic cod, <em>Gadus morhua</em>:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>my_sp_aphia <span class="o">&lt;-</span> wm_name2id<span class="p">(</span>name <span class="o">=</span> <span class="s">"Gadus morhua"</span><span class="p">)</span>
</code></pre>
       </div> 
       <p>Then get the full WoRMS record, as a list by Aphia ID:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>my_sp_taxo <span class="o">&lt;-</span> wm_record<span class="p">(</span>id <span class="o">=</span> my_sp_aphia<span class="p">)</span>
</code></pre>
       </div> 
       <p>Or as a tibble by name - here specifying exact match only <code>(fuzzy = FALSE)</code> and restricting to marine species <code>(marine_only = TRUE)</code>:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>my_sp_taxo <span class="o">&lt;-</span> wm_records_names<span class="p">(</span>name <span class="o">=</span> <span class="s">"Gadus morhua"</span><span class="p">,</span> fuzzy <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> marine_only <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</code></pre>
       </div> 
       <h2 id="get-taxonomy-for-multiple-species">Get taxonomy for multiple species</h2> 
       <p>Start with a data frame of species names:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>my_sp <span class="o">&lt;-</span> <span class="kt">data_frame</span><span class="p">(</span>sciname <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"Gadus morhua"</span><span class="p">,</span> <span class="s">"Solea vulgaris"</span><span class="p">,</span> <span class="s">"Pleuronectes platessa"</span><span class="p">))</span>
</code></pre>
       </div> 
       <p>Then get the WoRMS records for each:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>my_sp_taxo <span class="o">&lt;-</span> wm_records_names<span class="p">(</span>name <span class="o">=</span> my_sp<span class="o">$</span>sciname<span class="p">,</span> fuzzy <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> marine_only <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</code></pre>
       </div> 
       <p>For 'n' species this returns a list of 'n' tables. Convert these into a single table with 'n' rows:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>my_sp_taxo <span class="o">&lt;-</span> bind_rows<span class="p">(</span>my_sp_taxo<span class="p">)</span>
</code></pre>
       </div> 
       <p>And look at the results:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>glimpse<span class="p">(</span>my_sp_taxo<span class="p">)</span>
</code></pre>
       </div>
       <div class="highlight">
        <pre><code class="language-text" data-lang="text"><span></span>## Observations: 3
## Variables: 25
## $ AphiaID         &lt;int&gt; 126436, 154712, 127143
## $ url             &lt;chr&gt; "http://www.marinespecies.org/aphia.php?p=taxd...
## $ scientificname  &lt;chr&gt; "Gadus morhua", "Solea vulgaris", "Pleuronecte...
## $ authority       &lt;chr&gt; "Linnaeus, 1758", "Quensel, 1806", "Linnaeus, ...
## $ status          &lt;chr&gt; "accepted", "unaccepted", "accepted"
## $ unacceptreason  &lt;chr&gt; NA, "synonym", NA
## $ rank            &lt;chr&gt; "Species", "Species", "Species"
## $ valid_AphiaID   &lt;int&gt; 126436, 127160, 127143
## $ valid_name      &lt;chr&gt; "Gadus morhua", "Solea solea", "Pleuronectes p...
## $ valid_authority &lt;chr&gt; "Linnaeus, 1758", "(Linnaeus, 1758)", "Linnaeu...
## $ kingdom         &lt;chr&gt; "Animalia", "Animalia", "Animalia"
## $ phylum          &lt;chr&gt; "Chordata", "Chordata", "Chordata"
## $ class           &lt;chr&gt; "Actinopteri", "Actinopteri", "Actinopteri"
## $ order           &lt;chr&gt; "Gadiformes", "Pleuronectiformes", "Pleuronect...
## $ family          &lt;chr&gt; "Gadidae", "Soleidae", "Pleuronectidae"
## $ genus           &lt;chr&gt; "Gadus", "Solea", "Pleuronectes"
## $ citation        &lt;chr&gt; "Bailly, N. (2008). Gadus morhua Linnaeus, 175...
## $ lsid            &lt;chr&gt; "urn:lsid:marinespecies.org:taxname:126436", "...
## $ isMarine        &lt;int&gt; 1, 1, 1
## $ isBrackish      &lt;int&gt; 1, 1, 1
## $ isFreshwater    &lt;int&gt; 0, 0, 0
## $ isTerrestrial   &lt;int&gt; 0, 0, 0
## $ isExtinct       &lt;lgl&gt; NA, NA, NA
## $ match_type      &lt;chr&gt; "exact", "exact", "exact"
## $ modified        &lt;chr&gt; "2008-01-15T18:27:08Z", "2008-02-28T14:41:08Z"...
</code></pre>
       </div> 
       <p>Note that the name we supplied is correct for cod and plaice, but <em>Solea vulgaris</em> is not valid and has the valid name <em>Solea solea</em>.</p> 
       <hr> 
       <h1 id="getting-occurrences">Getting occurrences</h1> 
       <p>Once you have your taxon name, or list of names, it is straightforward to extract their OBIS occurrences using the <a href="https://github.com/iobis/robis">robis</a> package. And armed with a list of occurrences for a given taxon, or list of species, you probably want to map them. Here we show how to obtain and map occurrence records for a single species.</p> 
       <p>First install and load additional required packages:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span><span class="c1"># install robis package using devtools</span>
<span class="kn">library</span><span class="p">(</span>devtools<span class="p">)</span>
devtools<span class="o">::</span>install_github<span class="p">(</span><span class="s">"iobis/robis"</span><span class="p">)</span>
<span class="c1"># NB - you also need the dev version of ggmap for the satellite maps to work</span>
devtools<span class="o">::</span>install_github<span class="p">(</span><span class="s">"dkahle/ggmap"</span><span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>robis<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>ggmap<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>raster<span class="p">)</span>
</code></pre>
       </div> 
       <p>Get occurrences for sole - note that this may take some time to run:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>my_occs <span class="o">&lt;-</span> occurrence<span class="p">(</span>scientificname <span class="o">=</span> my_sp_taxo<span class="o">$</span>valid_name<span class="p">[</span><span class="m">2</span><span class="p">])</span>
</code></pre>
       </div> 
       <p>What is the bounding box for these occurrences?</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>bb_occs <span class="o">&lt;-</span> bbox<span class="p">(</span><span class="kp">cbind</span><span class="p">(</span>my_occs<span class="o">$</span>decimalLongitude<span class="p">,</span> my_occs<span class="o">$</span>decimalLatitude<span class="p">))</span>
bb_occs
</code></pre>
       </div>
       <div class="highlight">
        <pre><code class="language-text" data-lang="text"><span></span>##        min     max
## x -42.0288 151.639
## y -33.0868  61.250
</code></pre>
       </div> 
       <p>Get a base world map:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>world <span class="o">&lt;-</span> map_data<span class="p">(</span><span class="s">"world"</span><span class="p">)</span>
</code></pre>
       </div> 
       <p>Create a map from these data:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>worldmap <span class="o">&lt;-</span> ggplot<span class="p">(</span>world<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>long<span class="p">,</span> y<span class="o">=</span>lat<span class="p">))</span> <span class="o">+</span>
  geom_polygon<span class="p">(</span>aes<span class="p">(</span>group<span class="o">=</span>group<span class="p">))</span> <span class="o">+</span>
  scale_y_continuous<span class="p">(</span>breaks <span class="o">=</span> <span class="p">(</span><span class="m">-2</span><span class="o">:</span><span class="m">2</span><span class="p">)</span> <span class="o">*</span> <span class="m">30</span><span class="p">)</span> <span class="o">+</span>
  scale_x_continuous<span class="p">(</span>breaks <span class="o">=</span> <span class="p">(</span><span class="m">-4</span><span class="o">:</span><span class="m">4</span><span class="p">)</span> <span class="o">*</span> <span class="m">45</span><span class="p">)</span> <span class="o">+</span>
  theme<span class="p">(</span>panel.background <span class="o">=</span> element_rect<span class="p">(</span>fill <span class="o">=</span> <span class="s">"steelblue"</span><span class="p">))</span> <span class="o">+</span>
  coord_equal<span class="p">()</span>
</code></pre>
       </div> 
       <p>Plot the map and add the occurrence data for sole that we have just returned:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span><span class="p">(</span>occ_map <span class="o">&lt;-</span> worldmap <span class="o">+</span> geom_point<span class="p">(</span>data <span class="o">=</span> my_occs<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> decimalLongitude<span class="p">,</span> y <span class="o">=</span> decimalLatitude<span class="p">),</span>
                                 colour <span class="o">=</span> <span class="s">"darkorange"</span><span class="p">,</span> shape <span class="o">=</span> <span class="m">21</span><span class="p">,</span> alpha <span class="o">=</span> <span class="m">2</span><span class="o">/</span><span class="m">3</span><span class="p">)</span>
<span class="p">)</span>
</code></pre>
       </div> 
       <p><img src="/assets/blog-images/obis-images/occurrence-data-1.png" style="display: block; margin: auto;"></p> 
       <p>We can wrap this in a function to rapidly plot occurrences returned from OBIS onto a map:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>obis_map <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>occ_dat<span class="p">,</span> map_type <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">"satellite"</span><span class="p">,</span> <span class="s">"world"</span><span class="p">),</span> map_zoom <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> plotit <span class="o">=</span> <span class="kc">TRUE</span><span class="p">){</span>

  bb_occ <span class="o">&lt;-</span> bbox<span class="p">(</span><span class="kp">cbind</span><span class="p">(</span>occ_dat<span class="o">$</span>decimalLongitude<span class="p">,</span> occ_dat<span class="o">$</span>decimalLatitude<span class="p">))</span>

  <span class="kr">if</span><span class="p">(</span>map_type <span class="o">==</span> <span class="s">"satellite"</span><span class="p">){</span>
    <span class="kr">if</span><span class="p">(</span><span class="kp">is.null</span><span class="p">(</span>map_zoom<span class="p">)){</span>
      base_map <span class="o">&lt;-</span> get_map<span class="p">(</span>location <span class="o">=</span> bb_occ<span class="p">,</span> maptype <span class="o">=</span> <span class="s">"satellite"</span><span class="p">)</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
      base_map <span class="o">&lt;-</span> get_map<span class="p">(</span>location <span class="o">=</span> bb_occ<span class="p">,</span> maptype <span class="o">=</span> <span class="s">"satellite"</span><span class="p">,</span> zoom <span class="o">=</span> map_zoom<span class="p">)</span>
    <span class="p">}</span>
    obis_map <span class="o">&lt;-</span> ggmap<span class="p">(</span>base_map<span class="p">)</span>
  <span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span><span class="p">(</span>map_type <span class="o">==</span> <span class="s">"world"</span><span class="p">){</span>
    base_map <span class="o">&lt;-</span> map_data<span class="p">(</span><span class="s">"world"</span><span class="p">)</span>
    obis_map <span class="o">&lt;-</span> ggplot<span class="p">(</span>base_map<span class="p">,</span> aes<span class="p">(</span>x<span class="o">=</span>long<span class="p">,</span> y<span class="o">=</span>lat<span class="p">))</span> <span class="o">+</span>
      geom_polygon<span class="p">(</span>aes<span class="p">(</span>group<span class="o">=</span>group<span class="p">))</span> <span class="o">+</span>
      scale_y_continuous<span class="p">(</span>breaks <span class="o">=</span> <span class="p">(</span><span class="m">-2</span><span class="o">:</span><span class="m">2</span><span class="p">)</span> <span class="o">*</span> <span class="m">30</span><span class="p">)</span> <span class="o">+</span>
      scale_x_continuous<span class="p">(</span>breaks <span class="o">=</span> <span class="p">(</span><span class="m">-4</span><span class="o">:</span><span class="m">4</span><span class="p">)</span> <span class="o">*</span> <span class="m">45</span><span class="p">)</span> <span class="o">+</span>
      theme<span class="p">(</span>panel.background <span class="o">=</span> element_rect<span class="p">(</span>fill <span class="o">=</span> <span class="s">"steelblue"</span><span class="p">))</span> <span class="o">+</span>
      coord_equal<span class="p">()</span>
  <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
    <span class="kp">stop</span><span class="p">(</span><span class="s">"map_type must be one of 'satellite' or 'world'"</span><span class="p">,</span>
         call. <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1"># Now add the occurrence points</span>
  obis_map <span class="o">&lt;-</span> obis_map <span class="o">+</span> geom_point<span class="p">(</span>data <span class="o">=</span> occ_dat<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> decimalLongitude<span class="p">,</span> y <span class="o">=</span> decimalLatitude<span class="p">),</span>
                                    colour <span class="o">=</span> <span class="s">"darkorange"</span><span class="p">,</span> shape <span class="o">=</span> <span class="m">21</span><span class="p">,</span> alpha <span class="o">=</span> <span class="m">2</span><span class="o">/</span><span class="m">3</span><span class="p">)</span>

  <span class="kr">if</span><span class="p">(</span>plotit <span class="o">==</span> <span class="bp">T</span><span class="p">){</span><span class="kp">print</span><span class="p">(</span>obis_map<span class="p">)}</span>

  <span class="kr">return</span><span class="p">(</span>obis_map<span class="p">)</span>

<span class="p">}</span>
</code></pre>
       </div>
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>sole_map <span class="o">&lt;-</span> obis_map<span class="p">(</span>my_occs<span class="p">,</span> map_type <span class="o">=</span> <span class="s">"world"</span><span class="p">,</span> plotit <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
</code></pre>
       </div> 
       <p><img src="/assets/blog-images/obis-images/plot using this function-1.png" style="display: block; margin: auto;"></p> 
       <p>In our original post we give more examples of plotting records from individual species and multiple species, including gridded richness maps. We <a href="http://www.iobis.org/2016/11/22/sorbycollection/#understanding">also explain</a> the many fields returned by OBIS for each record, and provide examples of filtering results both pre- and post-query on a number of criteria (e.g. date, dataset, and various quality control flags), which can bring important memory savings when the returned set of occurrences is very large.</p> 
       <hr> 
       <h1 id="enriching-occurrence-data">Enriching occurrence data</h1> 
       <p>Matching species occurrences to environmental variables is a very common requirement of macroecological analyses, particularly those considering environmental drivers of species distributions, and how distributions are expected to shift as the climate changes. Environmental or geographical data layers of interest may be purely spatial (e.g. bathymetry), or spatio-temporal (e.g. sea surface temperature, SST). In our original post we show how to use the packages <a href="https://github.com/iobis/robis">robis</a> and <a href="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0073051">marmap (Pante &amp; Simon-Bouhet 2013)</a> to match occurrence records to bathymetry, necessary to perform the kinds of analyses we published <a href="http://journals.plos.org/plosone/article?id=10.1371/journal.pone.0010223">here</a>. We also show how to match occurrence records to locally-stored spatial datasets, such as the global marine environmental layers that can be downloaded from <a href="http://gmed.auckland.ac.nz/">GMED</a>. In this post, we focus on obtaining <a href="http://www.esrl.noaa.gov/psd/data/gridded/data.noaa.oisst.v2.html">NOAA gridded monthly mean Sea Surface Temperature</a> data and show how to match occurrence records to temperature in both space and time. This code is from a package in development with ROpenSci called spenv, see <a href="https://github.com/ropenscilabs/spenv">here</a>, but we use slightly modified versions of spenv functions here.</p> 
       <p>First, we use a function to download SST data from NOAA. Specifically, it downloads monthly mean data at 1 degree resolution from the Optimum Interpolation Seas Surface Temperature V2 dataset, see <a href="http://www.esrl.noaa.gov/psd/data/gridded/data.noaa.oisst.v2.html">here</a>. The data are served as a NetCDF file, but for convenience we transform this into a raster brick - this is essentially a stacked set of global rasters, each layer representing a single month in the time series. The first time you run this the file will be downloaded (takes ~10 seconds). It will then be stored locally for future use.</p> 
       <p>Start by loading additional required packages:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span><span class="kn">library</span><span class="p">(</span>ncdf4<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>lubridate<span class="p">)</span>
</code></pre>
       </div> 
       <p>Obtain the SST data from NOAA and convert to raster brick format:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>sst_prep <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>path <span class="o">=</span> <span class="s">"~/.spenv/noaa_sst"</span><span class="p">)</span> <span class="p">{</span>
  x <span class="o">&lt;-</span> <span class="kp">file.path</span><span class="p">(</span>path<span class="p">,</span> <span class="s">"sst.mnmean.nc"</span><span class="p">)</span>
  <span class="kr">if</span> <span class="p">(</span><span class="o">!</span><span class="kp">file.exists</span><span class="p">(</span>x<span class="p">))</span> <span class="p">{</span>
    <span class="kp">dir.create</span><span class="p">(</span><span class="kp">dirname</span><span class="p">(</span>x<span class="p">),</span> recursive <span class="o">=</span> <span class="kc">TRUE</span><span class="p">,</span> showWarnings <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
    download.file<span class="p">(</span><span class="s">"ftp://ftp.cdc.noaa.gov/Datasets/noaa.oisst.v2/sst.mnmean.nc"</span><span class="p">,</span> destfile <span class="o">=</span> x<span class="p">)</span>
  <span class="p">}</span>
  raster<span class="o">::</span>brick<span class="p">(</span>x<span class="p">,</span> varname <span class="o">=</span> <span class="s">"sst"</span><span class="p">)</span>
<span class="p">}</span>
sst_dat <span class="o">&lt;-</span> sst_prep<span class="p">()</span>
</code></pre>
       </div> 
       <p>View the structure of the data:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>sst_dat
</code></pre>
       </div>
       <div class="highlight">
        <pre><code class="language-text" data-lang="text"><span></span>## class       : RasterBrick 
## dimensions  : 180, 360, 64800, 417  (nrow, ncol, ncell, nlayers)
## resolution  : 1, 1  (x, y)
## extent      : 0, 360, -90, 90  (xmin, xmax, ymin, ymax)
## coord. ref. : +proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 
## data source : /Users/alunjones/.spenv/noaa_sst/sst.mnmean.nc 
## names       : X1981.12.01, X1982.01.01, X1982.02.01, X1982.03.01, X1982.04.01, X1982.05.01, X1982.06.01, X1982.07.01, X1982.08.01, X1982.09.01, X1982.10.01, X1982.11.01, X1982.12.01, X1983.01.01, X1983.02.01, ... 
## Date        : 1981-12-01, 2016-08-01 (min, max)
## varname     : sst
</code></pre>
       </div> 
       <p>Below is a wrapper function that takes your input data (x), together with identifiers for latitude, longitude, and date, and gets SST data from the NOAA SST gridded dataset. The origin argument enables conversion between the date formats of the NOAA data and your occurrence data. Note that this data also calculates an adjusted longitude, as occupancy data typically come with longitude in the range -180 (180 West) to +180 (180 East), whereas the NOAA data codes longitude as 0 to 360 degrees (running eastwards from 0 degrees):</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>sp_extract_gridded_date <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">,</span> from <span class="o">=</span> <span class="s">"noaa_sst"</span><span class="p">,</span> latitude <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
                                    longitude <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> samp_date <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> origin <span class="o">=</span> <span class="kp">as.Date</span><span class="p">(</span><span class="s">"1800-1-1"</span><span class="p">))</span> <span class="p">{</span>

  x <span class="o">&lt;-</span> spenv_guess_latlondate<span class="p">(</span>x<span class="p">,</span> latitude<span class="p">,</span> longitude<span class="p">,</span> samp_date<span class="p">)</span>
  <span class="kr">switch</span><span class="p">(</span>from<span class="p">,</span>
         noaa_sst <span class="o">=</span> <span class="p">{</span>
           mb <span class="o">&lt;-</span> sst_prep<span class="p">()</span>
           out <span class="o">&lt;-</span> <span class="kt">list</span><span class="p">()</span>
           x <span class="o">&lt;-</span> x<span class="p">[</span> <span class="o">!</span><span class="kp">is.na</span><span class="p">(</span>x<span class="o">$</span><span class="kp">date</span><span class="p">),</span> <span class="p">]</span>
           x<span class="o">$</span>date <span class="o">&lt;-</span> <span class="kp">as.Date</span><span class="p">(</span>x<span class="o">$</span><span class="kp">date</span><span class="p">)</span>
           x <span class="o">&lt;-</span> x<span class="p">[</span>x<span class="o">$</span>date <span class="o">&gt;=</span> <span class="kp">min</span><span class="p">(</span>mb<span class="o">@</span>z<span class="p">[[</span><span class="s">"Date"</span><span class="p">]]),</span> <span class="p">]</span>
           x<span class="o">$</span>lon_adj <span class="o">&lt;-</span> x<span class="o">$</span>longitude
           x<span class="o">$</span>lon_adj<span class="p">[</span>x<span class="o">$</span>lon_adj <span class="o">&lt;</span> <span class="m">0</span><span class="p">]</span> <span class="o">&lt;-</span> x<span class="o">$</span>lon_adj<span class="p">[</span>x<span class="o">$</span>lon_adj <span class="o">&lt;</span> <span class="m">0</span><span class="p">]</span> <span class="o">+</span> <span class="m">360</span>
           <span class="kr">for</span> <span class="p">(</span>i <span class="kr">in</span> <span class="kp">seq_len</span><span class="p">(</span><span class="kp">NROW</span><span class="p">(</span>x<span class="p">)))</span> <span class="p">{</span>
             out<span class="p">[[</span>i<span class="p">]]</span> <span class="o">&lt;-</span> get_env_par_space_x_time<span class="p">(</span>mb<span class="p">,</span> x<span class="p">[</span>i<span class="p">,</span> <span class="p">],</span> origin <span class="o">=</span> origin<span class="p">)</span>
           <span class="p">}</span>
           x<span class="o">$</span>sst <span class="o">&lt;-</span> <span class="kp">unlist</span><span class="p">(</span>out<span class="p">)</span>
           x
         <span class="p">}</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre>
       </div> 
       <p>You also need these utility functions:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>spenv_guess_latlondate <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">,</span> lat <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> lon <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> samp_date <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
  xnames <span class="o">&lt;-</span> <span class="kp">names</span><span class="p">(</span>x<span class="p">)</span>
  <span class="kr">if</span> <span class="p">(</span><span class="kp">is.null</span><span class="p">(</span>lat<span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="kp">is.null</span><span class="p">(</span>lon<span class="p">))</span> <span class="p">{</span>
    lats <span class="o">&lt;-</span> xnames<span class="p">[</span><span class="kp">grep</span><span class="p">(</span><span class="s">"^(lat|latitude)$"</span><span class="p">,</span> xnames<span class="p">,</span> ignore.case <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)]</span>
    lngs <span class="o">&lt;-</span> xnames<span class="p">[</span><span class="kp">grep</span><span class="p">(</span><span class="s">"^(lon|lng|long|longitude)$"</span><span class="p">,</span> xnames<span class="p">,</span> ignore.case <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)]</span>

    <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span>lats<span class="p">)</span> <span class="o">==</span> <span class="m">1</span> <span class="o">&amp;&amp;</span> <span class="kp">length</span><span class="p">(</span>lngs<span class="p">)</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">if</span> <span class="p">(</span><span class="kp">length</span><span class="p">(</span>x<span class="p">)</span> <span class="o">&gt;</span> <span class="m">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="kp">message</span><span class="p">(</span><span class="s">"Assuming '"</span><span class="p">,</span> lngs<span class="p">,</span> <span class="s">"' and '"</span><span class="p">,</span> lats<span class="p">,</span>
                <span class="s">"' are longitude and latitude, respectively"</span><span class="p">)</span>
      <span class="p">}</span>
      x <span class="o">&lt;-</span> rename<span class="p">(</span>x<span class="p">,</span> setNames<span class="p">(</span><span class="s">'latitude'</span><span class="p">,</span> <span class="kp">eval</span><span class="p">(</span>lats<span class="p">)))</span>
      x <span class="o">&lt;-</span> rename<span class="p">(</span>x<span class="p">,</span> setNames<span class="p">(</span><span class="s">'longitude'</span><span class="p">,</span> <span class="kp">eval</span><span class="p">(</span>lngs<span class="p">)))</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
      <span class="kp">stop</span><span class="p">(</span><span class="s">"Couldn't infer longitude/latitude columns, please specify with 'lat'/'lon' parameters"</span><span class="p">,</span> call. <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
    <span class="kp">message</span><span class="p">(</span><span class="s">"Using user input '"</span><span class="p">,</span> lon<span class="p">,</span> <span class="s">"' and '"</span><span class="p">,</span> lat<span class="p">,</span>
            <span class="s">"' as longitude and latitude, respectively"</span><span class="p">)</span>
    x <span class="o">&lt;-</span> plyr<span class="o">::</span>rename<span class="p">(</span>x<span class="p">,</span> setNames<span class="p">(</span><span class="s">'latitude'</span><span class="p">,</span> <span class="kp">eval</span><span class="p">(</span>lat<span class="p">)))</span>
    x <span class="o">&lt;-</span> plyr<span class="o">::</span>rename<span class="p">(</span>x<span class="p">,</span> setNames<span class="p">(</span><span class="s">'longitude'</span><span class="p">,</span> <span class="kp">eval</span><span class="p">(</span>lon<span class="p">)))</span>
  <span class="p">}</span>

  <span class="kr">if</span><span class="p">(</span><span class="kp">is.null</span><span class="p">(</span>samp_date<span class="p">)){</span>
    dates <span class="o">&lt;-</span> xnames<span class="p">[</span><span class="kp">grep</span><span class="p">(</span><span class="s">"date"</span><span class="p">,</span> xnames<span class="p">,</span> ignore.case <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)]</span>
    <span class="kr">if</span><span class="p">(</span><span class="kp">length</span><span class="p">(</span>dates<span class="p">)</span> <span class="o">==</span> <span class="m">1</span><span class="p">){</span>
      <span class="kr">if</span><span class="p">(</span><span class="kp">length</span><span class="p">(</span>x<span class="p">)</span> <span class="o">&gt;</span> <span class="m">2</span><span class="p">){</span>
        <span class="kp">message</span><span class="p">(</span><span class="s">"Assuming '"</span><span class="p">,</span> dates<span class="p">,</span> <span class="s">"' are sample dates"</span><span class="p">)</span>
      <span class="p">}</span>
      x <span class="o">&lt;-</span> rename<span class="p">(</span>x<span class="p">,</span> setNames<span class="p">(</span><span class="s">'date'</span><span class="p">,</span> <span class="kp">eval</span><span class="p">(</span>dates<span class="p">)))</span>
    <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
      <span class="kp">stop</span><span class="p">(</span><span class="s">"Couldn't infer sample date column, please specify with 'date' parameter"</span><span class="p">,</span> call. <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
    <span class="p">}</span>   

  <span class="p">}</span> <span class="kr">else</span> <span class="p">{</span>
    <span class="kp">message</span><span class="p">(</span><span class="s">"Using user input '"</span><span class="p">,</span> samp_date<span class="p">,</span> <span class="s">"' as sample date"</span><span class="p">)</span>
    x <span class="o">&lt;-</span> plyr<span class="o">::</span>rename<span class="p">(</span>x<span class="p">,</span> setNames<span class="p">(</span><span class="s">'date'</span><span class="p">,</span> <span class="kp">eval</span><span class="p">(</span>samp_date<span class="p">)))</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre>
       </div> 
       <p>And:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>get_env_par_space_x_time <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>
  env_dat<span class="p">,</span> occ_dat<span class="p">,</span> origin <span class="o">=</span> <span class="kp">as.Date</span><span class="p">(</span><span class="s">"1800-1-1"</span><span class="p">)){</span>

  <span class="c1"># calculate starting julian day for each month in env_dat</span>
  month_intervals <span class="o">&lt;-</span> <span class="kp">as.numeric</span><span class="p">(</span>env_dat<span class="o">@</span>z<span class="p">[[</span><span class="s">"Date"</span><span class="p">]]</span> <span class="o">-</span> origin<span class="p">)</span>
  <span class="c1"># calculate julian day for the focal date (eventDate in occ_dat)</span>
  focal_date <span class="o">&lt;-</span> <span class="kp">as.numeric</span><span class="p">(</span>occ_dat<span class="o">$</span>date <span class="o">-</span> origin<span class="p">)</span>

  <span class="c1"># extract environmental variable (SST here) for this point</span>
  <span class="kp">as.numeric</span><span class="p">(</span>raster<span class="o">::</span>extract<span class="p">(</span>
    env_dat<span class="p">,</span>
    <span class="kp">cbind</span><span class="p">(</span>occ_dat<span class="o">$</span>lon_adj<span class="p">,</span> occ_dat<span class="o">$</span>latitude<span class="p">),</span>
    layer <span class="o">=</span> <span class="kp">findInterval</span><span class="p">(</span>focal_date<span class="p">,</span> month_intervals<span class="p">),</span>
    nl <span class="o">=</span> <span class="m">1</span>
  <span class="p">))</span>
<span class="p">}</span>
</code></pre>
       </div> 
       <h2 id="get-sst-values-associated-with-the-sole-occupancy-data">Get SST values associated with the sole occupancy data</h2> 
       <p>First, do some cleaning of the sole data:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>sole_occs <span class="o">&lt;-</span> as_data_frame<span class="p">(</span>filter<span class="p">(</span>
  my_occs<span class="p">,</span> <span class="o">!</span><span class="kp">is.na</span><span class="p">(</span>depth<span class="p">)</span> <span class="o">&amp;</span> <span class="o">!</span><span class="kp">is.na</span><span class="p">(</span>yearcollected<span class="p">)</span> <span class="o">&amp;</span> <span class="o">!</span><span class="kp">is.na</span><span class="p">(</span>individualCount<span class="p">)</span> <span class="o">&amp;</span> depth <span class="o">!=</span> <span class="m">-9</span> <span class="o">&amp;</span> yearcollected <span class="o">&gt;=</span> <span class="m">1981</span><span class="p">))</span>
</code></pre>
       </div> 
       <p>This will now add an SST value for each occurrence. CAUTION - this may take a while to run. See our original post for a trick to speed this up!</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>sole_sst <span class="o">&lt;-</span> sp_extract_gridded_date<span class="p">(</span>x <span class="o">=</span> sole_occs<span class="p">,</span>
                                    latitude <span class="o">=</span> <span class="s">"decimalLatitude"</span><span class="p">,</span> longitude <span class="o">=</span> <span class="s">"decimalLongitude"</span><span class="p">,</span> samp_date <span class="o">=</span> <span class="s">"eventDate"</span><span class="p">)</span>
</code></pre>
       </div> 
       <p>You can now plot sole occurrences by lon and lat, colour coded by temperature, faceted by month (1 = Jan to 12 = Dec) - this first requires defining a month variable:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>sole_sst<span class="o">$</span>month <span class="o">&lt;-</span> month<span class="p">(</span>sole_sst<span class="o">$</span><span class="kp">date</span><span class="p">)</span>
</code></pre>
       </div> 
       <p>Then create the plot like this:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span><span class="p">(</span>sole_sst_plot <span class="o">&lt;-</span> <span class="p">(</span>ggplot<span class="p">(</span>sole_sst<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> longitude<span class="p">,</span> y <span class="o">=</span> latitude<span class="p">))</span> <span class="o">+</span> 
                     geom_point<span class="p">(</span>aes<span class="p">(</span>colour <span class="o">=</span> sst<span class="p">),</span> alpha <span class="o">=</span> <span class="m">2</span><span class="o">/</span><span class="m">3</span><span class="p">)</span> <span class="o">+</span>
                     scale_colour_gradient<span class="p">(</span>low <span class="o">=</span> <span class="s">"blue"</span><span class="p">,</span> high <span class="o">=</span> <span class="s">"red"</span><span class="p">)</span> <span class="o">+</span>
                     facet_wrap<span class="p">(</span><span class="o">~</span> month<span class="p">))</span>
<span class="p">)</span>
</code></pre>
       </div> 
       <p><img src="/assets/blog-images/obis-images/create the plot-1.png" style="display: block; margin: auto;"></p> 
       <p>Alternatively you may want to look at trends over time in SST matched to sole occurrences, again faceted by month:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span><span class="p">(</span>sole_sst_trends <span class="o">&lt;-</span> ggplot<span class="p">(</span>sole_sst<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> yearcollected<span class="p">,</span> y <span class="o">=</span> sst<span class="p">))</span> <span class="o">+</span> 
  geom_point<span class="p">(</span>colour <span class="o">=</span> <span class="s">"steelblue"</span><span class="p">,</span> alpha <span class="o">=</span> <span class="m">1</span><span class="o">/</span><span class="m">3</span><span class="p">)</span> <span class="o">+</span>
  geom_smooth<span class="p">(</span>method <span class="o">=</span> <span class="s">"lm"</span><span class="p">,</span> colour <span class="o">=</span> <span class="s">"darkorange"</span><span class="p">)</span> <span class="o">+</span>
  facet_wrap<span class="p">(</span><span class="o">~</span> month<span class="p">)</span>
<span class="p">)</span>
</code></pre>
       </div> 
       <p><img src="/assets/blog-images/obis-images/look at trends in SST matched to sole occurrences-1.png" style="display: block; margin: auto;"></p> 
       <hr> 
       <h1 id="adding-geography">Adding geography</h1> 
       <p>All of the examples above have been global in scale, meaning that we have placed no spatial restrictions on the queries to OBIS - we have simply requested all occurrences that have been recorded anywhere on earth. However, we are frequently interested in sub-global analyses, either extracting data for an individual region of interest (such as a specific country’s EEZ), or summarising global data by region (e.g. records per regional sea). Here we show how OBIS queries can be refined using specific geometries, either supplied manually or as named regions obtained from the <a href="http://www.marineregions.org/">Marine Regions database</a>. In these examples we return all records for a focal species within a region of interest, and also return a full species list for a focal region. In our original post we also showed how to combine geographic and environmental filters, for example returning all species occurring in regions of the North Atlantic that are &lt;1000m deep.</p> 
       <p>Start by loading additional required packages:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span><span class="kn">library</span><span class="p">(</span>rgdal<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>mregions<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>rgeos<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>broom<span class="p">)</span>
</code></pre>
       </div> 
       <p>Get the UK EEZ shape file from marineregions:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>uk_eez <span class="o">&lt;-</span> mr_shp<span class="p">(</span><span class="s">"MarineRegions:eez"</span><span class="p">,</span>
    maxFeatures <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> filter <span class="o">=</span> <span class="s">"United Kingdom Exclusive Economic Zone"</span><span class="p">)</span>
</code></pre>
       </div> 
       <p>For convenience, simplify this and convert it to a data frame:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>uk_eez_simple <span class="o">&lt;-</span> SpatialPolygonsDataFrame<span class="p">(</span>gSimplify<span class="p">(</span>
    uk_eez<span class="p">,</span> tol <span class="o">=</span> <span class="m">0.01</span><span class="p">,</span> topologyPreserve <span class="o">=</span> <span class="kc">TRUE</span><span class="p">),</span> data <span class="o">=</span> uk_eez<span class="o">@</span>data<span class="p">)</span>
uk_eez_df <span class="o">&lt;-</span> tidy<span class="p">(</span>uk_eez_simple<span class="p">)</span>
</code></pre>
       </div> 
       <p>Get occurrences for a species (here, basking shark) within the UK EEZ:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>basking_shark <span class="o">&lt;-</span> occurrence<span class="p">(</span>
    scientificname <span class="o">=</span> <span class="s">"Cetorhinus maximus"</span><span class="p">,</span> geometry <span class="o">=</span> mr_as_wkt<span class="p">(</span>uk_eez_simple<span class="p">))</span>
</code></pre>
       </div> 
       <p>Create the occurrence plot, then add the EEZ:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>basking_map <span class="o">&lt;-</span> obis_map<span class="p">(</span>basking_shark<span class="p">,</span> map_type <span class="o">=</span> <span class="s">"satellite"</span><span class="p">,</span> map_zoom <span class="o">=</span> <span class="m">4</span><span class="p">,</span> plotit <span class="o">=</span> <span class="bp">F</span><span class="p">)</span>
basking_map <span class="o">+</span>
  geom_polygon<span class="p">(</span>data <span class="o">=</span> uk_eez_df<span class="p">,</span> aes<span class="p">(</span>x <span class="o">=</span> long<span class="p">,</span> y <span class="o">=</span> lat<span class="p">,</span> group <span class="o">=</span> group<span class="p">),</span>
               colour <span class="o">=</span> <span class="s">"green"</span><span class="p">,</span> fill <span class="o">=</span> <span class="kc">NA</span><span class="p">,</span> size <span class="o">=</span> <span class="m">0.25</span><span class="p">)</span>
</code></pre>
       </div> 
       <p><img src="/assets/blog-images/obis-images/p1.png" style="display: block; margin: auto;"></p> 
       <p>To get a list of species for a given region, use checklist, and specify your geometry (here an arbitrary 5 x 5 degree square in the NE Atlantic):</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>my_taxa <span class="o">&lt;-</span> tbl_df<span class="p">(</span>checklist<span class="p">(</span>
    geometry <span class="o">=</span> <span class="s">"POLYGON ((-20 50, -20 55, -15 55, -15 50, -20 50))"</span><span class="p">))</span>
</code></pre>
       </div> 
       <p>Then filter this to taxa with species rank:</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>my_species <span class="o">&lt;-</span> filter<span class="p">(</span>my_taxa<span class="p">,</span> rank_name <span class="o">==</span> <span class="s">"Species"</span><span class="p">)</span>
</code></pre>
       </div> 
       <p>The result is a tibble of the 930 species found in this grid square, plus their full taxonomy and some additional summary information, including the number of records in OBIS (<code>records</code>):</p> 
       <div class="highlight">
        <pre><code class="language-r" data-lang="r"><span></span>my_species
</code></pre>
       </div>
       <div class="highlight">
        <pre><code class="language-text" data-lang="text"><span></span>## # A tibble: 930 × 18
##        id valid_id parent_id rank_name                   tname
##     &lt;int&gt;    &lt;int&gt;     &lt;int&gt;     &lt;chr&gt;                   &lt;chr&gt;
## 1  395754   395754    695236   Species     Acanthephyra eximia
## 2  395764   395764    695236   Species   Acanthephyra pelagica
## 3  395973   395973    395971   Species Acanthoica quattrospina
## 4  396173   396173    767483   Species Acanthoscina acanthodes
## 5  398225   398225    767500   Species      Adagnesia charcoti
## 6  398227   398227    767500   Species        Adagnesia rimosa
## 7  398647   398647    398644   Species        Aetideus armatus
## 8  400887   400887    400884   Species          Amperima rosea
## 9  401559   401559    738082   Species   Amphissa acutecostata
## 10 402079   402079    768595   Species      Amuletta abyssorum
## # ... with 920 more rows, and 13 more variables: tauthor &lt;chr&gt;,
## #   worms_id &lt;int&gt;, records &lt;int&gt;, datasets &lt;int&gt;, phylum &lt;chr&gt;,
## #   order &lt;chr&gt;, family &lt;chr&gt;, genus &lt;chr&gt;, species &lt;chr&gt;, class &lt;chr&gt;,
## #   redlist &lt;lgl&gt;, status &lt;chr&gt;, hab &lt;lgl&gt;
</code></pre>
       </div> 
       <p><br></p> 
       <hr> 
       <h1 id="next-steps">Next steps</h1> 
       <p>The above describes some of the kinds of procedures that we use regularly in our group. Next steps could include further enrichment of occurrence data. For instance, there is a major initiative within WoRMS to link biological trait data to the existing taxonomy (see <a href="http://www.marinespecies.org/traits/">http://www.marinespecies.org/traits/</a>) and we are thinking about how to filter OBIS queries by particular kinds of traits, or mapping the distribution of traits. We are also investigating how to mine the temporal dimension of OBIS data to <a href="http://www.iobis.org/2016/11/15/occmod/">derive robust estimates of trends in marine biodiversity</a>. Keep an eye out for these developments on the <a href="http://www.iobis.org/news/">OBIS news site</a>, and please do get in touch with requests or suggestions for improvements!</p> 
       <hr> 
      </div> 
     </div> 
    </div> 
   </section> 
   <!-- The tags --> 
   <div class="container"> 
    <div class="col-sm-8 col-sm-offset-2"> 
     <a href="/tags/R" class="badge badge-success" rel="tooltip" data-placement="right" title="View posts tagged with &quot;R&quot;"><span class="blog_tag">R</span></a> 
     <a href="/tags/community" class="badge badge-success" rel="tooltip" data-placement="right" title="View posts tagged with &quot;community&quot;"><span class="blog_tag">community</span></a> 
     <a href="/tags/biodiversity" class="badge badge-success" rel="tooltip" data-placement="right" title="View posts tagged with &quot;biodiversity&quot;"><span class="blog_tag">biodiversity</span></a> 
     <a href="/tags/taxize" class="badge badge-success" rel="tooltip" data-placement="right" title="View posts tagged with &quot;taxize&quot;"><span class="blog_tag">taxize</span></a> 
     <a href="/tags/spenv" class="badge badge-success" rel="tooltip" data-placement="right" title="View posts tagged with &quot;spenv&quot;"><span class="blog_tag">spenv</span></a> 
     <a href="/tags/worrms" class="badge badge-success" rel="tooltip" data-placement="right" title="View posts tagged with &quot;worrms&quot;"><span class="blog_tag">worrms</span></a> 
    </div> 
    <div id="disqus"> 
     <!-- Disqus Comments --> 
     <div class="row"> 
      <div class="col-sm-9 col-sm-offset-2"> 
       <div id="disqus_thread"></div> 
       <div id="disqus_thread"></div> 
       <script type="text/javascript">
            var disqus_shortname = 'ropenscience';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
            </script> 
       <noscript>
        Please enable JavaScript to view the 
        <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
       </noscript> 
       <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> 
      </div> 
     </div> 
    </div> 
   </div> 
   <!-- End tags --> 
   <footer class="footer-6"> 
    <div class="container"> 
     <div class="row"> 
      <div class="col-sm-3"> 
       <div>
        <a class="brand" href="/">rOpenSci</a>
       </div> 
      </div> 
      <nav> 
       <div class="col-sm-2"> 
        <h6>About</h6> 
        <ul> 
         <li><a href="/about/">About Us</a></li> 
         <li><a href="/about/#leadership">Leadership team</a></li> 
         <li><a href="/about/#advisors">Advisory board</a></li> 
         <li><a href="/community/#community">rOpenSci Community</a></li> 
         <li><a href="/careers">Careers</a></li> 
         <li><a href="/donate">Donate</a></li> 
        </ul> 
       </div> 
       <div class="col-sm-2"> 
        <h6>Work</h6> 
        <ul> 
         <li><a href="/packages/">R Packages</a></li> 
         <li><a href="/blog/">Blog</a></li> 
         <li><a href="/tech-notes/">Tech notes</a></li> 
         <li><a href="/tutorials/">Tutorials</a></li> 
         <li><a href="/usecases/">Use cases</a></li> 
         <li><a href="/resources.html">Resources</a></li> 
        </ul> 
       </div> 
       <div class="col-sm-2"> 
        <h6>Other</h6> 
        <ul> 
         <li><a href="/contact.html">Contact</a></li> 
         <li><a href="http://discuss.ropensci.org/">rOpensci Discuss</a></li> 
         <li><a href="/community/events.html">Events</a></li> 
         <li><a href="/related_links.html">Related links</a></li> 
         <li><a href="https://github.com/ropensci">GitHub Org</a></li> 
        </ul> 
       </div> 
      </nav> 
      <div class="col-sm-3"> 
       <h6 id="subscribe">Subscribe</h6> 
       <!-- start form --> 
       <form action="//ropensci.us7.list-manage.com/subscribe/post?u=c5de56320aeac3ee7cc954ec2&amp;id=d78520d99e" method="post" class="validate" target="_blank"> 
        <!--                 <form action="https://us7.api.mailchimp.com/2.0/lists/subscribe?id=16033&amp;apikey=4e975338e462c738c15b87559f9df4e5-us7" method="post" class="validate" target="_blank"> --> 
        <div class="input-group"> 
         <input type="email" value="" name="EMAIL" id="mce-EMAIL" placeholder="Email Address" autocapitalize="off" autocorrect="off" class="form-control" required> 
         <span class="input-group-btn"> <button class="btn" type="image" value="go"> <span class="fui-arrow-right"> </span> </button> </span> 
        </div> 
       </form> 
       <!-- end form --> 
       <div class="social-btns"> 
        <a href="http://twitter.com/ropensci"> 
         <div class="fui-twitter"></div> 
         <div class="fui-twitter"></div> </a> 
        <a href="https://vimeo.com/ropensci"> 
         <div class="fui-vimeo"></div> 
         <div class="fui-vimeo"></div> </a> 
       </div> 
       <div> 
        <a href="http://www.numfocus.org/"><img src="/assets/common-files/img/2e5a403b-6ce3-4f08-955f-5706b4a63d5b.png"></a> 
       </div> 
      </div> 
     </div> 
     <div class="row">
      <p> <a href="http://ropensci.org/feed.xml"><i class="ss-icon">?</i></a> &nbsp;Except where otherwise noted, content on this site is licensed under the CC-BY license.</p>
     </div> 
    </div> 
   </footer> 
   <!-- Here ends the footer --> 
   <script src="/assets/common-files/js/jquery-1.10.2.min.js"></script> 
   <script src="/assets/common-files/js/jquery.bxslider.min.js"></script> 
   <script src="/assets/common-files/js/jquery.scrollTo-1.4.3.1-min.js"></script> 
   <script src="/assets/flat-ui/js/bootstrap.min.js"></script> 
   <script src="/assets/common-files/js/masonry.pkgd.min.js"></script> 
   <script src="/assets/common-files/js/modernizr.custom.js"></script> 
   <script src="/assets/common-files/js/page-transitions.js"></script> 
   <script src="/assets/common-files/js/easing.min.js"></script> 
   <script src="/assets/common-files/js/jquery.svg.js"></script> 
   <script src="/assets/common-files/js/jquery.svganim.js"></script> 
   <script src="/assets/common-files/js/jquery.backgroundvideo.min.js"></script> 
   <script src="/assets/common-files/js/froogaloop.min.js"></script> 
   <script src="/assets/common-files/js/startup-kit.js"></script> 
   <script type="text/javascript">
                $(function () {
                    $("[rel='tooltip']").tooltip();
                });
            </script> 
   <!-- Equations using MathJax --> 
   <!-- Gauges Analytics --> 
   <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '500ebcf4613f5d79c700001c');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script> 
   <!-- Google Analytics and event tracker --> 
   <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-462421-6']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
</script> 
   <script type="text/javascript">
function recordOutboundLink(link, category, action) {
  try {
    var pageTracker=_gat._getTracker("UA-462421-6");
    pageTracker._trackEvent(category, action);
    setTimeout('document.location = "' + link.href + '"', 100)
  }catch(err){}
}
</script> 
  </div>   
 </body>
</html>