<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
 <!--<![endif]-->
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
  <!-- Use title if it's in the page YAML frontmatter --> 
  <title>The Path to Rust on the Web</title> 
  <meta name="description" content=""> 
  <meta name="viewport" content="width=device-width"> 
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0, minimal-ui"> 
  <!-- Place favicon.ico and apple-touch-icon.png in the root directory --> 
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]--> 
  <meta property="og:title" content="The Path to Rust on the Web"> 
  <meta property="og:type" content="article"> 
  <meta property="og:locale" content="en_US"> 
  <meta property="og:url" content="/blog/2017-04-10/the-path-to-rust-on-the-web/"> 
  <meta property="og:image:url" content="http://asquera.de/img/asquera.png"> 
  <meta property="og:image:type" content="image/png"> 
  <meta property="og:image:width" content="65"> 
  <meta property="og:image:height" content="65"> 
  <meta name="twitter:site" content="@Asquera"> 
  <meta name="twitter:creator" content="@Asquera"> 
  <meta name="twitter:title" content="The Path to Rust on the Web"> 
  <meta name="twitter:card" content="summary"> 
  <meta name="twitter:description" content="The Path to Rust on the Web"> 
  <meta name="twitter:image" content="http://asquera.de/img/asquera.png"> 
  <link href="/css/blog.css" rel="stylesheet"> 
  <link rel="canonical" href="/blog/2017-04-10/the-path-to-rust-on-the-web/"> 
 </head> 
 <body> 
  <!--[if lt IE 7]>
  <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
  <![endif]--> 
  <header> 
   <div id="navigation"> 
    <div class="container"> 
     <div class="row"> 
      <div class="col-sm-3"> 
       <a href="/"> <img src="/img/asq_grey.png" id="logo" class="img-responsive" alt="Asquera GmbH"> </a> 
      </div> 
      <div class="col-xs-12 col-sm-5"> 
       <nav> 
        <ul class="list-inline"> 
         <li class="are hide-text"> <a href="/about"> <h3>who <br> <small>we are</small></h3> </a> </li> 
         <li class="do hide-text"> <a href="/#what_we_do"> <h3>what <br> <small>we do</small></h3> </a> </li> 
         <li class="write hide-text"> <a href="/blog"> <h3>what <br> <small>we write</small></h3></a>  </li> 
         <li class="write hide-text hidden"> <a href="/blog"> <h3>wow <br> <small>a surprise</small></h3> </a> </li> 
        </ul> 
       </nav> 
      </div> 
      <div class="col-xs-12 col-sm-4"> 
       <p id="phonenumber" class="col-xs-12 col-sm-12"><small>call us +</small>49 172 546 04 09</p> 
       <p id="contact-email" class="col-xs-12 col-sm-12"><a href="mailto:info@asquera.de">info@asquera.de</a></p> 
      </div> 
     </div> 
    </div> 
   </div> 
   <hr> 
   <div id="social_links_layer"> 
    <div class="container"> 
     <div class="row"> 
      <div class="social_link"> 
       <a href="https://twitter.com/asquera"><img src="/img/twitter.png"></a> 
       <a href="https://github.com/Asquera"><img src="/img/github.png"></a> 
       <a href="mailto:info@asquera.de">contact</a> 
       <a href="/imprint">imprint</a> 
      </div> 
     </div> 
    </div> 
   </div> 
  </header> 
  <div id="what_we_blog"> 
   <h1 class="title text-center"><span>what we blog</span></h1>  
  </div> 
  <div class="container"> 
   <div class="row"> 
    <div class="category-list"> 
     <ul class="list-inline"> 
      <li> <img src="/img/tag.png"> <a href="/blog/categories/announcements/"> announcements </a> </li> 
      <li> <img src="/img/tag.png"> <a href="/blog/categories/development/"> development </a> </li> 
      <li> <img src="/img/tag.png"> <a href="/blog/categories/opensource/"> opensource </a> </li> 
      <li> <img src="/img/tag.png"> <a href="/blog/categories/opinions/"> opinions </a> </li> 
      <li> <img src="/img/tag.png"> <a href="/blog/categories/beginners_track/"> beginners_track </a> </li> 
      <li> <img src="/img/tag.png"> <a href="/blog/categories/tricks/"> tricks </a> </li> 
     </ul> 
    </div> 
   </div> 
   <div class="row"> 
    <div class="spacer"> 
    </div> 
   </div> 
   <div class="row"> 
    <div class="blogpost"> 
     <div class="metadata"> 
      <div class="row"> 
       <div class="triangle"></div> 
       <div class="desktop avatar"> 
        <a href="/about#andrew"> <img src="/img/asquera.png" class="img-circle"> </a> 
       </div> 
       <div class="mobile avatar"> 
        <img src="/img/asquera.png" class="img-circle"> 
       </div> 
       <div class="date-text"> 
        <p> 10.04.2017 </p> 
       </div> 
       <div class="desktop author"> 
        <a href="/about#andrew">andrew</a> 
       </div> 
       <div class="date-circle"> 
        <div class="circle"> 
         <div class="day-month">
          10
         </div> 
         <hr> 
         <div class="day-month">
          04
         </div> 
         <div class="year">
          2017
         </div> 
        </div> 
       </div> 
       <div class="clearfix visible-xs visible-sm"></div> 
       <div class="mobile author"> 
        <p class="visible-xs">andrew</p> 
        <div class="visible-sm"> 
         <a href="/about#andrew">andrew</a> 
        </div> 
       </div> 
       <div class="navigate-back desktop"> 
        <div class="square"> 
         <a class="btn btn-default btn-block" href="/blog"> <i class="glyphicon glyphicon-chevron-left"></i> </a> 
        </div> 
       </div> 
       <div class="categories"> 
        <ul class="list-unstyled"> 
         <li> <img src="/img/tag.png"> development </li> 
        </ul> 
       </div> 
      </div> 
     </div> 
     <div class="post"> 
      <article> 
       <h1> <a href="/blog/2017-04-10/the-path-to-rust-on-the-web/">The Path to Rust on the Web</a> </h1> 
       <div class="body"> 
        <p>Recently there has been quite a bit of talk about <em>WebAssembly</em>, a new format for code for the web. It is a compile target for languages like C and Rust that enables us to write, and run, code from these languages in our browser.</p> 
        <p>In the interest of learning more about this technology (and to avoid writing more Javascript) let's explore together and get our hands dirty!</p> 
        <blockquote> 
         <p><strong>Disclaimer:</strong> WebAssembly is stabilized, but most implementations are not. The information contained here may become out of date or be incorrect, despite working at the time of writing.</p> 
        </blockquote> 
        <p>Before we start please make sure you're using the current (or developer) version of Firefox or Chrome. You can check out <code>about:config</code> or <code>chrome://flags/</code> and make sure <code>wasm</code> related things are enabled.</p> 
        <h2 id="what-are-we-looking-at">What Are We Looking At?</h2> 
        <p><a href="http://webassembly.org/"><em>WebAssembly</em></a> (or <em>wasm</em>) describes an <em>execution environment</em> which browsers can implement within their Javascript Virtual Machines. It's a way to run code in place of, or alongside, Javascript.</p> 
        <p>WebAssembly can be thought of as similar to <a href="http://asmjs.org/"><em>asm.js</em></a>. Indeed, we can use <a href="http://emscripten.org/"><em>Emscripten</em></a> compiler to target both.</p> 
        <p>Most existing documentation discusses how to build C, C++, or Rust into wasm, but there is nothing excluding languages like <a href="http://ruby.dj/">Ruby</a> or Python from working as well.</p> 
        <h2 id="installing-the-tools">Installing The Tools</h2> 
        <p>We'll need two things to get started with WebAssembly and Rust, assuming you already have a functional development environment otherwise (That is, you have <code>build-essential</code>, XCode, or the like installed.)</p> 
        <p>First, Rust. You can review <a href="https://hoverbear.org/2017/03/03/setting-up-a-rust-devenv/#setting-up-rust-via-rustup">here</a> for a more long winded explanation of how to do this, or you can just run the following and accept the defaults:</p> 
        <pre class="highlight shell"><code>curl https://sh.rustup.rs -sSf | sh
</code></pre> 
        <p>Open a new terminal or run <code>source $HOME/.cargo/env</code>, then we'll add the <code>wasm32-unknown-emscripten</code> compile target via <code>rustup</code> as well:</p> 
        <pre class="highlight shell"><code>rustup target add wasm32-unknown-emscripten
</code></pre> 
        <p>We can use this command to install other targets, found via <code>rustup target list</code>, as well.</p> 
        <p>Next we need to set up Emscripten via <a href="http://kripken.github.io/emscripten-site/docs/getting_started/downloads.html"><code>emsdk</code></a>. We'll use the <em>incoming</em> version of Emscripten in order to get the best output. Note: This may take awhile (an hour!).</p> 
        <pre class="highlight shell"><code>curl https://s3.amazonaws.com/mozilla-games/emscripten/releases/emsdk-portable.tar.gz | tar -xv -C ~/
<span class="nb">cd</span> ~/emsdk-portable
./emsdk update
./emsdk install sdk-incoming-64bit
./emsdk activate sdk-incoming-64bit
</code></pre> 
        <p>At this point Emscripten is installed. The last command will instruct us how to add the binaries to our path for permanent usage, or we can just <code>source ./emsdk_env.sh</code> for temporary fun.</p> 
        <p>At this point <code>emcc -v</code> should report something similar to this:</p> 
        <pre class="highlight shell"><code><span class="gp">$ </span>emcc -v
INFO:root:<span class="o">(</span>Emscripten: Running sanity checks<span class="o">)</span>
emcc <span class="o">(</span>Emscripten gcc/clang-like replacement + linker emulating GNU ld<span class="o">)</span> 1.37.9
clang version 4.0.0 <span class="o">(</span>https://github.com/kripken/emscripten-fastcomp-clang/ d4b1e0785f1ee15ab78207de4380e82e3407c6ea<span class="o">)</span> <span class="o">(</span>https://github.com/kripken/emscripten-fastcomp/ 09aaa022c31e247bfb7b00882372733e6b27f007<span class="o">)</span> <span class="o">(</span>emscripten 1.37.9 : 1.37.9<span class="o">)</span>
Target: x86_64-apple-darwin16.4.0
Thread model: posix
InstalledDir: /Users/hoverbear/emsdk-portable/clang/fastcomp/build_incoming_64/bin
INFO:root:<span class="o">(</span>Emscripten: Running sanity checks<span class="o">)</span>
</code></pre> 
        <p>Now, let's kick the tires a bit!</p> 
        <h2 id="first-experiment-standalone-executable">First Experiment: Standalone Executable</h2> 
        <p>In our first experiment we'll compile some Rust code into wasm and have it run in the browser console. We'll try a basic code sample to ensure things are working as we expect. We won't try to do any crate importing, DOM manipulation, or network access yet, but that's coming later!</p> 
        <p>Let's create our project, we'll use this same project for our future experiments as well. We need to set this to nightly (at least at the time or writing) to have our demos work.</p> 
        <pre class="highlight shell"><code>cargo init wasm-demo --bin
rustup override <span class="nb">set </span>nightly
</code></pre> 
        <p>Then we'll put our first code sample into <code>src/main.rs</code>:</p> 
        <pre class="highlight rust"><code><span class="err">#</span><span class="p">[</span><span class="nf">derive</span><span class="p">(</span><span class="n">Debug</span><span class="p">)]</span>
<span class="k">enum</span> <span class="n">Direction</span> <span class="p">{</span> <span class="n">North</span><span class="p">,</span> <span class="n">South</span><span class="p">,</span> <span class="n">East</span><span class="p">,</span> <span class="n">West</span> <span class="p">}</span>

<span class="k">fn</span> <span class="nf">is_north</span><span class="p">(</span><span class="n">dir</span><span class="p">:</span> <span class="n">Direction</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">bool</span> <span class="p">{</span>
    <span class="k">match</span> <span class="n">dir</span> <span class="p">{</span>
        <span class="nn">Direction</span><span class="p">::</span><span class="n">North</span> <span class="k">=&gt;</span> <span class="k">true</span><span class="p">,</span>
        <span class="n">_</span> <span class="k">=&gt;</span> <span class="k">false</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">points</span> <span class="o">=</span> <span class="nn">Direction</span><span class="p">::</span><span class="n">South</span><span class="p">;</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">points</span><span class="p">);</span>
    <span class="k">let</span> <span class="n">compass</span> <span class="o">=</span> <span class="nf">is_north</span><span class="p">(</span><span class="n">points</span><span class="p">);</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">compass</span><span class="p">);</span>
<span class="p">}</span>
</code></pre> 
        <p>Running this normally yields what we would expect:</p> 
        <pre class="highlight shell"><code><span class="gp">$ </span>cargo run
   Compiling wasm-demo v0.1.0 <span class="o">(</span>file:///Users/hoverbear/git/rust/wasm-demo<span class="o">)</span>
    Finished dev <span class="o">[</span>unoptimized + debuginfo] target<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>0.89 secs
     Running <span class="sb">`</span>target/debug/wasm-demo<span class="sb">`</span>
South
<span class="nb">false</span>
</code></pre> 
        <p>Now, let's get the same thing in our browser! We can build our executable for the wasm target by using the <code>--target</code> flag.</p> 
        <pre class="highlight shell"><code><span class="gp">$ </span>cargo build --target<span class="o">=</span>wasm32-unknown-emscripten --release
<span class="gp">$ </span>tree target
target
??? wasm32-unknown-emscripten
    ??? release
        ??? build
        ??? deps
        ?   ??? wasm_demo-9c23ae9a241f12fa.asm.js
        ?   ??? wasm_demo-9c23ae9a241f12fa.js
        ?   ??? wasm_demo-9c23ae9a241f12fa.wasm
        ??? examples
        ??? incremental
        ??? native
        ??? wasm-demo.d
        ??? wasm-demo.js
</code></pre> 
        <p><code>cargo</code> created several files in <code>target/wasm32-unknown-emscripten/release/deps/</code> for us. Of primary interest are the <code>.wasm</code> and <code>.js</code> files.</p> 
        <p>Why do we get both a <code>wasm</code> and a <code>js</code>? Wasn't the whole point of this to not use Javascript? Turns out we need some Javascript glue code to fetch, initialize, and configure it.</p> 
        <p>At this point we can't really <em>use</em> the created files, since we don't have a webpage to import them into! Let's work on that. We can create a <code>site/index.html</code> with the following content:</p> 
        <pre class="highlight html"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="c1">// This is read and used by `site.js`</span>
            <span class="kd">var</span> <span class="nx">Module</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">wasmBinaryFile</span><span class="p">:</span> <span class="s2">"site.wasm"</span>
            <span class="p">}</span>
        <span class="nt">&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"site.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre> 
        <p>Next we need to set up some way to get the generated files from the <code>target/</code> folder into the <code>site/</code> folder. <code>make</code> is a good solution for this, so let's make a <code>Makefile</code>. (Makefiles <strong>require</strong> tabs, not spaces!)</p> 
        <pre class="highlight make"><code><span class="nv">SHELL</span> <span class="o">:=</span> /bin/bash

<span class="nl">all</span><span class="o">:</span>
	cargo build --target<span class="o">=</span>wasm32-unknown-emscripten --release
	mkdir -p site
	find target/wasm32-unknown-emscripten/release/deps -type f -name <span class="s2">"*.wasm"</span> | xargs -I <span class="o">{}</span> cp <span class="o">{}</span> site/site.wasm
	find target/wasm32-unknown-emscripten/release/deps -type f ! -name <span class="s2">"*.asm.js"</span> -name <span class="s2">"*.js"</span> | xargs -I <span class="o">{}</span> cp <span class="o">{}</span> site/site.js
</code></pre> 
        <p>Finally, test it with <code>make</code>.</p> 
        <pre class="highlight shell"><code><span class="gp">$ </span>tree site
site
??? index.html
??? site.js
??? site.wasm
</code></pre> 
        <p>Let's test our generated code by running <code>python -m SimpleHTTPServer</code>, browsing to <a href="http://localhost:8000/site/"><code>http://localhost:8000/site/</code></a>, and opening the browser console.</p> 
        <p>In the browser console you should see:</p> 
        <pre class="highlight plaintext"><code>trying binaryen method: native-wasm
asynchronously preparing wasm
binaryen method succeeded.
The character encoding of the HTML document was not declared. The document will render with garbled text in some browser configurations if the document contains characters from outside the US-ASCII range. The character encoding of the page must be declared in the document or in the transfer protocol.
South
false
</code></pre> 
        <p>Excellent! It worked!</p> 
        <h2 id="second-experiment-imports">Second Experiment: Imports</h2> 
        <p>In our first example we just used a basic enum and some print statements, nothing too exciting. Let's do something more exciting and work with iterators.</p> 
        <pre class="highlight rust"><code><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">collections</span><span class="p">::</span><span class="n">HashMap</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Direction</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="cp">#[derive(Debug,</span> <span class="cp">PartialEq)]</span>
<span class="k">enum</span> <span class="n">Direction</span> <span class="p">{</span> <span class="n">North</span><span class="p">,</span> <span class="n">South</span><span class="p">,</span> <span class="n">East</span><span class="p">,</span> <span class="n">West</span> <span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">users_facing</span> <span class="o">=</span> <span class="nn">HashMap</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="n">users_facing</span><span class="nf">.insert</span><span class="p">(</span><span class="s">"Alice"</span><span class="p">,</span> <span class="n">North</span><span class="p">);</span>
    <span class="n">users_facing</span><span class="nf">.insert</span><span class="p">(</span><span class="s">"Bob"</span><span class="p">,</span> <span class="n">South</span><span class="p">);</span>
    <span class="n">users_facing</span><span class="nf">.insert</span><span class="p">(</span><span class="s">"Carol"</span><span class="p">,</span> <span class="n">East</span><span class="p">);</span>

    <span class="k">let</span> <span class="n">users_not_facing_north</span> <span class="o">=</span> <span class="n">users_facing</span><span class="nf">.iter</span><span class="p">()</span>
        <span class="nf">.filter</span><span class="p">(|</span><span class="o">&amp;</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">d</span><span class="p">)|</span> <span class="o">*</span><span class="n">d</span> <span class="o">!=</span> <span class="n">North</span><span class="p">)</span>
        <span class="py">.collect</span><span class="p">::</span><span class="o">&lt;</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">users_not_facing_north</span><span class="p">);</span>
<span class="p">}</span>

</code></pre> 
        <p>Building this code again with <code>make</code> we can navigate to the page again in our browser. This should output:</p> 
        <pre class="highlight rust"><code><span class="p">{</span><span class="s">"Carol"</span><span class="p">:</span> <span class="n">East</span><span class="p">,</span> <span class="s">"Bob"</span><span class="p">:</span> <span class="n">South</span><span class="p">}</span>
</code></pre> 
        <p>Excellent! So importing things from <code>std</code> seems to work okay. How about other crates? Let's try using <code>itertools</code>. Add the following to the <code>Cargo.toml</code>:</p> 
        <pre class="highlight toml"><code><span class="nn">[dependencies]</span>
<span class="py">itertools</span> <span class="p">=</span> <span class="s">"*"</span>
</code></pre> 
        <p>Then we can go and try to use it.</p> 
        <pre class="highlight rust"><code><span class="k">extern</span> <span class="n">crate</span> <span class="n">itertools</span><span class="p">;</span>

<span class="k">use</span> <span class="nn">itertools</span><span class="p">::</span><span class="n">Itertools</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Direction</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>


<span class="cp">#[derive(Debug,</span> <span class="cp">PartialEq,</span> <span class="cp">Eq,</span> <span class="cp">Hash)]</span>
<span class="k">enum</span> <span class="n">Direction</span> <span class="p">{</span> <span class="n">North</span><span class="p">,</span> <span class="n">South</span><span class="p">,</span> <span class="n">East</span><span class="p">,</span> <span class="n">West</span> <span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">directions</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="n">North</span><span class="p">,</span> <span class="n">North</span><span class="p">,</span> <span class="n">South</span><span class="p">,</span> <span class="n">East</span><span class="p">,</span> <span class="n">West</span><span class="p">,</span> <span class="n">West</span><span class="p">];</span>

    <span class="k">let</span> <span class="n">unique_directions</span> <span class="o">=</span> <span class="n">directions</span><span class="nf">.iter</span><span class="p">()</span>
        <span class="nf">.unique</span><span class="p">()</span>
        <span class="py">.collect</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">unique_directions</span><span class="p">);</span>
<span class="p">}</span>
</code></pre> 
        <p>Building and visiting the page again we see the following output:</p> 
        <pre class="highlight plaintext"><code>[North, South, East, West]
</code></pre> 
        <p>Okay that was simple! What about something a bit more complicated, like <code>serde</code>, which lets us serialize and deserialize various formats? This will be important for an application which needs to parse responses from APIs!</p> 
        <p>Changing the <code>Cargo.toml</code> and the <code>main.rs</code>:</p> 
        <pre class="highlight toml"><code><span class="nn">[dependencies]</span>
<span class="py">serde_json</span> <span class="p">=</span> <span class="s">"*"</span>
<span class="py">serde_derive</span> <span class="p">=</span> <span class="s">"*"</span>
<span class="py">serde</span> <span class="p">=</span> <span class="s">"*"</span>
</code></pre> 
        <pre class="highlight rust"><code><span class="k">extern</span> <span class="n">crate</span> <span class="n">serde_json</span><span class="p">;</span>
<span class="cp">#[macro_use]</span> <span class="k">extern</span> <span class="n">crate</span> <span class="n">serde_derive</span><span class="p">;</span>

<span class="cp">#[derive(Serialize,</span> <span class="cp">Deserialize,</span> <span class="cp">Debug)]</span>
<span class="k">enum</span> <span class="n">Direction</span> <span class="p">{</span> <span class="n">North</span><span class="p">,</span> <span class="n">South</span><span class="p">,</span> <span class="n">East</span><span class="p">,</span> <span class="n">West</span> <span class="p">}</span>

<span class="cp">#[derive(Serialize,</span> <span class="cp">Deserialize,</span> <span class="cp">Debug)]</span>
<span class="k">struct</span> <span class="n">Example</span> <span class="p">{</span>
    <span class="n">favorite_animal</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="n">favorite_direction</span><span class="p">:</span> <span class="n">Direction</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="err">#</span><span class="s">" { "</span><span class="n">favorite_animal</span><span class="s">": "</span><span class="n">Bear</span><span class="s">", "</span><span class="n">favorite_direction</span><span class="s">": "</span><span class="n">North</span><span class="s">" } "</span><span class="err">#</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">parsed</span><span class="p">:</span> <span class="n">Example</span> <span class="o">=</span> <span class="nn">serde_json</span><span class="p">::</span><span class="nf">from_str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">parsed</span><span class="p">);</span>
<span class="p">}</span>
</code></pre> 
        <p>Building, and viewing it in the browser console yields:</p> 
        <pre class="highlight rust"><code><span class="n">Example</span> <span class="p">{</span> <span class="n">favorite_animal</span><span class="p">:</span> <span class="s">"Bear"</span><span class="p">,</span> <span class="n">favorite_direction</span><span class="p">:</span> <span class="n">North</span> <span class="p">}</span>
</code></pre> 
        <p>Awesome!</p> 
        <h2 id="third-experiment-calling-from-javascript">Third Experiment: Calling From Javascript</h2> 
        <p>It's also possible to use generated wasm as a library and call the generated code from within Javascript. This has its own set of complications though.</p> 
        <p>WebAssembly only supports a limited number of <a href="https://github.com/WebAssembly/design/blob/master/Semantics.md#types">value types</a>:</p> 
        <ul> 
         <li><code>i32</code>: 32-bit integer</li> 
         <li><code>i64</code>: 64-bit integer</li> 
         <li><code>f32</code>: 32-bit floating point</li> 
         <li><code>f64</code>: 64-bit floating point</li> 
        </ul> 
        <p>Notice how this doesn't include strings or other more satisfying types. That's ok! We can still use a function called <code>Module.cwrap</code> to define the parameters and expected return values of the wasm exported functions.</p> 
        <p>Writing this interaction code means that on the Rust side of things we have to treat it as though we're interacting with C. This can make some things a bit complicated, on the bright side it means writing more FFI (foreign function interfaces) later will be much easier.</p> 
        <p>So, let's write a basic function which returns a String from Rust into Javascript.</p> 
        <pre class="highlight rust"><code><span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">os</span><span class="p">::</span><span class="nn">raw</span><span class="p">::</span><span class="nb">c_char</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">ffi</span><span class="p">::</span><span class="n">CString</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">collections</span><span class="p">::</span><span class="n">HashMap</span><span class="p">;</span>

<span class="cp">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">get_data</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">c_char</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">HashMap</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="n">data</span><span class="nf">.insert</span><span class="p">(</span><span class="s">"Alice"</span><span class="p">,</span> <span class="s">"send"</span><span class="p">);</span>
    <span class="n">data</span><span class="nf">.insert</span><span class="p">(</span><span class="s">"Bob"</span><span class="p">,</span> <span class="s">"recieve"</span><span class="p">);</span>
    <span class="n">data</span><span class="nf">.insert</span><span class="p">(</span><span class="s">"Carol"</span><span class="p">,</span> <span class="s">"intercept"</span><span class="p">);</span>
    
    <span class="k">let</span> <span class="n">descriptions</span> <span class="o">=</span> <span class="n">data</span><span class="nf">.iter</span><span class="p">()</span>
        <span class="nf">.map</span><span class="p">(|(</span><span class="n">p</span><span class="p">,</span><span class="n">a</span><span class="p">)|</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"{} likes to {} messages"</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
        <span class="py">.collect</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span>

    <span class="nn">CString</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">descriptions</span><span class="nf">.join</span><span class="p">(</span><span class="s">", "</span><span class="p">))</span>
        <span class="nf">.unwrap</span><span class="p">()</span>
        <span class="nf">.into_raw</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// Deliberately blank.</span>
<span class="p">}</span>
</code></pre> 
        <p>First thing you might notice is that we have a <code>main()</code> function which is blank. This is on purpose, we're going to define that in Javascript! We'll edit the <code>index.html</code> to write a bit of new code for this purpose.</p> 
        <pre class="highlight html"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="c1">// This is read and used by `site.js`</span>
            <span class="kd">var</span> <span class="nx">Module</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">wasmBinaryFile</span><span class="p">:</span> <span class="s2">"site.wasm"</span><span class="p">,</span>
                <span class="na">onRuntimeInitialized</span><span class="p">:</span> <span class="nx">main</span><span class="p">,</span>
            <span class="p">};</span>
            <span class="kd">function</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">get_data</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">cwrap</span><span class="p">(</span><span class="s1">'get_data'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">,</span> <span class="p">[]);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">get_data</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="nt">&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"site.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre> 
        <p>The final argument of <code>cwrap</code> is an array of argument types, which we don't use in this case.</p> 
        <p>It's also possible to call the function via <code>Module._get_data()</code> but you'll notice that it returns a pointer to a memory location, not a string.</p> 
        <h2 id="fourth-experiment-calling-javascript-from-rust">Fourth Experiment: Calling Javascript From Rust</h2> 
        <p>There isn't a tremendous amount of writing about this topic, the best resource I was able to find was in the <a href="https://kripken.github.io/emscripten-site/docs/porting/connecting_cpp_and_javascript/Interacting-with-code.html#implement-c-in-javascript">'Interacting with code'</a> section of the Emscripten documentation.</p> 
        <p>The basic concept is that when <code>emcc</code> goes and does its job it includes a <code>library.js</code> file which we can add functions to via the <code>--js-library</code> flag. These functions can return values, or do things like run <code>alert("Blah blah")</code>.</p> 
        <p>In order to do this we need to create a <code>site/utilities.js</code> file containing the following:</p> 
        <pre class="highlight javascript"><code><span class="s1">'use strict'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">library</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">get_data</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s2">"Hello from JS."</span><span class="p">;</span>
    <span class="nx">alert</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>

    <span class="c1">// Not needed for numerics.</span>
    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">lengthBytesUTF8</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">_malloc</span><span class="p">(</span><span class="nx">len</span><span class="p">);</span>
    <span class="nx">Module</span><span class="p">.</span><span class="nx">stringToUTF8</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">,</span> <span class="nx">len</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">buffer</span><span class="p">;</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="nx">mergeInto</span><span class="p">(</span><span class="nx">LibraryManager</span><span class="p">.</span><span class="nx">library</span><span class="p">,</span> <span class="nx">library</span><span class="p">);</span>
</code></pre> 
        <p>Then the HTML:</p> 
        <pre class="highlight html"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="c1">// This is read and used by `site.js`</span>
            <span class="kd">var</span> <span class="nx">Module</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">wasmBinaryFile</span><span class="p">:</span> <span class="s2">"site.wasm"</span><span class="p">,</span>
            <span class="p">};</span>
        <span class="nt">&lt;/script&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"site.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre> 
        <p>Lastly, the Rust code:</p> 
        <pre class="highlight rust"><code><span class="err">#</span><span class="o">!</span><span class="p">[</span><span class="nf">feature</span><span class="p">(</span><span class="n">link_args</span><span class="p">)]</span>

<span class="cp">#[cfg_attr(target_arch=</span><span class="s">"wasm32"</span><span class="cp">,</span> <span class="cp">link_args</span> <span class="cp">=</span> <span class="s">"</span><span class="err">\</span><span class="s"> --js-library site/utilities.js</span><span class="err">\</span><span class="s"> "</span><span class="cp">)]</span>
<span class="k">extern</span> <span class="p">{}</span>

<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">os</span><span class="p">::</span><span class="nn">raw</span><span class="p">::</span><span class="nb">c_char</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">ffi</span><span class="p">::</span><span class="n">CStr</span><span class="p">;</span>

<span class="k">extern</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">get_data</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">*</span><span class="k">mut</span> <span class="nb">c_char</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">get_data_safe</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span>
        <span class="nn">CStr</span><span class="p">::</span><span class="nf">from_ptr</span><span class="p">(</span><span class="nf">get_data</span><span class="p">())</span>
    <span class="p">};</span>
    <span class="n">data</span><span class="nf">.to_string_lossy</span><span class="p">()</span>
        <span class="nf">.into_owned</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nf">get_data_safe</span><span class="p">();</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre> 
        <p>If we build this and load the page we'll get an alert, and see <code>"Hello from JS"</code> printed out on the console.</p> 
        <p>The good thing is it works. The bad thing is that it is rather complex to do. Hopefully it will get better in the future.</p> 
        <blockquote> 
         <p>I'm not entirely happy with this situation, if you have any ideas how we can do this better please let me know!</p> 
        </blockquote> 
        <h2 id="fifth-experiment-using-the-web-platform">Fifth Experiment: Using The Web Platform</h2> 
        <p>As we've discovered by now, the barrier between our compiled code and Javascript is a bit annoying. It'd be quite handy if we could just write everything in Rust and avoid dealing with Javascript except where absolutely needed.</p> 
        <p>Luckly for us, there is a crate called <a href="https://github.com/tcr/rust-webplatform/"><code>rust-webplatform</code></a> that was started. It allows for convienent DOM manipulation and provides some helpers for doing Javascript. It's still a bit rough around the edges, but the foundations are there.</p> 
        <p>To get started, let's add <code>webplatform = "*"</code> to our dependencies. Then we can use some slightly modified sample code from the repo:</p> 
        <pre class="highlight rust"><code><span class="k">extern</span> <span class="n">crate</span> <span class="n">webplatform</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">document</span> <span class="o">=</span> <span class="nn">webplatform</span><span class="p">::</span><span class="nf">init</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">body</span> <span class="o">=</span> <span class="n">document</span><span class="nf">.element_query</span><span class="p">(</span><span class="s">"body"</span><span class="p">)</span>
        <span class="nf">.unwrap</span><span class="p">();</span>
    <span class="n">body</span><span class="nf">.html_append</span><span class="p">(</span><span class="s">"</span><span class="err">\</span><span class="s"> &lt;h1&gt;This header brought to you by Rust&lt;/h1&gt;</span><span class="err">\</span><span class="s"> &lt;button&gt;Click me!&lt;/button&gt;</span><span class="err">\</span><span class="s"> "</span><span class="p">);</span>
    
    <span class="k">let</span> <span class="n">button</span> <span class="o">=</span> <span class="n">document</span><span class="nf">.element_query</span><span class="p">(</span><span class="s">"button"</span><span class="p">)</span>
        <span class="nf">.unwrap</span><span class="p">();</span>
    <span class="n">button</span><span class="nf">.on</span><span class="p">(</span><span class="s">"mouseenter"</span><span class="p">,</span> <span class="k">move</span> <span class="p">|</span><span class="n">_</span><span class="p">|</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Mouse entered!"</span><span class="p">);</span>
        <span class="n">body</span><span class="nf">.html_append</span><span class="p">(</span><span class="s">"&lt;p&gt;Mouse entered!&lt;/p&gt;"</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="n">button</span><span class="nf">.on</span><span class="p">(</span><span class="s">"click"</span><span class="p">,</span> <span class="p">|</span><span class="n">_</span><span class="p">|</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Clicked!"</span><span class="p">);</span>
        <span class="nn">webplatform</span><span class="p">::</span><span class="nf">alert</span><span class="p">(</span><span class="s">"Clicked!"</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nn">webplatform</span><span class="p">::</span><span class="nf">spin</span><span class="p">();</span>
<span class="p">}</span>
</code></pre> 
        <p>Building our project you should see:</p> 
        <ul> 
         <li>DOM elements created when the wasm is loaded.</li> 
         <li>DOM elements being created when your mouse goes over the button.</li> 
         <li>An alert when you click on the button.</li> 
        </ul> 
        <p>Due to the youth of the library there isn't much in the way of examples or documentation, so be prepared to fumble around in the dark. For example, I discovered the key to getting some events and <code>println!()</code> working was to use <code>webplatform::spin()</code>.</p> 
        <blockquote> 
         <p>If you're looking for something to contribute, this crate would likely be an excellent place to do so! There's a bunch of work to be done and you could really make a difference for the blossoming Rust wasm community!</p> 
        </blockquote> 
        <h2 id="outlook">Outlook</h2> 
        <p>The future of Rust on the web is quite bright! Much of the foundations already exist, as we've seen in this article, and the Rust community is actively interested in improving the experience. The Rust repository even has an <a href="https://github.com/rust-lang/rust/issues?utf8=%E2%9C%93&amp;q=label%3AA-wasm%20"><code>A-wasm</code></a> tag for issues!</p> 
        <p>There are currently discussions about moving from <code>emcc</code> to the nascent LLVM wasm backend which you can track <a href="https://github.com/rust-lang/rust/issues/38804">here</a>. This may make significant parts of this article obselete, which is very exciting!</p> 
        <p>The ecosystem around wasm in Rust is still young, and now is a great time to get involved and help shape the future!</p> 
        <blockquote> 
         <p>Special thanks to <a href="https://fnordig.de/">Jan-Erik (Badboy)</a> for his workshop at Rust Belt Rust 2016, his hard work on this ecosystem, his advice while writing this post, for reviewing this before publishing, and most of all for being my valued friend. May we continue to hack in the same circles.</p> 
        </blockquote> 
        <blockquote> 
         <p>This post is an extension of the wasm chapter in our <a href="https://github.com/skade/rust-three-days-course/">Three Days of Rust</a> course. If you'd like to hire us for training, consulting, or developing in Rust (or anything else) please get in touch with me at <a href="mailto:andrew.hobden@asquera.de">andrew.hobden@asquera.de</a>.</p> 
        </blockquote> 
        <div class="navigate-to-top"> 
         <a href="#">Navigate to top</a> 
        </div> 
       </div> 
      </article> 
     </div> 
    </div> 
   </div> 
   <script src="/js/main.js"></script> 
   <script src="/js/plugins.js"></script> 
  </div> 
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '50b24ed4613f5d4201000093');
      t.src = '//secure.gaug.es/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>   
 </body>
</html>