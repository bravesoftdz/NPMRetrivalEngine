<!doctype html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="no-js" lang="en">
 <!--<![endif]-->
 <head> 
  <meta charset="utf-8"> 
  <title>Grisha Trubetskoy</title> 
  <meta name="author" content="Gregory Trubetskoy"> 
  <meta name="description" content="How much does it cost in electricity to mine a Bitcoin? As of Sep 28, 2017, according to blockchain.info the hashrate is:
9,214,860,125 GH/s. These …"> 
  <!-- http://t.co/dKP3o1e --> 
  <meta name="HandheldFriendly" content="True"> 
  <meta name="MobileOptimized" content="320"> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <link rel="canonical" href="http://grisha.org"> 
  <link href="/favicon.png" rel="icon"> 
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css"> 
  <link href="/atom.xml" rel="alternate" title="Grisha Trubetskoy" type="application/atom+xml"> 
  <script src="/javascripts/modernizr-2.0.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script> 
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script> 
  <script src="/javascripts/octopress.js" type="text/javascript"></script> 
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts --> 
  <link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> 
  <link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"> 
  <!-- MathJax --> 
  <!-- mathjax config similar to math.stackexchange --> 
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
  });
</script> 
  <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script> --> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script> 
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42971867-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script> 
 </head> 
 <body> 
  <header role="banner">
   <hgroup> 
    <h1><a href="/">Grisha Trubetskoy</a></h1> 
    <h2>Notes to self.</h2> 
   </hgroup> 
  </header> 
  <nav role="navigation">
   <ul class="subscription" data-subscription="rss"> 
    <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li> 
   </ul> 
   <form action="https://google.com/search" method="get"> 
    <fieldset role="search"> 
     <input type="hidden" name="q" value="site:grisha.org"> 
     <input class="search" type="text" name="q" results="0" placeholder="Search"> 
    </fieldset> 
   </form> 
   <ul class="main-navigation"> 
    <li><a href="/">Blog</a></li> 
    <li><a href="/blog/archives">Archives</a></li> 
   </ul> 
  </nav> 
  <div id="main"> 
   <div id="content"> 
    <div class="blog-index"> 
     <article> 
      <header> 
       <h1 class="entry-title"><a href="/blog/2017/09/28/electricity-cost-of-1-bitcoin/">Electricity Cost of 1 Bitcoin (Sep 2017)</a></h1> 
       <p class="meta"> <time datetime="2017-09-28T16:38:00-04:00" pubdate data-updated="true">Sep 28<span>th</span>, 2017</time> | <a href="/blog/2017/09/28/electricity-cost-of-1-bitcoin/#disqus_thread">Comments</a> </p> 
      </header> 
      <div class="entry-content">
       <p>How much does it cost in electricity to mine a Bitcoin?</p> 
       <p>As of Sep 28, 2017, according to blockchain.info the hashrate is: 9,214,860,125 GH/s.</p> 
       <p>These days it seems that the best miner available for sale is the AntMiner S9. It is actually over a year old, and there are faster and more energy efficient ASICs now, e.g. BitFury, but it is very hard to get any information on those, so we will just use the S9 information.</p> 
       <p>The S9 is capable of 12,930 GH/s. The collective Bitcoin hash rate is equivalent to 712,672 S9 miners running in parallel.</p> 
       <p>An S9 uses 1375W, which means that in 1 hour it consumes 1.375 kW/h.</p> 
       <p>In USA, a kWh costs $0.12 on average. (It can be as low as 0.04, according to this <a href="https://www.eia.gov/electricity/monthly/epm_table_grapher.php?t=epmt_5_6_a">EIA chart</a>.)</p> 
       <p>At 12c per kWh a running S9 costs $0.165 per hour.</p> 
       <p>712,672 running S9’s would cost $117,591.02 per hour.</p> 
       <p>Bitcoin blocks are solved at 6 per hour on average. Thus, each block costs $19,598.50 to solve.</p> 
       <p>The current mining reward is 12.5 BTC, which gives us the answer:</p> 
       <p>At \$0.12 kW/h a Bitcoin costs \$1,567.88 to mine.</p> 
       <p>At \$0.04 kW/h a Bitcoin costs \$522.62 to mine.</p> 
       <p>This, of course, does not include hardware and other costs.</p> 
       <p>It’s quite likely that the largest mining operations pay even less than $0.04 for electricity and the hardware they use is many times more efficient.</p> 
       <p>While grosly inaccurate, this shows that mining is quite profitable, and that Bitcoin price would have to fall a lot for mining to stop being profitable.</p> 
       <h3 id="looking-at-the-trend">Looking at the Trend</h3> 
       <p>Current difficulty is 1103400932964, The difficulty before that was 922724699725.</p> 
       <p>Difficulty adjusts every 2,016 blocks, which is about two weeks.</p> 
       <p>The Difficulty number is a coefficient of the “difficulty 1 target”, i.e. where the hash has to begin with 4 zero bytes (32 zero bits). It means is that it is N times harder than “1 target”.</p> 
       <p>We can see that at the last adjustment it went up by 180,676,233,239, or 16%, which is quite a bit in just two weeks. The last adjustment before that was from 888171856257, or 4%.</p> 
       <p>Assuming that the only miner in the world was the S9, the difficulty adjustment can only be explained by more S9’s coming online. The number of S9’s online is directly proportional to the hashrate, which is directly proportional to the difficulty. Thus there is a direct relationship between energy cost and the difficulty.</p> 
       <p>When the difficulty was 922724699725 (Sep 6 through 16), the hash rate was at about 8,000,000 TH/s, or equivalent of 618,716 S9’s. At that difficulty and the 12c kW/h price, a BTC cost $1,361 to mine.</p> 
       <p>Now let’s look back at the world before the S9, which uses the Bitmain BM1387 16nm ASIC. Before the S9, there was S7, based on BitMain BM1385 28nm ASIC. The S7 power consumption is roughly same as S9, or let’s assume it is for simplicity, but it is only capable of 4,000 GH/s.</p> 
       <p>Back at the end of 2015 when S7 was announced, the hashrate was at around 700,000,000 GH/s, or equivalent to 175,000 S7’s. That cost \$28,875 per hour, or \$4,812.5 per block. The block reward was 25 Bitcoins then, so a Bitcoin would cost only \$192 to mine. (With a 12.5 reward it would have been \$385).</p> 
       <p>This is all very confusing, but we can see that faster hardware and more of it drives the cost of mining up and the rlationship between the difficulty and the cost of mining a Bitcoin is linear. Faster hardware enables higher hash rate at improved energy efficiency, and the difficulty adjusts to keep the rate of blocks and supply of new BTC at 10 minutes.</p> 
       <p>The cost factor behind Bitcoin is energy, and spending more energy on mining makes a Bitcoin more expensive and less profitable. However, a more energy-expensive Bitcoin is a more sound/secure Bitcoin from the cryptographic perspective, which means it is likely to go up in USD price, and thus should still be profitable for the miners. This is a very interesting factor here, because if the BTC/USD price wasn’t going up, the miners would be bitter enemies and would do everything possible to prevent more miners from coming online. The rise of the BTC/USD price is what justifies as positive more miners coming online. So far we have not seen any news reports of mining facilities being sabotaged, which probably means miners are not enemies.</p> 
       <p>I will need to think on this some more as there are a lot of moving parts. But if I can make a cursory conclusion here, it is that (industrial) mining is and will remain very profitable for some time.</p> 
      </div> 
     </article> 
     <article> 
      <header> 
       <h1 class="entry-title"><a href="/blog/2017/09/25/bitcoin-value-2/">Bitcoin: USD Value</a></h1> 
       <p class="meta"> <time datetime="2017-09-25T08:50:00-04:00" pubdate data-updated="true">Sep 25<span>th</span>, 2017</time> | <a href="/blog/2017/09/25/bitcoin-value-2/#disqus_thread">Comments</a> </p> 
      </header> 
      <div class="entry-content">
       <p>In <a href="/blog/2017/09/22/bitcoin-value/">part 1</a> I explained how money has always been a global ledger and Bitcoin is just a different implementation of one. The million dollar question remains, what should Bitcoin be worth in a currency we’re more familiar with, such as USD?</p> 
       <h3 id="asset-pricing">Asset Pricing</h3> 
       <p>To illustrate the dilemma we’re faced with, lets look at three types of assets and how we price them.</p> 
       <p><em>Stocks:</em> price is determined by the present and future profits, which is relatively straight forward.</p> 
       <p><em>Commodities</em> (e.g oil): price is a function of supply (oil being produced) and demand (oil burned in engines or whatever).</p> 
       <p><em>Store of value:</em> this is anything that is bought because it keeps its value. Most commonly it is precious metals like gold, but it can also be fiat currency or valuable works of art. This category is most fitting for Bitcoin. Pricing of a store of value is strangely arbitrary, I attempt to explain it below.</p> 
       <h3 id="speculative-demand">Speculative Demand</h3> 
       <p>There are two kinds of demand. <em>Actual</em> demand is based in our everyday needs. For example we rely on combustible engines which consume oil. Engines burn oil (or its byproducts) converting it to exhaust gases, at which point it is no more. The more we drive, the more oil we burn, the higher the demand.</p> 
       <p>The second kind of demand is <em>speculative</em>. It is based on the expectation of a future price change. Speculators buy assets they expect to go up in price and sell those they don’t. When everyone wants to buy oil because they think the price is going up, its price does indeed goes up. But that is not directly related to the actual supply of oil from the ground (it often is, but not always).</p> 
       <h3 id="right-price">Right Price</h3> 
       <p>In <a href="/blog/2017/09/22/bitcoin-value/">part 1</a> we covered how a sale is actually a loan, and how the seller ends up with tokens representing the value owed to the seller. The number of tokes (aka price) is a reflection of how we value things relative to each other.</p> 
       <p>When we buy stuff for everyday use we establish a price range that is driven by, for lack of a better term, <em>common sense</em>. For example we may think that a loaf of bread is worth a dozen eggs. If the price of something exceeds common sense, we will forego buying it. This means that the price has a direct effect on demand especially when it comes to everyday consumption items such as food or fuel.</p> 
       <p>Speculators have no respect for common sense and the right price. They are only concerned with the trend. It is possible for the speculative demand to drive the price way above the common sense level, we saw that when “peak oil” was a thing. But the price will eventually gravitate towards the common sense price.</p> 
       <h3 id="store-of-value-price">Store of Value Price</h3> 
       <p>In contrast, price for a store of value is purely speculative, which means the sensibility of the price does not apply.</p> 
       <p>Let’s take gold, for example. Intuitively we might reason that there is a (non-speculative) supply and demand for gold, but it’s actually illusory. The annual production of gold is minute compared to the total gold above ground, which means there is essentially no supply. There is also next to no demand, because gold cannot be consumed. There is never less or more gold available in the world, its quantity is fairly constant. Yet the price fluctuates. The only explanation for this is speculation.</p> 
       <p>There is simply no such thing as the “right price” for store of value. If I want to move a million dollars into gold, the price of gold is of no consequence to me, be it a thousand or a million dollars per ounce. So long as I know that it is stable, it is a good store of value.</p> 
       <p>The good news here is that no price is too high (or too low) for Bitcoin. 4K only seems high because a year ago it was 400. We tend to judge the price based on history, and there is good sense in that, indeed what goes up in value too much too fast often subsequently <em>corrects</em>.</p> 
       <h3 id="importance-of-market-cap">Importance of Market Cap</h3> 
       <p><em>Market capitalization</em> is the price of all of the asset available in the world. It’s easy to compute the market cap for a stock because we know the number of shares outstanding. There is no such thing as a market cap for a commodity because it is continuously produced and consumed. When it comes to something like gold, we can estimate the market cap because we know approximately how much physical gold is above ground. Bitcoin, like gold, has an approximate market cap (approximate because it is not possible to know how much BTC has been lost).</p> 
       <p>Market cap size is critical for adoption of a store of value. It needs to be large enough to “fit” even very large amounts of fiat, ideally without affecting the market. Gold market cap is estimated at 7 trillion USD, which means that even the richest people can move all their assets into gold and not move the market. (At least one at a time. All of them at once will move the market big time).</p> 
       <p>Bitcoin market cap of about 70B USD is not large enough for even one of the richest people on the planet. This implies that if the market cap does not grow, Bitcoin is likely to fail as store of value.</p> 
       <h3 id="hash-rate">Hash Rate</h3> 
       <p>What sets Bitcoin apart from all other crypto currencies is its extremely high hash rate. This means that a Bitcoin is orders of magnitude more “precious” than any other crypto coin presently in existence.</p> 
       <p>There is a definite correlation between the Bitcoin hash rate and the price. Some people argue that hash rate follows price, not the other way around, and it’s probably true.</p> 
       <p>Bitcoin’s high hash rate is what makes it the best store of value among crypto coins today.</p> 
       <h3 id="adoption">Adoption</h3> 
       <p>Ultimately, I believe adoption is the most important factor in Bitcoin USD price. Greater adoption will increase the number of speculators willing to own Bitcoin, it will drive the price up, and hopefully bring it to a level comparable to that of gold.</p> 
       <p>The key to adoption is not ease of payment or volume of transactions like we used to think until very recently. The key to adoption is understanding of the mathematics behind Bitcoin. With all the hype surrounding it, only remarkably few understand how sound Bitcoin actually is. In many ways it is more sound than any other store of value known, including gold.</p> 
       <p>Regardless of whether Bitcoin becomes de facto digital gold or not, we are witnessing a historic transformation possibly bigger than the Internet itself.</p> 
      </div> 
     </article> 
     <article> 
      <header> 
       <h1 class="entry-title"><a href="/blog/2017/09/22/bitcoin-value/">Bitcoin: Better Ink Than Gold?</a></h1> 
       <p class="meta"> <time datetime="2017-09-22T07:52:00-04:00" pubdate data-updated="true">Sep 22<span>nd</span>, 2017</time> | <a href="/blog/2017/09/22/bitcoin-value/#disqus_thread">Comments</a> </p> 
      </header> 
      <div class="entry-content">
       <p>The fundamental question about Bitcoin is not whether it is sound from the cryptography standpoint. The question is: what is it?</p> 
       <h3 id="money-is-debt-ink">Money is Debt Ink</h3> 
       <p>To define Bitcoin we need to look back at the history of <em>money</em>. The earliest money was in the form of things that were scarce and impossible to falsify, something like specific kinds of sea shells. Everyone knew that stuff could be traded for these tokens.</p> 
       <p>Once such monetary tokens were invented, we no longer needed to decide what to barter right there and then, we could postpone the decision. One could <em>sell</em> milk for tokens, then use those tokens to <em>buy</em> a spear later, this way the milk didn’t spoil while waiting for the spear to be made.</p> 
       <p>What is not very obvious is that the tokens represented <em>debt</em>. A sale is really a <em>loan</em> in disguise. Before the sale, the seller had milk. After the sale, the seller had tokens, which are proof that value of tokens is owed to the seller. In other words, the tokens received for the milk sold were a <em>record of debt</em>. Tokens are the <em>ink</em> in which this record is written.</p> 
       <p>It is noteworthy that there is no money if there is no debt, or that money implies debt. It’s a simple principle that so few understand.</p> 
       <h3 id="world-wide-debt-ledger">World-Wide Debt Ledger</h3> 
       <p>The best way of thinking about money is that it is the <em>medium</em> in which we maintain a world-wide record of debt. The entries in this book or ledger are written as physical tokens. Only the people in possession of the tokens actually know how much they have and there is no history, only the final state. The history exists only in the minds (or records) of the traders. It is very private.</p> 
       <h3 id="gold-ink">Gold Ink</h3> 
       <p>Later people started using rare metals such as gold or silver as money. Metals were better than sea shells because they were divisible. We could now make arbitrary size tokes we called (coined?) <em>coins</em>.</p> 
       <p>Although we intuitively think that gold has a lot of value, in reality it has very little. Gold does not feed us or keep us warm. It does have some unique properties, but back when we started using gold as money we couldn’t possibly appreciate those, other than perhaps gold being pretty and extremely durable.</p> 
       <p>Gold is also rare. But rarity does not imply value. The sea shells were worthless before they were used as money, and they are worthless now, yet they too are rare.</p> 
       <h3 id="banks-paper--and-records-of-records-of-records">Banks, Paper and Records of Records (of Records)</h3> 
       <p>But it turned out that keeping valuable tokens was difficult, they could be lost or stolen, and worse, people were willing to kill for them. And so we decided to keep them all safe in one place. This was the original <em>bank</em>.</p> 
       <p>The bank issued <em>paper notes</em> that corresponded to the gold in the vault. Now these paper notes could be traded for anything. This was because people knew that even though the paper is worthless, it represents gold that is in the bank. At any time one could go to the bank, give the bank the paper note and receive gold (at which point the bank would destroy the paper note because the debt is settled).</p> 
       <p>A paper note is a <em>record of the record</em> of debt. The true record was in gold, paper was a copy. It’s a bit of a mind-twister, but humans have become really good at rewriting the original debt ledger in other mediums.</p> 
       <p>Ironically the concept of the bank as a safe vault never really worked: people were willing to steal and kill for paper money just the same. These days bank vaults keep paper notes as if its gold. And the bank’s computer keeps a <em>record of the record of the record</em> of debt.</p> 
       <h3 id="real-estate-ink">Real Estate Ink</h3> 
       <p>At some point bankers realized that they can manipulate the monetary supply because only the bankers actually knew how much gold they had. It was done “for the good of the public” who could get easier loans, but it was also an easy way for the banks to make money out of nothing.</p> 
       <p>Eventually it was decreed that not just gold, but anyhting could be similarly held by the bank so that vastly more paper notes could be issued. Most notably real estate, the arrangement of issuing paper notes for a house being known as a mortgage. And since a house cannot be placed into the vault, it too had to be recorded, creating yet another layer of abstraction. It all ended with collateralized debt obligations, credit default swaps and ultimately the 2008 subprime mortgage crisis. Next year Bitcoin was born…</p> 
       <h3 id="monetary-system-is-just-a-ledger">Monetary System is Just a Ledger</h3> 
       <p>The bottom line remains: we kept a legder. The recording medium was precious metals, then evolved to paper and metals, and finally when we went off the gold standard it became just paper reflecting value of arbitrary things held under lien as collateral.</p> 
       <h3 id="enter-blockchain">Enter Blockchain</h3> 
       <p>The Bitcoin <em>blockchian</em> is also a medium for this legder, only instead of relying on scarcity of precious metals, the scarcity is in the mathematical complexity of a problem.</p> 
       <p>And this is where our minds begin to play tricks on us, because this is a concept previously unknown to humans. A Bitcoin, which takes an enormous amount of computational power to generate, is actually, really scarce. Yes, it is not physical, it is just “knowlegde” or “information”, but by all laws of nature it is scarce, in fact more scarce than gold, the total amount of which in the universe isn’t fully known.</p> 
       <h3 id="but-bitcoin-is-just-an-agreement">But Bitcoin is just an Agreement?</h3> 
       <p>Interestingly, Bitcoin is merely an agreement and one might argue that some day we can collectively decide to increase the 21 million limit thereby diluting Bitcoin value. But can we actually do that, or will it not be Bitcoin at that point? I think only time will tell.</p> 
       <p>We do already have a lot of things that we agree on and we don’t really question how it happened. The aforementioned shells were collectively agreed upon. We agree on what the current date is, does it matter how it happened? In fact, much of what the world is, just <em>is</em>, including the fiat money (where “fiat” literally means “let it be done”). And so now Bitcoin just is.</p> 
       <p>The sea shells ceased to exist as money in favor or precious metals, and it is likely that same will at some point happen with Bitcoin.</p> 
       <p>History does show that when it comes to money, people show their worst traits. This is why countries with solid currencies have big armies and police, and very strict laws regarding manipulation of money. This is how “fiat” actually works.</p> 
       <p>Amazingly, the mathematic principles on which Bitcoin is based do not need to be defended. No army in the world could ever change a single prime number.</p> 
       <h3 id="alternative-realities">Alternative Realities</h3> 
       <p>The name Bitcoin refers to a specific blockchain. There can be many like it. The name could have been different, the parameters of the algorithm could have been different, just like the dollar bills could have been blue. There are other cryptographic currencies, and they are different, they too now exist. (Caveat: some of them are mathematically bogus).</p> 
       <p>One could argue that gold exists in nature, while Bitcoin was created by man, and thus gold is somehow more real. But Bitcoin rests on the mathematical principles that too are just part of this universe, they were not created by man, they were discovered and applied, and again in this sense Bitcoin isn’t much different than gold.</p> 
       <h3 id="the-mystery-of-value">The Mystery of Value</h3> 
       <p>The mystery to me is how we collectively set a value of things like gold or Bitcoins. Now that we’ve demonstrated that as money, they are equivalent. Why is an ounce of gold worth $1300? Who decided that? The market? Is the real value of it in how good of an ink it is in the world-wide debt ledger?</p> 
       <p>To be continued…</p> 
      </div> 
     </article> 
     <article> 
      <header> 
       <h1 class="entry-title"><a href="/blog/2017/07/04/tgres-status-july-2017/">Tgres Status - July 4th 2017</a></h1> 
       <p class="meta"> <time datetime="2017-07-04T08:28:00-04:00" pubdate data-updated="true">Jul 4<span>th</span>, 2017</time> | <a href="/blog/2017/07/04/tgres-status-july-2017/#disqus_thread">Comments</a> </p> 
      </header> 
      <div class="entry-content">
       <p>It’s been a while since I’ve written on <a href="https://github.com/tgres/tgres">Tgres</a>, here’s a little update, Independence Day edition.</p> 
       <h3 id="current-status">Current Status</h3> 
       <p>The current status is that Tgres is looking more and more like a finished product. It still needs time and especially user testing (the ball is in your court, dear reader), because only time reveals the weirdest of bugs and validates stability. I would not ditch your current stack just yet, but at this point you’d be remiss not having given Tgres a spin.</p> 
       <p>Recently I had an opportunity to test Tgres as a mirror replica of a sizable Graphite/Statsd/Grafana set up receiving approximately 10K data points per second across more than 200K series, and the results were inspiring. Tgres handled the incoming data without breaking a sweat on “hardware” (ec2 instances, rather) that was a fraction of the Graphite machines while still outperforming it in most respects.</p> 
       <p>I’d say the biggest problem (and not really a Tgres one) is that mirroring Graphite functionality <em>exactly</em> is next to impossible. Or, rather, it is possible, but it would imply purposely introducing inaccuracies and complexities. Because of this Tgres can never be a “drop in” replacement for Graphite. Tgres can provide results that are close but not identical, and dashboards and how the data is interpreted would require some rethinking.</p> 
       <h2 id="whats-new">What’s new?</h2> 
       <h3 id="data-point-versioning">Data Point Versioning</h3> 
       <p>In a round-robin database slot values are overwritten as time moves forward and the archive comes full-circle. Whenever a value is not overwritten for whatever reason, a stale value from an obsolete iteration erroneously becomes the value for the current iteration.</p> 
       <p>One solution is to be diligent and always make sure that values are overwritten. This solution can be excessively I/O intensive for sparse series. If a series is sparse, then more I/O resources are spent blanking out non-data (by setting the value to NaN or whatever) than storing actual data points.</p> 
       <p>A much more efficient approach is to store a version number along with the datapoint. Every time the archive comes full-circle, version is incremented. With versions there is no need to nullify slots, they become obsoleted by virtue of the data point version not matching the current version.</p> 
       <p>Under the hood Tgres does this by keeping a separate array in the <code>ts</code> table which contains a smallint (2 bytes) for every data point. The <code>tv</code> view is aware of it and considers versions without exposing any details, in other words everything works as before, only Tgres is a lot more efficient and executes a lot less SQL statements.</p> 
       <h3 id="zero-heartbeat-series">Zero Heartbeat Series</h3> 
       <p>Tgres always strives to connect the data points. If two data points arrive more than a step apart, the slots in between are <a href="https://github.com/tgres/tgres/blob/d5a622a33511c1a8c43538c8de915fac52b02291/rrd/ds.go#L220-L229">filled in</a> to provide continuity. A special parameter called <a href="https://github.com/tgres/tgres/blob/d5a622a33511c1a8c43538c8de915fac52b02291/rrd/ds.go#L81-L105">Heartbeat</a> controls the maximum time between data points. A gap greater than the Heartbeat is considered unknown or NaN.</p> 
       <p>This was a deliberate design decision from the beginning, and it is not changing. Some tools choose to store data points as is, deferring any normalization to the query time. Graphite is kind of in the middle: it doesn’t store the data points as is, yet it does not attempt to do any normalization either, which ultimately leads to inaccuracies which I describe in another <a href="/blog/2015/05/04/recording-time-series/">post</a>.</p> 
       <p>The concept of Heartbeat should be familiar to those experienced with RRDTool, but it is unknown to Graphite users which has no such parameter. This “disconnected” behavior is often taken advantage of to track things that aren’t continuous but are event occurrences which can still benefit from being observed as a time series. Tracking application deploys, where each deploy is a data value of 1 is one such example.</p> 
       <p>Tgres now supports this behavior when the the Heartbeat is set to 0. Incoming data points are simply stored in the best matching slot and no attempt is made to fill in the gap in between with data.</p> 
       <h3 id="tgres-listens-to-delete-events">Tgres Listens to DELETE Events</h3> 
       <p>This means that to delete a DS all you need to do is run <code>DELETE FROM ds WHERE ...</code> and you’re done. All the corresponding table rows will be deleted by Postgres because of the foreign key constraints, and the DS will be cleared from the Tgres cache at the same time.</p> 
       <p>This is possible thanks to the Postgres excellent <a href="https://www.postgresql.org/docs/current/static/sql-notify.html">LISTEN/NOTIFY</a> capability.</p> 
       <h3 id="in-memory-series-for-faster-querying">In-Memory Series for Faster Querying</h3> 
       <p>A subset of series can be kept entirely in memory. The recent testing has shown that people take query performance very seriously, and dashboards with refresh rates of 5s or even 1s are not unheard of. When you have to go to the database to answer every query, and if the dashboard touches a hundred series, this does not work too well.</p> 
       <p>To address this, Tgres now keeps an in-memory cache of queried series. The cache is an <a href="https://godoc.org/github.com/hashicorp/golang-lru">LRU</a> and its size is configurable. On restart Tgres saves cache keys and loads the series back to keep the cache “warm”.</p> 
       <p>Requests for some cached queries can now be served in literally <a href="https://en.wikipedia.org/wiki/Microsecond">microseconds</a>, which makes for some pretty amazing user experience.</p> 
       <h3 id="ds-and-rra-state-is-an-array">DS and RRA State is an Array</h3> 
       <p>One problem with the Tgres table layout was that DS and RRA tables contained frequently updated columns such as lastupdate, value and duration The initial strategy was that these could be updated periodically in a lzay fashion, but it became apparent that it was not practical for any substantial number of series.</p> 
       <p>To address this all frequently mutable attributes are now stored in arrays, same way as data points and therefore can be updated 200 (or whatever segment width is configured) at a time.</p> 
       <p>To simplify querying DSs and RRAs two new views (<code>dsv</code> and <code>rrav</code>) were created which abstract away the array value lookup.</p> 
       <h3 id="whisper-data-migration">Whisper Data Migration</h3> 
       <p>The <a href="https://github.com/tgres/tgres/tree/master/cmd/whisper_import">whisper_import</a> tool has been pretty much rewritten and has better instructions. It’s been tested extensively, though admittedly on one particular set up, your mileage may vary.</p> 
       <h3 id="graphite-dsl">Graphite DSL</h3> 
       <p>Lots and lots of fixes and additions to the Graphite DSL implementation. Tgres still does not support <em>all</em> of the functions, but that was never the plan to begin with.</p> 
       <h2 id="future">Future</h2> 
       <p>Here’s some ideas I might tackle in the near future. If you are interested in contributing, do not be shy, pull requests, issues and any questions or comments are welcome. (Probably best to keep development discussion in <a href="https://github.com/tgres/tgres/issues">Github</a>).</p> 
       <ul> 
        <li> <h4 id="get-rid-of-the-config-file">Get rid of the config file</h4> </li> 
       </ul> 
       <p>Tgres doesn’t really need a config file - the few options that are required for running should be command line args, the rest, such as new series specs should be in the database.</p> 
       <ul> 
        <li> <h4 id="a-user-interface">A user interface</h4> </li> 
       </ul> 
       <p>Not terribly high on the priority list, since the main UI is <code>psql</code> for low level stuff and Grafana for visualization, but something to list series and tweak config options might come in handy.</p> 
       <ul> 
        <li> <h4 id="track-usage">Track Usage</h4> </li> 
       </ul> 
       <p>It would be interesting to know how many bytes exactly a series occupies, how often it is updated and queried, and what is the resource cost for maintaining it.</p> 
       <ul> 
        <li> <h4 id="better-code-organization">Better code organization</h4> </li> 
       </ul> 
       <p>For example vcache could be a separate package.</p> 
       <ul> 
        <li> <h4 id="rethink-the-dsl">Rethink the DSL</h4> </li> 
       </ul> 
       <p>There should be a DSL version 2, which is not based on the Graphite unwieldiness. It should be very simple and versatile and not have hundreds of functions.</p> 
       <ul> 
        <li> <h4 id="authentication-and-encryption">Authentication and encryption</h4> </li> 
       </ul> 
       <p>No concrete ideas here, but it would be nice to have a plan.</p> 
       <ul> 
        <li> <h4 id="clustering-needs-to-be-re-considered">Clustering needs to be re-considered</h4> </li> 
       </ul> 
       <p>The current clustering strategy is flawed. It might work with the current plan, but some serious brainstorming needs to happen here. Perhaps it should just be removed in favor of delegating horizontal scaling to the database layer.</p> 
      </div> 
     </article> 
     <article> 
      <header> 
       <h1 class="entry-title"><a href="/blog/2017/04/27/simplistic-go-web-app/">Building a Go Web App in 2017</a></h1> 
       <p class="meta"> <time datetime="2017-04-27T15:00:00-04:00" pubdate data-updated="true">Apr 27<span>th</span>, 2017</time> | <a href="/blog/2017/04/27/simplistic-go-web-app/#disqus_thread">Comments</a> </p> 
      </header> 
      <div class="entry-content">
       <p>Update: <a href="/blog/2017/04/27/simplistic-go-web-app-part-2/">part 2</a> is here, enjoy. And <a href="/blog/2017/04/27/go-web-app-part-3/">part 3</a>. And <a href="/blog/2017/04/27/go-web-app-part-4/">part 4</a>.</p> 
       <p>A few weeks ago I started building yet another web-based app, in <a href="https://golang.org/">Go</a>. Being mostly a back-end developer, I don’t have to write web apps very often, and every time I do, it seems like a great challenge. I often wish someone would write a guide to web development for people who do not have all day to get into the intricacies of great design and just need to build a functional site that works without too much fuss.</p> 
       <p>I’ve decided to use this opportunity to start from scratch and build it to the best of my understanding of how an app ought to be built in 2017. I’ve spent many hours getting to the bottom of all things I’ve typically avoided in the past, just so that for once in many years I can claim to have a personal take on the matter and have a reusable recipe that at least works for me, and hopefully not just me.</p> 
       <p>This post is the beginning of what I expect to be a short series highlighting what I’ve learned in the process. The first post is a general introduction describing the present problematic state of affairs and why I think Go is a good choice. The subsequent posts have more details and code. I am curious whether my experience resonates with others, and what I may have gotten wrong, so don’t hesitate to comment!</p> 
       <p>Edit: If you’d rather just see code, it’s <a href="https://github.com/grisha/gowebapp">here</a>.</p> 
       <h3 id="introduction">Introduction</h3> 
       <p>In the past my basic knowledge of HTML, CSS and JavaScript has been sufficient for my modest site building needs. Most of the apps I’ve ever built were done using <a href="https://github.com/grisha/mod_python">mod_python</a> directly using the publisher handler. Ironically for an early Python adopter, I’ve also done a fair bit of work with <a href="http://rubyonrails.org/">Rails</a>. For the past several years I focused on (big) data infrastructure, which isn’t web development at all, though having to build web-based UI’s is not uncommon. In fact the app I’m referring to here is a data app, but it’s not open source and what it does really doesn’t matter for this discussion. Anyway, this should provide some perspective of where I come from when approaching this problem.</p> 
       <h3 id="python-and-ruby">Python and Ruby</h3> 
       <p>As recently as a year ago, Python and Ruby would be what I would recommend for a web app environment. There may be other similar languages, but from where I stand, the world is dominated by Python and Ruby.</p> 
       <p>For the longest time the main job of a web application was constructing web pages by piecing HTML together server-side. Both Python and Ruby are very well suited for the template-driven work of taking data from a database and turning it into a bunch of HTML. There are lots of frameworks/tools to choose from, e.g. Rails, Django, Sinatra, Flask, etc, etc.</p> 
       <p>And even though these languages have certain significant limitations, such as the <a href="https://en.wikipedia.org/wiki/Global_interpreter_lock">GIL</a>, the ease with which they address the complexity of generating HTML is far more valuable than any trade-offs that came with them.</p> 
       <h3 id="the-gil">The GIL</h3> 
       <p>The Global Interpreter Lock is worthy of a separate mention. It is the elephant in the room, by far the biggest limitation of any Python or Ruby solution. It is so crippling, people can get emotional talking about it, there are endless GIL discussions in both Ruby and Python communities.</p> 
       <p>For those not familiar with the problem - the GIL only lets one thing happen at a time. When you create threads and it “looks” like parallel execution, the interpreter is still executing instructions sequentially. This means that a single process can only take advantage of a single CPU.</p> 
       <p>There do exist alternative implementations, for example JVM-based, but they are not the norm. I’m not exactly clear why, they may not be fully interchangeable, they probably do not support C extensions correctly, and they might still have a GIL, not sure, but as far as I can tell, the C implementation is what everyone uses out there. Re-implementing the interpreter without the GIL would amount to a complete rewrite, and more importantly it may affect the behavior of the language (at least that’s my naive understanding), and so for this reason I think the GIL is here to stay.</p> 
       <p>Web apps of any significant scale absolutely require the ability to serve requests in parallel, taking advantage of every CPU a machine has. Thus far the only possible solution known is to run multiple instances of the app as separate processes.</p> 
       <p>This is typically done with help of additional software such as Unicorn/Gunicorn with every process listening on its own port and running behind some kind of a connection balancer such as Nginx and/or Haproxy. Alternatively it can be accomplished via Apache and its modules (such as mod_python or mod_wsgi), either way it’s complicated. Such apps typically rely on the database server as the arbiter for any concurrency-sensitive tasks. To implement caching without keeping many copies of the same thing on the same server a separate memory-based store is required, e.g. Memcached or Redis, usually both. These apps also cannot do any background processing, for that there is a set of tools such as Resque. And then all these components need to be monitored to make sure it’s working. Logs need to be consolidated and there are additional tools for that. Given the inevitable complexity of this set up there is also a requirement for a configuration manager such as Chef or Puppet. And still, these set ups are generally not capable of maintaining a large number of long term connections, a problem known as C10K.</p> 
       <p>Bottom line is that a simple database-backed web app requires a whole bunch of moving parts before it can serve a “Hello World!” page. And nearly all of it because of the GIL.</p> 
       <h3 id="emergence-of-single-page-applications">Emergence of Single Page Applications</h3> 
       <p>More and more, server-side HTML generation is becoming a thing of the past. The latest (and correct) trend is for UI construction and rendering to happen completely client-side, driven by JavaScript. Apps whose user interface is fully JS-driven are sometimes called <a href="https://en.wikipedia.org/wiki/Single-page_application">Single Page Applications</a>, and are in my opinion the future whether we like it or not. In an SPA scenario the server only serves data, typically as JSON, and no HTML is constructed there. In this set up, the tremendous complexity introduced primarily so that a popular scripting language could be used isn’t worth the trouble. Especially considering that Python or Ruby bring little to the table when all of the output is JSON.</p> 
       <h3 id="enter-golang">Enter Golang</h3> 
       <p>Go is gradually disrupting the the world of web applications. Go natively supports parallel execution which eliminates the requirement for nearly all the components typically used to work around the GIL limitation.</p> 
       <p>Go programs are binaries which run natively, so there is no need for anything language-specific to be installed on the server. Gone is the problem of ensuring the correct runtime version the app requires, there is no separate runtime, it’s part of the binary. Go programs can easily and elegantly run tasks in the background, thus no need for tools like Resque. Go programs run as a single process which makes caching trivial and means Memcached or Redis is not necessary either. Go can handle an unlimited number of parallel connections, eliminating the need for a front-end guard like Nginx.</p> 
       <p>With Go the tall stack of Python, Ruby, Bundler, Virtualenv, Unicorn, WSGI, Resque, Memcached, Redis, etc, etc is reduced to just one binary. The only other component generally still needed is a database (I recommend PostgreSQL). It’s important to note that all of these tools are available as before for optional use, but with Go there is the option of getting by entirely without them.</p> 
       <p>To boot this Go program will most likely outperform any Python/Ruby app by an order of magnitude, require less memory, and with fewer lines of code.</p> 
       <h3 id="so-is-there-a-popular-framework-yet">So Is there a Popular Framework Yet?</h3> 
       <p>The short answer is: a framework is entirely optional and not recommended. There are many projects claiming to be great frameworks, but I think it’s best to try to get by without one. This isn’t just my personal opinion, I find that it is generally shared in the Go community.</p> 
       <p>It helps to think why frameworks existed in the first place. On the Python/Ruby side this was because these languages were not initially designed to serve web pages, and lots of external components were necessary to bring them up to the task. Same can be said for Java, which just like Python and Ruby, is about as old as the web as we know it, or even pre-dates it slightly.</p> 
       <p>As I remember it, out of the box, early versions of Python did not provide anything to communicate with a database, there was no templating, HTTP support was confusing, networking was non-trivial, bundling crypto would not even be legal then, and there was a whole lot of other things missing. A framework provided all the necessary pieces and set out rules for idiomatic development for all the common web app use cases.</p> 
       <p>Go, on the other hand, was built by people who already experienced and understood web development. It includes just about everything necessary. An external package or two can be needed to deal with certain specific aspects, e.g. OAuth, but by no means does a couple of packages constitute a “framework”.</p> 
       <p>If the above take on frameworks not convincing enough, it’s helpful to consider the framework learning curve and the risks. It took me about two years to get comfortable with Rails. Frameworks can become abandoned and obsolete, porting apps to a new framework is hard if not impossible. Given how quickly the information technology sands shift, frameworks are not to be chosen lightly.</p> 
       <p>I’d like to specifically single out tools and frameworks that attempt to mimic idioms common to the Python, Ruby or the JavaScript environments. Anything that looks or feels or claims to be “Rails for Go”, features techniques like injection, dynamic method publishing and the like which require relying heavily on reflection are not the Go way of doing things, it’s best to stay away from those.</p> 
       <p>Frameworks definitely do make some things easier, especially in the typical business CRUD world, where apps have many screens with lots of fields, manipulating data in complex and ever-changing database schemas. In such an environment, I’m not sure Go is a good choice in the first place, especially if performance and scaling are not a priority.</p> 
       <p>Another issue common to frameworks is that they abstract lower level mechanisms from the developer often in way that over time grows to be so arcane that it is literally impossible to figure out what is actually happening. What begins with an idiomatic alias for a single line of JavaScript becomes layers upon layers of transpilers, minimizers on top of helpers hidden somewhere in a sub-dependency. One day something breaks and it’s impossible to know where to even look for the problem. It’s nice to know exactly what is going on sometimes, Go is generally very good about that.</p> 
       <h3 id="what-about-the-database-and-orm">What about the database and ORM?</h3> 
       <p>Similarly to frameworks, Go culture is not big on ORM’s. For starters, Go specifically does not support objects, which is what the O in ORM stands for.</p> 
       <p>I know that writing SQL by hand instead of relying on <code>User.find(:all).filter...</code> convenience provided to by the likes of ActiveRecord is unheard of in some communities, but I think this attitude needs to change. SQL is an amazing language. Dealing with SQL directly is not that hard, and quite liberating, as well as incredibly powerful. Possibly the most tedious part of it all is copying the data from a database cursor into structures, but here I found the sqlx project very useful.</p> 
       <h3 id="in-conclusion">In Conclusion</h3> 
       <p>I think this sufficiently describes the present situation of the server side. The client side I think could be separate post, so I’ll pause here for now. To sum up, thus far it looks like we’re building an app with roughly the following requirements:</p> 
       <ul> 
        <li>Minimal reliance on third party packages.</li> 
        <li>No web framework.</li> 
        <li>PostgreSQL backend.</li> 
        <li>Single Page Application.</li> 
       </ul> 
       <p><a href="/blog/2017/04/27/simplistic-go-web-app-part-2/">part 2</a></p> 
      </div> 
     </article> 
     <article> 
      <header> 
       <h1 class="entry-title"><a href="/blog/2017/04/27/simplistic-go-web-app-part-2/">Building a Go Web App - Part 2</a></h1> 
       <p class="meta"> <time datetime="2017-04-27T14:00:00-04:00" pubdate data-updated="true">Apr 27<span>th</span>, 2017</time> | <a href="/blog/2017/04/27/simplistic-go-web-app-part-2/#disqus_thread">Comments</a> </p> 
      </header> 
      <div class="entry-content">
       <p>This is a continuation of <a href="/blog/2017/04/27/simplistic-go-web-app/">part 1</a>. (There is also <a href="/blog/2017/04/27/go-web-app-part-3/">part 3</a> and <a href="/blog/2017/04/27/go-web-app-part-4/">part 4</a>).</p> 
       <p>So our app is going to have two major parts to it: client and server. (What year is this?). The server side is going to be in Go, and the client side in JS. Let’s talk about the server side first.</p> 
       <h2 id="the-go-server-side">The Go (Server) Side</h2> 
       <p>The server side of our application is going to be responsible for initially serving up all the necessary JavaScript and supporting files if any, aka static assets and data in the form of JSON. That’s it, just two functions: (1) static assets and (2) JSON.</p> 
       <p>It’s worth noting that serving assets is optional: assets could be served from a CDN, for example. But what is different is that it is not a problem for our Go app, unlike a Python/Ruby app it can perform on par with Ngnix and Apache serving static assets. Delegating assets to another piece of software to lighten its load is no longer necessary, though certainly makes sense in some situations.</p> 
       <p>To make this simpler, let’s pretend we’re making an app that lists people (just first and last name) from a database table, that’s it. The code is here <a href="https://github.com/grisha/gowebapp">https://github.com/grisha/gowebapp</a>.</p> 
       <h3 id="directory-layout">Directory Layout</h3> 
       <p>It has been my experience that dividing functionality across packages early on is a good idea in Go. Even if it is not completely clear how the final program will be structured, it is good to keep things separate to the extent possible.</p> 
       <p>For a web app I think something along the lines of the following layout makes sense:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code">
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td>
              <td class="code"><pre><code class=""><span class="line"># github.com/user/foo </span><span class="line"> </span><span class="line">foo/ # package main </span><span class="line"> | </span><span class="line"> +--daemon/ # package daemon </span><span class="line"> | </span><span class="line"> +--model/ # package model </span><span class="line"> | </span><span class="line"> +--ui/ # package ui </span><span class="line"> | </span><span class="line"> +--db/ # package db </span><span class="line"> | </span><span class="line"> +--assets/ # where we keep JS and other assets</span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <h3 id="top-level-package-main">Top level: <code>package main</code></h3> 
       <p>At the top level we have package <code>main</code> and its code in <code>main.go</code>. The key advantage here is that with this layout <code>go get github.com/user/foo</code> can be the only command required to install the whole application into <code>$GOPATH/bin</code>.</p> 
       <p>Package <code>main</code> should do as little as possible. The only code that belongs here is to parse the command argument flags. If the app had a config file, I’d stick parsing and checking of that file into yet another package, probably called <code>config</code>. After that main should pass the control to the <code>daemon</code> package.</p> 
       <p>An essential main.go is:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span> </span><span class="line"> </span><span class="line"><span class="kn">import</span> <span class="p">(</span> </span><span class="line"> <span class="s">"github.com/user/foo/daemon"</span> </span><span class="line"><span class="p">)</span> </span><span class="line"> </span><span class="line"><span class="kd">var</span> <span class="nx">assetsPath</span> <span class="kt">string</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="nx">processFlags</span><span class="p">()</span> <span class="o">*</span><span class="nx">daemon</span><span class="p">.</span><span class="nx">Config</span> <span class="p">{</span> </span><span class="line"> <span class="nx">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">daemon</span><span class="p">.</span><span class="nx">Config</span><span class="p">{}</span> </span><span class="line"> </span><span class="line"> <span class="nx">flag</span><span class="p">.</span><span class="nx">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ListenSpec</span><span class="p">,</span> <span class="s">"listen"</span><span class="p">,</span> <span class="s">"localhost:3000"</span><span class="p">,</span> <span class="s">"HTTP listen spec"</span><span class="p">)</span> </span><span class="line"> <span class="nx">flag</span><span class="p">.</span><span class="nx">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Db</span><span class="p">.</span><span class="nx">ConnectString</span><span class="p">,</span> <span class="s">"db-connect"</span><span class="p">,</span> <span class="s">"host=/var/run/postgresql dbname=gowebapp sslmode=disable"</span><span class="p">,</span> <span class="s">"DB Connect String"</span><span class="p">)</span> </span><span class="line"> <span class="nx">flag</span><span class="p">.</span><span class="nx">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">assetsPath</span><span class="p">,</span> <span class="s">"assets-path"</span><span class="p">,</span> <span class="s">"assets"</span><span class="p">,</span> <span class="s">"Path to assets dir"</span><span class="p">)</span> </span><span class="line"> </span><span class="line"> <span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span> </span><span class="line"> <span class="k">return</span> <span class="nx">cfg</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="nx">setupHttpAssets</span><span class="p">(</span><span class="nx">cfg</span> <span class="o">*</span><span class="nx">daemon</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"Assets served from %q."</span><span class="p">,</span> <span class="nx">assetsPath</span><span class="p">)</span> </span><span class="line"> <span class="nx">cfg</span><span class="p">.</span><span class="nx">UI</span><span class="p">.</span><span class="nx">Assets</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Dir</span><span class="p">(</span><span class="nx">assetsPath</span><span class="p">)</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span> </span><span class="line"> <span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">processFlags</span><span class="p">()</span> </span><span class="line"> </span><span class="line"> <span class="nx">setupHttpAssets</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span> </span><span class="line"> </span><span class="line"> <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">daemon</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">cfg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"Error in main(): %v"</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>The above program accepts three parameters, <code>-listen</code>, <code>-db-connect</code> and <code>-assets-path</code>, nothing earth shattering.</p> 
       <h4 id="using-structs-for-clarity">Using structs for clarity</h4> 
       <p>In line <code>cfg := &amp;daemon.Config{}</code> we are creating a <code>daemon.Config</code> object. It’s main purpose is to pass around configuration in a structured and clear format. Every one of our packages defines its own <code>Config</code> type describing the parameters it needs, and packages can include other package configs. We see an example of this in <code>processFlags()</code> above: <code>flag.StringVar(&amp;cfg.Db.ConnectString, ...</code>. Here <code>db.Config</code> is included in <code>daemon.Config</code>. I find doing this very useful. These structures also keep open the possibility of serializing configs as JSON, TOML or whatever.</p> 
       <h4 id="using-httpfilesystem-to-serve-assets">Using http.FileSystem to serve assets</h4> 
       <p>The <code>http.Dir(assetsPath)</code> in <code>setupHttpAssets</code> is in preparation to how we will serve the assets in the <code>ui</code> package. The reason it’s done this way is to leave the door open for <code>cfg.UI.Assets</code> (which is a <code>http.FileSystem</code> interface) to be provided by other implementations, e.g. serving this content from memory. I will describe it in more detail in a later post.</p> 
       <p>Lastly, main calls <code>daemon.Run(cfg)</code> which is what actually starts our app and where it blocks until it’s terminated.</p> 
       <h3 id="package-daemon"><code>package daemon</code></h3> 
       <p>Package <code>daemon</code> contains everything related to running a process. Stuff like which port to listen on, custom logging would belong here, as well anything related to a graceful restart, etc.</p> 
       <p>Since the job of the <code>daemon</code> package is to initiate the database connection, it will need to import the <code>db</code> package. It’s also responsible for listening on the TCP port and starting the user interface for that listener, therefore it needs to import the <code>ui</code> package, and since the <code>ui</code> package needs to access data, which is done via the <code>model</code> package, it will need to import <code>model</code> as well.</p> 
       <p>A bare bones <code>daemon</code> might look like this:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">daemon</span> </span><span class="line"> </span><span class="line"><span class="kn">import</span> <span class="p">(</span> </span><span class="line"> <span class="s">"log"</span> </span><span class="line"> <span class="s">"net"</span> </span><span class="line"> <span class="s">"os"</span> </span><span class="line"> <span class="s">"os/signal"</span> </span><span class="line"> <span class="s">"syscall"</span> </span><span class="line"> </span><span class="line"> <span class="s">"github.com/grisha/gowebapp/db"</span> </span><span class="line"> <span class="s">"github.com/grisha/gowebapp/model"</span> </span><span class="line"> <span class="s">"github.com/grisha/gowebapp/ui"</span> </span><span class="line"><span class="p">)</span> </span><span class="line"> </span><span class="line"><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span> </span><span class="line"> <span class="nx">ListenSpec</span> <span class="kt">string</span> </span><span class="line"> </span><span class="line"> <span class="nx">Db</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Config</span> </span><span class="line"> <span class="nx">UI</span> <span class="nx">ui</span><span class="p">.</span><span class="nx">Config</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="nx">Run</span><span class="p">(</span><span class="nx">cfg</span> <span class="o">*</span><span class="nx">Config</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span> </span><span class="line"> <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"Starting, HTTP on: %s\n"</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">ListenSpec</span><span class="p">)</span> </span><span class="line"> </span><span class="line"> <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">InitDb</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Db</span><span class="p">)</span> </span><span class="line"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"Error initializing database: %v\n"</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> </span><span class="line"> <span class="k">return</span> <span class="nx">err</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> </span><span class="line"> <span class="nx">m</span> <span class="o">:=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> </span><span class="line"> </span><span class="line"> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">ListenSpec</span><span class="p">)</span> </span><span class="line"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"Error creating listener: %v\n"</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> </span><span class="line"> <span class="k">return</span> <span class="nx">err</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> </span><span class="line"> <span class="nx">ui</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">UI</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span> </span><span class="line"> </span><span class="line"> <span class="nx">waitForSignal</span><span class="p">()</span> </span><span class="line"> </span><span class="line"> <span class="k">return</span> <span class="kc">nil</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="nx">waitForSignal</span><span class="p">()</span> <span class="p">{</span> </span><span class="line"> <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">)</span> </span><span class="line"> <span class="nx">signal</span><span class="p">.</span><span class="nx">Notify</span><span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGINT</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">)</span> </span><span class="line"> <span class="nx">s</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch</span> </span><span class="line"> <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"Got signal: %v, exiting."</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Note how <code>Config</code> includes <code>db.Config</code> and <code>ui.Config</code> as I described earlier.</p> 
       <p>All the action happens in <code>Run(*Config)</code>. We initialize a database connection, create a <code>model.Model</code> instance, and start the <code>ui</code> passing in the config, a pointer to the model and the listener.</p> 
       <h3 id="package-model"><code>package model</code></h3> 
       <p>The purpose of <code>model</code> is to separate how data is stored in the database from the <code>ui</code>, as well as to contain any business logic an app might have. It’s the brains of the app if you will.</p> 
       <p>The <code>model</code> package should define a struct (<code>Model</code> seems like an appropriate name) and a pointer to an instance of the struct should be passed to all the <code>ui</code> functions and methods. There should only be one such instance in our app - for extra credit you can enforce that programmatically by making it a singleton, but I don’t think that’s necessary.</p> 
       <p>Alternatively you could get by without a <code>Model</code> and just use the package <code>model</code> itself. I don’t like this approach, but it’s an option.</p> 
       <p>The model should also define structs for the data entities we are dealing with. In our example it would be a <code>Person</code> struct. Its members should be exported (capitalized) because other packages will be accessing those. If you use <a href="https://github.com/jmoiron/sqlx">sqlx</a>, this is where you would also specify tags that map elements to db column names, e.g. <code>`db:"first_name"`</code></p> 
       <p>Our Person type:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span> </span><span class="line"> <span class="nx">Id</span> <span class="kt">int64</span> </span><span class="line"> <span class="nx">First</span><span class="p">,</span> <span class="nx">Last</span> <span class="kt">string</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>In our case we do not need tags because our column names match the element names, and sqlx conveniently takes care of the capitalization, so <code>Last</code> matches the column named <code>last</code>.</p> 
       <h4 id="package-model-should-not-import-db">package model should NOT import db</h4> 
       <p>Somewhat counter-intuitive, <code>model</code> cannot import <code>db</code>. This is because <code>db</code> needs to import <code>model</code>, and circular imports are not allowed in Go. This is one case where interfaces come in handy. <code>model</code> needs to define an interface which <code>db</code> should satisfy. For now all we know is we need to list people, so we can start with this definition:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">db</span> <span class="kd">interface</span> <span class="p">{</span> </span><span class="line"> <span class="nx">SelectPeople</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">Person</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Our app doesn’t really do much, but we know it lists people, so our model should probably have a <code>People() ([]*Person, error)</code> method:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Model</span><span class="p">)</span> <span class="nx">People</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">Person</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">SelectPeople</span><span class="p">()</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>To keep things tidy, code should be in separate files, e.g. <code>Person</code> definition should be in <code>person.go</code>, etc. For readability, here is a single file version of our <code>model</code>:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">model</span> </span><span class="line"> </span><span class="line"><span class="kd">type</span> <span class="nx">db</span> <span class="kd">interface</span> <span class="p">{</span> </span><span class="line"> <span class="nx">SelectPeople</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">Person</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">type</span> <span class="nx">Model</span> <span class="kd">struct</span> <span class="p">{</span> </span><span class="line"> <span class="nx">db</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="nx">New</span><span class="p">(</span><span class="nx">db</span> <span class="nx">db</span><span class="p">)</span> <span class="o">*</span><span class="nx">Model</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Model</span><span class="p">{</span> </span><span class="line"> <span class="nx">db</span><span class="p">:</span> <span class="nx">db</span><span class="p">,</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Model</span><span class="p">)</span> <span class="nx">People</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">Person</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">SelectPeople</span><span class="p">()</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span> </span><span class="line"> <span class="nx">Id</span> <span class="kt">int64</span> </span><span class="line"> <span class="nx">First</span><span class="p">,</span> <span class="nx">Last</span> <span class="kt">string</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <h3 id="package-db"><code>package db</code></h3> 
       <p><code>db</code> is the actual implementation of the database interaction. This is where the SQL statements are constructed and executed. This package also imports <code>model</code> because it will need to construct those structs from database data.</p> 
       <p>First, <code>db</code> needs to provide the <code>InitDb</code> function which will establish the database connection, as well as create the necessary tables and prepare the SQL statements.</p> 
       <p>Our simplistic example doesn’t support migrations, but in theory this is also where they might potentially happen.</p> 
       <p>We are using PostgreSQL, which means we need to import the <a href="https://github.com/lib/pq">pq</a> driver. We are also going to rely on sqlx, and we need our own <code>model</code>. Here is the beginning of our <code>db</code> implementation:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">db</span> </span><span class="line"> </span><span class="line"><span class="kn">import</span> <span class="p">(</span> </span><span class="line"> <span class="s">"database/sql"</span> </span><span class="line"> </span><span class="line"> <span class="s">"github.com/grisha/gowebapp/model"</span> </span><span class="line"> <span class="s">"github.com/jmoiron/sqlx"</span> </span><span class="line"> <span class="nx">_</span> <span class="s">"github.com/lib/pq"</span> </span><span class="line"><span class="p">)</span> </span><span class="line"> </span><span class="line"><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span> </span><span class="line"> <span class="nx">ConnectString</span> <span class="kt">string</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="nx">InitDb</span><span class="p">(</span><span class="nx">cfg</span> <span class="nx">Config</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pgDb</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> <span class="k">if</span> <span class="nx">dbConn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sqlx</span><span class="p">.</span><span class="nx">Connect</span><span class="p">(</span><span class="s">"postgres"</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">ConnectString</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span> </span><span class="line"> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> </span><span class="line"> <span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">pgDb</span><span class="p">{</span><span class="nx">dbConn</span><span class="p">:</span> <span class="nx">dbConn</span><span class="p">}</span> </span><span class="line"> <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">dbConn</span><span class="p">.</span><span class="nx">Ping</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">createTablesIfNotExist</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">prepareSqlStatements</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> <span class="k">return</span> <span class="nx">p</span><span class="p">,</span> <span class="kc">nil</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Out <code>InitDb()</code> creates an instance of a <code>pgDb</code>, which is our Postgres implementation of the <code>model.db</code> interface. It keeps all that we need to communicate with the database, including the prepared statements, and exports the necessary methods to satisfy the interface.</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">pgDb</span> <span class="kd">struct</span> <span class="p">{</span> </span><span class="line"> <span class="nx">dbConn</span> <span class="o">*</span><span class="nx">sqlx</span><span class="p">.</span><span class="nx">DB</span> </span><span class="line"> </span><span class="line"> <span class="nx">sqlSelectPeople</span> <span class="o">*</span><span class="nx">sqlx</span><span class="p">.</span><span class="nx">Stmt</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Here is the code to create the tables and the statements. From the SQL perspective this is rather simplistic, it could be a lot more elaborate, of course:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">pgDb</span><span class="p">)</span> <span class="nx">createTablesIfNotExist</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span> </span><span class="line"> <span class="nx">create_sql</span> <span class="o">:=</span> <span class="s">`</span> </span><span class="line"> </span><span class="line"><span class="s"> CREATE TABLE IF NOT EXISTS people (</span> </span><span class="line"><span class="s"> id SERIAL NOT NULL PRIMARY KEY,</span> </span><span class="line"><span class="s"> first TEXT NOT NULL,</span> </span><span class="line"><span class="s"> last TEXT NOT NULL);</span> </span><span class="line"> </span><span class="line"><span class="s"> `</span> </span><span class="line"> <span class="k">if</span> <span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">dbConn</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="nx">create_sql</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="nx">err</span> </span><span class="line"> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> </span><span class="line"> <span class="nx">rows</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> <span class="k">return</span> <span class="kc">nil</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">pgDb</span><span class="p">)</span> <span class="nx">prepareSqlStatements</span><span class="p">()</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> </span><span class="line"> <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">sqlSelectPeople</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">dbConn</span><span class="p">.</span><span class="nx">Preparex</span><span class="p">(</span> </span><span class="line"> <span class="s">"SELECT id, first, last FROM people"</span><span class="p">,</span> </span><span class="line"> <span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="nx">err</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> </span><span class="line"> <span class="k">return</span> <span class="kc">nil</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Finally, we need to provide the method to satisfy the interface:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"> <span class="nx">people</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Person</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> </span><span class="line"> <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">sqlSelectPeople</span><span class="p">.</span><span class="nx">Select</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">people</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> <span class="k">return</span> <span class="nx">people</span><span class="p">,</span> <span class="kc">nil</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Here we’re taking advantage of sqlx to run the query and construct a slice from results with a simple call to <code>Select()</code> (NB: <code>p.sqlSelectPeople</code> is a <code>*sqlx.Stmt</code>). Without sqlx we would have to iterate over the result rows, processing each with <code>Scan</code>, which would be considerably more verbose.</p> 
       <p>Beware of a very subtle “gotcha” here. <code>people</code> could also be defined as <code>var people []*model.Person</code> and the method would work just the same. However, if the database returned no rows, the method would return <code>nil</code>, not an empty slice. If the result of this method is later encoded as JSON, the former would become <code>null</code> and the latter <code>[]</code>. This could cause problems if the client side doesn’t know how to treat <code>null</code>.</p> 
       <p>That’s it for <code>db</code>.</p> 
       <h3 id="package-ui">package ui</h3> 
       <p>Finally, we need to serve all that stuff via HTTP and that’s what the <code>ui</code> package does.</p> 
       <p>Here is a very simplistic variant:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">ui</span> </span><span class="line"> </span><span class="line"><span class="kn">import</span> <span class="p">(</span> </span><span class="line"> <span class="s">"fmt"</span> </span><span class="line"> <span class="s">"net"</span> </span><span class="line"> <span class="s">"net/http"</span> </span><span class="line"> <span class="s">"time"</span> </span><span class="line"> </span><span class="line"> <span class="s">"github.com/grisha/gowebapp/model"</span> </span><span class="line"><span class="p">)</span> </span><span class="line"> </span><span class="line"><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span> </span><span class="line"> <span class="nx">Assets</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileSystem</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="nx">Start</span><span class="p">(</span><span class="nx">cfg</span> <span class="nx">Config</span><span class="p">,</span> <span class="nx">m</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span> <span class="nx">listener</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> </span><span class="line"> <span class="nx">server</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span> </span><span class="line"> <span class="nx">ReadTimeout</span><span class="p">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> </span><span class="line"> <span class="nx">WriteTimeout</span><span class="p">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> </span><span class="line"> <span class="nx">MaxHeaderBytes</span><span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">}</span> </span><span class="line"> </span><span class="line"> <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="nx">indexHandler</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span> </span><span class="line"> </span><span class="line"> <span class="k">go</span> <span class="nx">server</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">listener</span><span class="p">)</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="kd">const</span> <span class="nx">indexHTML</span> <span class="p">=</span> <span class="s">`</span> </span><span class="line"><span class="s">&lt;!DOCTYPE HTML&gt;</span> </span><span class="line"><span class="s">&lt;html&gt;</span> </span><span class="line"><span class="s"> &lt;head&gt;</span> </span><span class="line"><span class="s"> &lt;meta charset="utf-8"&gt;</span> </span><span class="line"><span class="s"> &lt;title&gt;Simple Go Web App&lt;/title&gt;</span> </span><span class="line"><span class="s"> &lt;/head&gt;</span> </span><span class="line"><span class="s"> &lt;body&gt;</span> </span><span class="line"><span class="s"> &lt;div id='root'&gt;&lt;/div&gt;</span> </span><span class="line"><span class="s"> &lt;/body&gt;</span> </span><span class="line"><span class="s">&lt;/html&gt;</span> </span><span class="line"><span class="s">`</span> </span><span class="line"> </span><span class="line"><span class="kd">func</span> <span class="nx">indexHandler</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">indexHTML</span><span class="p">)</span> </span><span class="line"> <span class="p">})</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Note how <code>indexHTML</code> contains next to nothing. This is 100% of the HTML that this app will ever serve. It will evolve a little as we get into the client side of the app, but only by a few lines.</p> 
       <p>Also noteworthy is how the handler is defined. If this idiom is not familiar, it’s worth spending a few minutes (or a day) to internalize it completely as it is very common in Go. <code>indexHandler()</code> is not a handler, it <em>returns</em> a handler function. It is done this way so that we can pass in a <code>*model.Model</code> via closure, since an HTTP handler function definition is fixed and a model pointer is not one of the parameters.</p> 
       <p>In the case of <code>indexHandler()</code> we’re not actually doing anything with the model pointer, but when we get to implementing an actual list of people we will need it.</p> 
       <h3 id="conclusion">Conclusion</h3> 
       <p>Above is essentially all the knowledge required to build a basic Go web app, at least the Go side of it. Next week I’ll get into the client side and we will complete the people listing code.</p> 
       <p>Continue to <a href="/blog/2017/04/27/go-web-app-part-3/">part 3</a>.</p> 
      </div> 
     </article> 
     <article> 
      <header> 
       <h1 class="entry-title"><a href="/blog/2017/04/27/go-web-app-part-3/">Building a Go Web App - Part 3</a></h1> 
       <p class="meta"> <time datetime="2017-04-27T13:00:00-04:00" pubdate data-updated="true">Apr 27<span>th</span>, 2017</time> | <a href="/blog/2017/04/27/go-web-app-part-3/#disqus_thread">Comments</a> </p> 
      </header> 
      <div class="entry-content">
       <p>This is part 3. See <a href="/blog/2017/04/27/simplistic-go-web-app/">part 1</a> and <a href="/blog/2017/04/27/simplistic-go-web-app-part-2/">part 2</a>.</p> 
       <p>The previous two posts got us to a point where we had a Go app which was able to serve a tiny bit of HTML. This post will talk about the client side, which, alas, is mostly JavaScript, not Go.</p> 
       <h3 id="javascript-in-2017">JavaScript in 2017</h3> 
       <p>This is what gave me the most grief. I don’t really know how to categorize the mess that present day JavaScript is, nor do I really know what to attribute it to, and trying to rationalize it would make for a great, but entirely different blog post. So I’m just going to accept this as the reality we cannot change and move on to how to best work with it.</p> 
       <h3 id="variants-of-js">Variants of JS</h3> 
       <p>The most common variant of JS these days is known as ES2015 (aka ES6 or ECMAScript 6th Edition), and it is <em>mostly</em> supported by the more or less latest browsers. The latest released spec of JavaScript is ES7 (aka ES2016), but since the browsers are sill catching up with ES6, it looks like ES7 is never really going to be adopted as such, because most likely the next coming ES8 which might be released in 2017 will supersede it before the browsers are ready.</p> 
       <p>Curiously, there appears to be no simple way to construct an environment fully specific to a particular ECMAScript version. There is not even a way to revert to an older fully supported version ES5 or ES4, and thus it is not really possible to test your script for compliance. The best you can do is to test it on the browsers you have access to and hope for the best.</p> 
       <p>Because of the ever changing and vastly varying support for the language across platforms and browsers, <em>transpilation</em> has emerged as a common idiom to address this. Transpilation mostly amounts to JavaScript code being converted to JavaScript that complies with a specific ES version or a particular environment. For example <code>import Bar from 'foo';</code> might become <code>var Bar = require('foo');</code>. And so if a particular feature is not supported, it can be made available with the help of the right plug-in or transpiler. I suspect that the transpilation proliferation phenomenon has led to additional problems, such as the input expected by a transpiler assuming existence of a feature that is no longer supported, same with output. Often this might be remedied by additional plugins, and it can be very difficult to sort out. On more than one occasion I spent a lot of time trying to get something to work only to find out later that my entire approach has been obsoleted by a new and better solution now built-in to some other tool.</p> 
       <h3 id="js-frameworks">JS Frameworks</h3> 
       <p>There also seems to be a lot of disagreement on which JS framework is best. It is even more confusing because the same framework can be so radically different from one version to the next I wonder why they didn’t just change the name.</p> 
       <p>I have no idea which is best, and I only had the patience to try a couple. About a year ago I spent a bunch of time tinkering with AngularJS, and this time, for a change, I tinkered with React. For me, I think React makes more sense, and so this is what this example app is using, for better or worse.</p> 
       <h3 id="react-and-jsx">React and JSX</h3> 
       <p>If you don’t know what React is, here’s my (technically incorrect) explanation: it’s HTML embedded in JavaScript. We’re all so brainwashed into JavaScript being embedded in HTML as the natural order of things, that inverting this relationship does not even occur as a possibility. For the fundamental simplicity of this revolutionary (sic) concept I think React is quite brilliant.</p> 
       <p>A react “Hello World!” looks approximately like this:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td>
              <td class="code"><pre><code class="javascript"><span class="line"><span class="kr">class</span> <span class="nx">Hello</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span> </span><span class="line"> <span class="nx">render</span><span class="p">()</span> <span class="p">{</span> </span><span class="line"> <span class="kd">let</span> <span class="nx">who</span> <span class="o">=</span> <span class="s2">"World"</span><span class="p">;</span> </span><span class="line"> <span class="k">return</span> <span class="p">(</span> </span><span class="line"> <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span> <span class="nx">Hello</span> <span class="p">{</span><span class="nx">who</span><span class="p">}</span><span class="o">!</span> <span class="o">&lt;</span><span class="err">/h1&gt;</span> </span><span class="line"> <span class="p">);</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Notice how the HTML just begins without any escape or delimiter. Surprisingly, the opening “&lt;” works quite reliably as the marker signifying beginning of HTML. Once inside HTML, the opening curly brace indicates that we’re back to JavaScript temporarily, and this is how variable values are interpolated inside HTML. That’s pretty much all you need to know to “get” React.</p> 
       <p>Technically, the above file format is known as <code>JSX</code>, while React is the library which provides the classes used to construct React objects such as <code>React.Component</code> above. JSX is transpiled into regular JavaScript by a tool known as Babel, and in fact JSX is not even required, a React component can be written in plain JavaScript, and there is a school of thought whereby React is used without JSX. I personally find the JSX-less approach a little too noisy, and I also like that Babel allows you to use a more modern dialect of JS (though not having to deal with a transpiler is definitely a win).</p> 
       <h3 id="minimal-working-example">Minimal Working Example</h3> 
       <p>First, we need three pieces of external JavaScript. They are (1) React and ReactDOM, (2) Babel in-browser transpiler and (3) a little lib called Axios which is useful for making JSON HTTP requests. I get them out of Cloudflare CDN, there are probably other ways. To do this, we need to augment our <code>indexHTML</code> variable to look like this:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kd">const</span> <span class="p">(</span> </span><span class="line"> <span class="nx">cdnReact</span> <span class="p">=</span> <span class="s">"https://cdnjs.cloudflare.com/ajax/libs/react/15.5.4/react.min.js"</span> </span><span class="line"> <span class="nx">cdnReactDom</span> <span class="p">=</span> <span class="s">"https://cdnjs.cloudflare.com/ajax/libs/react/15.5.4/react-dom.min.js"</span> </span><span class="line"> <span class="nx">cdnBabelStandalone</span> <span class="p">=</span> <span class="s">"https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.24.0/babel.min.js"</span> </span><span class="line"> <span class="nx">cdnAxios</span> <span class="p">=</span> <span class="s">"https://cdnjs.cloudflare.com/ajax/libs/axios/0.16.1/axios.min.js"</span> </span><span class="line"><span class="p">)</span> </span><span class="line"> </span><span class="line"><span class="kd">const</span> <span class="nx">indexHTML</span> <span class="p">=</span> <span class="s">`</span> </span><span class="line"><span class="s">&lt;!DOCTYPE HTML&gt;</span> </span><span class="line"><span class="s">&lt;html&gt;</span> </span><span class="line"><span class="s"> &lt;head&gt;</span> </span><span class="line"><span class="s"> &lt;meta charset="utf-8"&gt;</span> </span><span class="line"><span class="s"> &lt;title&gt;Simple Go Web App&lt;/title&gt;</span> </span><span class="line"><span class="s"> &lt;/head&gt;</span> </span><span class="line"><span class="s"> &lt;body&gt;</span> </span><span class="line"><span class="s"> &lt;div id='root'&gt;&lt;/div&gt;</span> </span><span class="line"><span class="s"> &lt;script src="`</span> <span class="o">+</span> <span class="nx">cdnReact</span> <span class="o">+</span> <span class="s">`"&gt;&lt;/script&gt;</span> </span><span class="line"><span class="s"> &lt;script src="`</span> <span class="o">+</span> <span class="nx">cdnReactDom</span> <span class="o">+</span> <span class="s">`"&gt;&lt;/script&gt;</span> </span><span class="line"><span class="s"> &lt;script src="`</span> <span class="o">+</span> <span class="nx">cdnBabelStandalone</span> <span class="o">+</span> <span class="s">`"&gt;&lt;/script&gt;</span> </span><span class="line"><span class="s"> &lt;script src="`</span> <span class="o">+</span> <span class="nx">cdnAxios</span> <span class="o">+</span> <span class="s">`"&gt;&lt;/script&gt;</span> </span><span class="line"><span class="s"> &lt;script src="/js/app.jsx" type="text/babel"&gt;&lt;/script&gt;</span> </span><span class="line"><span class="s"> &lt;/body&gt;</span> </span><span class="line"><span class="s">&lt;/html&gt;</span> </span><span class="line"><span class="s">`</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>At the very end it now loads <code>"/js/app.jsx"</code> which we need to accommodate as well. Back in part 1 we created a UI config variable called <code>cfg.Assets</code> using <code>http.Dir()</code>. We now need to wrap it in a handler which serves files, and Go conveniently provides one:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"> <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">"/js/"</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileServer</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Assets</span><span class="p">))</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>With the above, all the files in <code>"assets/js"</code> become available under <code>"/js/"</code>.</p> 
       <p>Finally we need to create the <code>assets/js/app.jsx</code> file itself:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="nx">class</span> <span class="nx">Hello</span> <span class="nx">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span> </span><span class="line"> <span class="nx">render</span><span class="p">()</span> <span class="p">{</span> </span><span class="line"> <span class="nx">let</span> <span class="nx">who</span> <span class="p">=</span> <span class="s">"World"</span><span class="p">;</span> </span><span class="line"> <span class="k">return</span> <span class="p">(</span> </span><span class="line"> <span class="p">&lt;</span><span class="nx">h1</span><span class="p">&gt;</span> <span class="nx">Hello</span> <span class="p">{</span><span class="nx">who</span><span class="p">}!</span> <span class="p">&lt;</span><span class="o">/</span><span class="nx">h1</span><span class="p">&gt;</span> </span><span class="line"> <span class="p">);</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"><span class="p">}</span> </span><span class="line"> </span><span class="line"><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="p">&lt;</span><span class="nx">Hello</span><span class="o">/</span><span class="p">&gt;,</span> <span class="nx">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s">"#root"</span><span class="p">));</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>The only difference from the previous listing is the very last line, which is what makes the app actually render itself.</p> 
       <p>If we now hit the index page from a (JS-capable) browser, we should see a “Hello World”.</p> 
       <p>What happened was that the browser loaded “app.jsx” as it was instructed, but since “jsx” is not a file type it is familiar with, it simply ignored it. When Babel got its chance to run, it scanned our document for any script tags referencing “text/babel” as its type, and re-requested those pages (which makes them show up twice in developer tools, but the second request ought to served entirely from browser cache). It then transpiled it to valid JavaScript and executed it, which in turn caused React to actually render the “Hello World”.</p> 
       <h3 id="listing-people">Listing People</h3> 
       <p>We need to first go back to the server side and create a URI that lists people. In order for that to happen, we need an http handler, which might look like this:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">peopleHandler</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> <span class="nx">people</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">People</span><span class="p">()</span> </span><span class="line"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">"This is an error"</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">)</span> </span><span class="line"> <span class="k">return</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> </span><span class="line"> <span class="nx">js</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">people</span><span class="p">)</span> </span><span class="line"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> </span><span class="line"> <span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">"This is an error"</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">)</span> </span><span class="line"> <span class="k">return</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> </span><span class="line"> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">js</span><span class="p">))</span> </span><span class="line"> <span class="p">})</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>And we need to register it:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"> <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">"/people"</span><span class="p">,</span> <span class="nx">peopleHandler</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Now if we hit <code>"/people"</code>, we should get a <code>"[]"</code> in response. If we insert a record into our people table with something along the lines of:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td>
              <td class="code"><pre><code class="sql"><span class="line"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">people</span> <span class="p">(</span><span class="k">first</span><span class="p">,</span> <span class="k">last</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">'John'</span><span class="p">,</span> <span class="s1">'Doe'</span><span class="p">);</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>The response should change to <code>[{"Id":1,"First":"John","Last":"Doe"}]</code>.</p> 
       <p>Finally we need to hook up our React/JSX code to make it all render.</p> 
       <p>For this we are going to create a <code>PersonItem</code> component, and another one called <code>PeopleList</code> which will use <code>PersonItem</code>.</p> 
       <p>A <code>PersonItem</code> only needs to know how to render itself as a table row:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td>
              <td class="code"><pre><code class="javascript"><span class="line"><span class="kr">class</span> <span class="nx">PersonItem</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span> </span><span class="line"> <span class="nx">render</span><span class="p">()</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="p">(</span> </span><span class="line"> <span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;</span> </span><span class="line"> <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span> <span class="o">&lt;</span><span class="err">/td&gt;</span> </span><span class="line"> <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">first</span><span class="p">}</span> <span class="o">&lt;</span><span class="err">/td&gt;</span> </span><span class="line"> <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">last</span><span class="p">}</span> <span class="o">&lt;</span><span class="err">/td&gt;</span> </span><span class="line"> <span class="o">&lt;</span><span class="err">/tr&gt;</span> </span><span class="line"> <span class="p">);</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>A <code>PeopleList</code> is slightly more complicated:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td>
              <td class="code"><pre><code class="javascript"><span class="line"><span class="kr">class</span> <span class="nx">PeopleList</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span> </span><span class="line"> <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span> </span><span class="line"> <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">people</span><span class="o">:</span> <span class="p">[]</span> <span class="p">};</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> </span><span class="line"> <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span> </span><span class="line"> <span class="k">this</span><span class="p">.</span><span class="nx">serverRequest</span> <span class="o">=</span> </span><span class="line"> <span class="nx">axios</span> </span><span class="line"> <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/people"</span><span class="p">)</span> </span><span class="line"> <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> </span><span class="line"> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="nx">people</span><span class="o">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span> <span class="p">});</span> </span><span class="line"> <span class="p">});</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> </span><span class="line"> <span class="nx">render</span><span class="p">()</span> <span class="p">{</span> </span><span class="line"> <span class="kr">const</span> <span class="nx">people</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">people</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">person</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="p">(</span> </span><span class="line"> <span class="o">&lt;</span><span class="nx">PersonItem</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">i</span><span class="p">}</span> <span class="nx">id</span><span class="o">=</span><span class="p">{</span><span class="nx">person</span><span class="p">.</span><span class="nx">Id</span><span class="p">}</span> <span class="nx">first</span><span class="o">=</span><span class="p">{</span><span class="nx">person</span><span class="p">.</span><span class="nx">First</span><span class="p">}</span> <span class="nx">last</span><span class="o">=</span><span class="p">{</span><span class="nx">person</span><span class="p">.</span><span class="nx">Last</span><span class="p">}</span> <span class="o">/&gt;</span> </span><span class="line"> <span class="p">);</span> </span><span class="line"> <span class="p">});</span> </span><span class="line"> </span><span class="line"> <span class="k">return</span> <span class="p">(</span> </span><span class="line"> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span> </span><span class="line"> <span class="o">&lt;</span><span class="nx">table</span><span class="o">&gt;&lt;</span><span class="nx">tbody</span><span class="o">&gt;</span> </span><span class="line"> <span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="nx">Id</span><span class="o">&lt;</span><span class="err">/th&gt;&lt;th&gt;First&lt;/th&gt;&lt;th&gt;Last&lt;/th&gt;&lt;/tr&gt;</span> </span><span class="line"> <span class="p">{</span><span class="nx">people</span><span class="p">}</span> </span><span class="line"> <span class="o">&lt;</span><span class="err">/tbody&gt;&lt;/table&gt;</span> </span><span class="line"> </span><span class="line"> <span class="o">&lt;</span><span class="err">/div&gt;</span> </span><span class="line"> <span class="p">);</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>It has a constructor which initializes a <code>this.state</code> variable. It also declared a <code>componentDidMount()</code> method, which React will call when the component is about to be rendered, making it the (or one of) correct place to fetch the data from the server. It fetches the data via an Axios call, and saves the result in <code>this.state.people</code>. Finally, <code>render()</code> iterates over the contents of <code>this.state.people</code> creating an instance of <code>PersonItem</code> for each.</p> 
       <p>That’s it, our app now responds with a (rather ugly) table listing people from our database.</p> 
       <h3 id="conclusion">Conclusion</h3> 
       <p>In essence, this is all you need to know to make a fully functional Web App in Go. This app has a number of shortcomings, which I will hopefully address later. For example in-browser transpilation is not ideal, though it might be fine for a low volume internal app where page load time is not important, so we might want to have a way to pre-transpile it ahead of time. Also our JSX is confined to a single file, this might get hard to manage for any serious size app where there are lots of components. The app has no navigation. There is no styling. There are probably things I’m forgetting about…</p> 
       <p>Enjoy!</p> 
       <p>P.S. Complete code is <a href="https://github.com/grisha/gowebapp">here</a></p> 
       <p>Continued in <a href="/blog/2017/04/27/go-web-app-part-4/">part 4</a>…</p> 
      </div> 
     </article> 
     <article> 
      <header> 
       <h1 class="entry-title"><a href="/blog/2017/04/27/go-web-app-part-4/">Building a Go Web App - Part 4</a></h1> 
       <p class="meta"> <time datetime="2017-04-27T09:13:00-04:00" pubdate data-updated="true">Apr 27<span>th</span>, 2017</time> | <a href="/blog/2017/04/27/go-web-app-part-4/#disqus_thread">Comments</a> </p> 
      </header> 
      <div class="entry-content">
       <p>This is part 4. See <a href="/blog/2017/04/27/simplistic-go-web-app/">part 1</a>, <a href="/blog/2017/04/27/simplistic-go-web-app-part-2/">part 2</a> and <a href="/blog/2017/04/27/go-web-app-part-3/">part 3</a>.</p> 
       <p>In this part I will try to briefly go over the missing pieces in our very simplistic Go Web App.</p> 
       <h3 id="http-handler-wrappers">HTTP Handler Wrappers</h3> 
       <p>I tiny rant: I do not like the word “middleware”. The concept of a wrapper has been around since the dawn of computing, there is no need to invent new words for it.</p> 
       <p>Having that out of the way, let’s say we need to require authentication for a certain URL. This is what our index handler presently looks like:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">indexHandler</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">indexHTML</span><span class="p">)</span> </span><span class="line"> <span class="p">})</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>We could write a function which takes an <code>http.Handler</code> as an argument and returns a (different) <code>http.Handler</code>. The returned handler checks whether the user is authenticated with <code>m.IsAuthenticated()</code> (whatever it does is not important here) and redirects the user to a login page, or executes the original handler by calling its <code>ServeHTTP()</code> method.</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="nx">requireLogin</span><span class="p">(</span><span class="nx">h</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">,</span> <span class="nx">m</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span> </span><span class="line"> <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> <span class="k">if</span> <span class="p">!</span><span class="nx">m</span><span class="p">.</span><span class="nx">IsAuthenticated</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span> </span><span class="line"> <span class="nx">http</span><span class="p">.</span><span class="nx">Redirect</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">loginURL</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusFound</span><span class="p">)</span> </span><span class="line"> <span class="k">return</span> </span><span class="line"> <span class="p">}</span> </span><span class="line"> <span class="nx">h</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> </span><span class="line"> <span class="p">})</span> </span><span class="line"><span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Given the above, the function registration now would look like this:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"> <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="nx">requireLogin</span><span class="p">(</span><span class="nx">indexHandler</span><span class="p">(</span><span class="nx">m</span><span class="p">)),</span> <span class="nx">m</span><span class="p">)</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>Handlers can be wrapped this way in as many layers as needed and this approach is very flexible. Anything from setting headers to compressing output can be accomplished via a wrapper. Note also that we can pass in whatever arguments we need, for example our <code>*model.Model</code>.</p> 
       <h3 id="url-parameters">URL Parameters</h3> 
       <p>Sooner or later we might want to rely on URL parameters, e.g. <code>/person/3</code> where <code>3</code> is a person id. Go standard library doesn’t provide any support for this leaving it as an exercise for the developer. The software component responsible for this sort of thing is known as a <a href="https://golang.org/pkg/net/http/#ServeMux">Mux</a> or “router” and it can be replaced by a custom implementation. A Mux also provides a <code>ServeHTTP()</code> method which means it satisfies the <code>http.Handler</code> interface, i.e. it is a handler.</p> 
       <p>A very popular implementation is the <a href="https://github.com/gorilla/mux">Gorilla Mux</a>. It is easy to delegate entire sub-urls to the Gorilla Mux wherever more flexibility is needed. For example we can decide that everything from <code>/person</code> and below is handled by an instance of a Gorilla router <em>and</em> we want that to be all authenticated, which might look like this:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"> <span class="c1">// import "github.com/gorilla/mux"</span> </span><span class="line"> <span class="nx">pr</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">NewRouter</span><span class="p">().</span><span class="nx">PathPrefix</span><span class="p">(</span><span class="s">"/person"</span><span class="p">).</span><span class="nx">Subrouter</span><span class="p">()</span> </span><span class="line"> <span class="nx">pr</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">"/{id}"</span><span class="p">,</span> <span class="nx">personGetHandler</span><span class="p">(</span><span class="nx">m</span><span class="p">)).</span><span class="nx">Methods</span><span class="p">(</span><span class="s">"GET"</span><span class="p">)</span> </span><span class="line"> <span class="nx">pr</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="nx">personPostHandler</span><span class="p">(</span><span class="nx">m</span><span class="p">)).</span><span class="nx">Methods</span><span class="p">(</span><span class="s">"POST"</span><span class="p">)</span> </span><span class="line"> <span class="nx">pr</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">"/{id}"</span><span class="p">,</span> <span class="nx">personPutHandler</span><span class="p">(</span><span class="nx">m</span><span class="p">)).</span><span class="nx">Methods</span><span class="p">(</span><span class="s">"PUT"</span><span class="p">)</span> </span><span class="line"> <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">"/person/"</span><span class="p">,</span> <span class="nx">requireLogin</span><span class="p">(</span><span class="nx">pr</span><span class="p">))</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>NB: I found that trailing slashes are important and the rules on when they are required are a bit confusing.</p> 
       <p>There are many other router/mux implementations out there, the beauty of not buying into any kind of a framework is that we can choose the one that works best for us or write our own (they are not difficult to implement).</p> 
       <h3 id="asset-handling">Asset Handling</h3> 
       <p>One of the neatest things about Go is that a compiled program is a single binary not a big pile of files like it is with most scripting languages and even compiled ones. But if our program relies on assets (JS, CSS, image and other files), we would need to copy those over to the server at deployment time.</p> 
       <p>There is a way we can preserve the “one binary” characteristic of our program by including assets as part of the binary itself. For that there is the <a href="https://github.com/jteeuwen/go-bindata/">go-bindata</a> project and its nephew <a href="github.com/elazarl/go-bindata-assetfs">go-bindata-assetfs</a>.</p> 
       <p>Since packing assets into the binary is slightly beyond what <code>go build</code> can accomplish, we will need some kind of a script to take care of it. My personal preference is to use the tried and true <code>make</code>, and it is not uncommon to see Go projects come with a <code>Makefile</code>.</p> 
       <p>Here is a relevant example Makefile rule</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td>
              <td class="code"><pre><code class="sh"><span class="line"><span class="nv">ASSETS_DIR</span> <span class="o">=</span> <span class="s2">"assets"</span> </span><span class="line">build: </span><span class="line"> @export <span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$$</span><span class="o">{</span>GOPATH-~/go<span class="o">}</span> <span class="o">&amp;&amp;</span> <span class="se">\</span> </span><span class="line"> go get github.com/jteeuwen/go-bindata/... github.com/elazarl/go-bindata-assetfs/... <span class="o">&amp;&amp;</span> <span class="se">\</span> </span><span class="line"> <span class="nv">$$</span>GOPATH/bin/go-bindata -o bindata.go -tags builtinassets <span class="k">${</span><span class="nv">ASSETS_DIR</span><span class="k">}</span>/... <span class="o">&amp;&amp;</span> <span class="se">\</span> </span><span class="line"> go build -tags builtinassets -ldflags <span class="s2">"-X main.builtinAssets=${ASSETS_DIR}"</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>The above rule creates a <code>bindata.go</code> file which will be placed in the same directory where <code>main.go</code> is and becomes part of package <code>main</code>. <code>main.go</code> will somehow know that assets are built-in and this is accomplished via an <code>-ldflags "-X main.builtinAssets=${ASSETS_DIR}"</code> trick, which is a way to assign values to variables at compile time. This means that our code can now check for the value of <code>builtinAssets</code> to decide what to do, e.g.:</p> 
       <div class="bogus-wrapper">
        <notextile>
         <figure class="code"> 
          <div class="highlight">
           <table>
            <tbody>
             <tr>
              <td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td>
              <td class="code"><pre><code class="go"><span class="line"> <span class="k">if</span> <span class="nx">builtinAssets</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">{</span> </span><span class="line"> <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"Running with builtin assets."</span><span class="p">)</span> </span><span class="line"> <span class="nx">cfg</span><span class="p">.</span><span class="nx">UI</span><span class="p">.</span><span class="nx">Assets</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">assetfs</span><span class="p">.</span><span class="nx">AssetFS</span><span class="p">{</span><span class="nx">Asset</span><span class="p">:</span> <span class="nx">Asset</span><span class="p">,</span> <span class="nx">AssetDir</span><span class="p">:</span> <span class="nx">AssetDir</span><span class="p">,</span> <span class="nx">AssetInfo</span><span class="p">:</span> <span class="nx">AssetInfo</span><span class="p">,</span> <span class="nx">Prefix</span><span class="p">:</span> <span class="nx">builtinAssets</span><span class="p">}</span> </span><span class="line"> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> </span><span class="line"> <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">"Assets served from %q."</span><span class="p">,</span> <span class="nx">assetsPath</span><span class="p">)</span> </span><span class="line"> <span class="nx">cfg</span><span class="p">.</span><span class="nx">UI</span><span class="p">.</span><span class="nx">Assets</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Dir</span><span class="p">(</span><span class="nx">assetsPath</span><span class="p">)</span> </span><span class="line"> <span class="p">}</span> </span></code></pre></td>
             </tr>
            </tbody>
           </table>
          </div>
         </figure>
        </notextile>
       </div> 
       <p>The second important thing is that we are defining a <a href="https://dave.cheney.net/2013/10/12/how-to-use-conditional-compilation-with-the-go-build-tool">build tag</a> called <code>builtinassets</code>. We are also telling <code>go-bindata</code> about it, what this means is “only compile me when builtinassets is set”, and this controls under which circumstances <code>bindata.go</code> (which contains our assets as Go code) is to actually be compiled.</p> 
       <h3 id="pre-transpilation-of-javascript">Pre-transpilation of JavaScript</h3> 
       <p>Last, but not the least, I want to briefly mention packing of web assets. To describe it properly is enough material for a whole new series of posts, and this would really have nothing to do with Go. But I can at least list the following points.</p> 
       <ul> 
        <li> <p>You might as well give in and install <a href="https://www.npmjs.com/">npm</a>, and make a <code>package.json</code> file.</p> </li> 
        <li> <p>Once npm is installed, it is trivial to install the Babel command-line compiler, <code>babel-cli</code>, which is one way to transpile JavaScript.</p> </li> 
        <li> <p>A more complicated, frustrating, but ultimately more flexible method is to use <a href="https://webpack.github.io/">webpack</a>. Webpack will pre-transpile and do things like combine all JS into a single file as well as minimize it.</p> </li> 
        <li> <p>I was surprised by how difficult it was to provide module import functionality in JavaScript. The problem is that there is an ES6 standard for <code>import</code> and <code>export</code> keywords, but there is no implementation, and even Babel assumes that something else implements it for you. In the end I settled on <a href="https://github.com/systemjs/systemjs">SystemJS</a>. The complication with SystemJS is that now in-browser Babel transpilation needs to be something that SystemJS is aware of, so I had to use its Babel plugin for that. Webpack in turn (I think?) provides its own module support implementation, so SystemJS is not needed when assets are packed. Anyhow, it was all rather frustrating.</p> </li> 
       </ul> 
       <h2 id="conclusion">Conclusion</h2> 
       <p>I would say that in the set up I describe in this four part series Go absolutely shines, while JavaScript not so much. But once I got over the initial hurdle of getting it all to work, React/JSX was easy and perhaps even pleasant to work with.</p> 
       <p>That’s it for now, hope you find this useful.</p> 
      </div> 
     </article> 
     <article> 
      <header> 
       <h1 class="entry-title"><a href="/blog/2017/03/22/tgres-0-dot-10-dot-0b-time-series-with-go-and-postgresql/">Tgres 0.10.0b - Time Series With Go and PostgreSQL</a></h1> 
       <p class="meta"> <time datetime="2017-03-22T13:52:00-04:00" pubdate data-updated="true">Mar 22<span>nd</span>, 2017</time> | <a href="/blog/2017/03/22/tgres-0-dot-10-dot-0b-time-series-with-go-and-postgresql/#disqus_thread">Comments</a> </p> 
      </header> 
      <div class="entry-content">
       <p>After nearly two years of hacking, I am tagging this version of <a href="https://github.com/tgres/tgres">Tgres</a> as beta. It is functional and stable enough for people to try out and not feel like they are wasting their time. There is still a lot that could and should be improved, but at this point the most important thing is to get more people to check it out.</p> 
       <h3 id="what-is-tgres">What is Tgres?</h3> 
       <p>Tgres is a <a href="https://golang.org">Go</a> program which can receive time series data via <a href="https://graphiteapp.org/">Graphite</a>, <a href="https://github.com/etsy/statsd/wiki">Statsd</a> protocols or an http <a href="https://godoc.org/github.com/tgres/tgres/http#PixelHandler">pixel</a>, store it in <a href="https://www.postgresql.org/">PostgreSQL</a>, and provide Graphite-like access to the data in a way that is compatible with tools such as <a href="https://grafana.com/">Grafana</a>. You could think of it as a drop-in Graphite/Statsd replacement, though I’d rather avoid direct comparison, because the key feature of Tgres is that data is stored in PostgreSQL.</p> 
       <p><a href="/blog/2017/02/28/tgres-load-testing-follow-up/"><img src="/images/tgres_load_head_01.png"></a></p> 
       <h3 id="why-postgresql">Why PostgreSQL?</h3> 
       <p>The “grand vision” for Tgres begins with the database. Relational databases have the most man-decades of any storage type invested into them, and PostgreSQL is probably the most advanced implementation presently in existence.</p> 
       <p>If you search for “relational databases and time series” (or some variation thereupon), you will come across the whole gamut of opinions (if not convictions) varying so widely it is but discouraging. This is because time series storage, while simple at first glance, is actually fraught with subtleties and ambiguities that can drive even the most patient of us up the wall.</p> 
       <h3 id="avoid-solving-the-storage-problem">Avoid Solving the Storage Problem.</h3> 
       <p>Someone once said that “anything is possible when you don’t know what you’re talking about”, and nowhere is it more evident than in data storage. File systems and relational databases trace their origin back to the late 1960s and over half a century later I doubt that any field experts would say “the storage problem is solved”. And so it seems almost foolish to suppose that by throwing together a key-value store and a concensus algorithm or some such it is possible to come up with something <em>better</em>? Instead of re-inventing storage, why not focus on how to structure the data in a way that is compatible with a storage implementation that we know works and scales reliably?</p> 
       <p>As part of the Tgres project, I thought it’d be interesting to get to the bottom of this. If not bottom, then at least deeper than most people dare to dive. I am not a mathematician or a statistician, nor am I a data scientist, whatever that means, but I think I understand enough about the various subjects involved, including programming, that I can come up with something more than just another off-the-cuff opinion.</p> 
       <p>And so now I think I can conclude definitively that time series data can be stored in a relational database very efficently, PostgreSQL in particular for its support for <a href="https://www.postgresql.org/docs/current/static/arrays.html">arrays</a>. The general approach I described in a series of blogs starting with <a href="/blog/2015/09/23/storing-time-series-in-postgresql-efficiently/">this one</a>, Tgres uses the technique described in the <a href="/blog/2017/01/21/storing-time-seris-in-postgresql-optimize-for-write/">last one</a>. In my <a href="/blog/2017/02/28/tgres-load-testing-follow-up/">performance tests</a> the Tgres/Postgres combination was so efficient it was possibly outperforming its time-series <a href="http://obfuscurity.com/2016/09/Benchmarking-Graphite-master-on-AWS">siblings</a>.</p> 
       <p>The good news is that as a user you don’t need to think about the complexities of the data layout, Tgres takes care of it. Still I very much wish people would take more time to think about how to organize data in a tried and true solution like PostgreSQL before jumping ship into the murky waters of the “noSQL” ocean, lured by alternative storage sirens, big on promise but shy on delivery, only to drown where no one could come to the rescue.</p> 
       <h3 id="how-else-is-tgres-different">How else is Tgres different?</h3> 
       <p>Tgres is a single program, a single binary which does everything (one of my favorite things about Go). It supports all of Graphite and Statsd protocols without having to run separate processes, there are no dependencies of any kind other than a PostgreSQL database. No need for Python, Node or a JVM, just the binary, the <a href="https://github.com/tgres/tgres/blob/v0.10.0b/etc/tgres.conf.sample">config file</a> and access to a database.</p> 
       <p>And since the data is stored in Postgres, virtually all of the features of Postgres are available: from being able to query the data using real SQL with all the latest features, to replication, security, performance, back-ups and whatever else Postgres offers.</p> 
       <p>Another benefit of data being in a database is that it can be accessible to any application frameworks in Python, Ruby or whatever other language as just another database table. For example in Rails it might be as trivial as <code>class Tv &lt; ActiveRecord::Base; end</code> et voilà, you have the data points as a model.</p> 
       <p>It should also be mentioned that Tgres requires no PostgreSQL extensions. This is because optimizing by implementing a custom extension which circumvents the PostgreSQL natural way of handling data means we are solving the storage problem again. PostgreSQL storage is not broken to begin with, no customization is necessary to handle time series.</p> 
       <p>In addition to being a standalone program, Tgres packages aim to be useful on their own as part of any other Go program. For example it is very easy to equip a Go application with Graphite capabilities by providing it access to a database and using the provided http <a href="https://godoc.org/github.com/tgres/tgres/http#GraphiteRenderHandler">handler</a>. This also means that you can use a separate Tgres instance dedicated to querying data (perhaps from a downstream Potgres slave).</p> 
       <h3 id="some-internals-overview">Some Internals Overview</h3> 
       <p>Internally, Tgres series identification is tag-based. The series are identified by a <a href="https://www.postgresql.org/docs/current/static/datatype-json.html">JSONB</a> field which is a set of key/value pairs indexed using a <a href="https://www.postgresql.org/docs/current/static/gin-intro.html">GIN index</a>. In Go, the JSONB field becomes a <a href="https://godoc.org/github.com/tgres/tgres/serde#Ident">serde.Ident</a>. Since the “outside” interface Tgres is presently mimicking is Graphite, which uses dot-separated series identifiers, all idents are made of just one tag “name”, but this will change as we expand the DSL.</p> 
       <p>Tgres stores data in evenly-spaced series. The conversion from the data as it comes in to its evenly-spaced form happens on-the-fly, using a <a href="/blog/2016/08/04/data-points/">weighted mean</a> method, and the resulting stored rate is actually correct. This is similar to how <a href="http://oss.oetiker.ch/rrdtool/">RRDTool</a> does it, but different from many other tools which simply discard all points except for last in the same series slot as I explained in <a href="/blog/2015/05/04/recording-time-series/">this post</a>.</p> 
       <p>Tgres maintains a (configurable) number of Round-Robin Archives (RRAs) of varying length and resolution for each series, this is an approach similar to RRDTool and Graphite Whisper as well. The conversion to evenly-spaced series happens in the <a href="https://godoc.org/github.com/tgres/tgres/rrd">rrd</a> package.</p> 
       <p>Tgres does not store the original (unevenly spaced) data points. The rationale behind this is that for analytical value you always inevitably have to convert an uneven series to a regular one. The problem of storing the original data points is not a time-seires problem, the main challenge there is the ability to keep up with a massive influx of data, and this is what Hadoop, Cassandra, S3, BigQuery, etc are excellent at.</p> 
       <p>While Tgres code implements most of the <a href="http://graphite.readthedocs.io/en/latest/functions.html">Graphite functions</a>, complete compatibility with the Graphite DSL is not a goal, and some functions will probably left uniplemented. In my opinion the Graphite DSL has a number of shortcomings by design. For example, the series names are not strings but are syntactically identifiers, i.e. there is no difference between <code>scale(foo.bar, 10)</code> and <code>scale("foo.bar", 10)</code>, which is problematic in more than one way. The dot-names are ingrained into the DSL, and lots of functions take arguments denoting position within the dot-names, but they seem unnecessary. For example there is <code>averageSeriesWithWildcards</code> and <code>sumSeriesWithWildcards</code>, while it would be cleaner to have some kind of a <code>wildcard()</code> function which can be passed into <code>average()</code> or <code>sum()</code>. Another example is that Graphite does not support chaining (but Tgres already does), e.g. <code>scale(average("foo.*"), 10)</code> might be better as <code>average("foo.*").scale(10)</code>. There are many more similar small grievances I have with the DSL, and in the end I think that the DSL ought to be revamped to be more like a real language (or perhaps just be a language, e.g. Go itself), exactly how hasn’t been crystalized just yet.</p> 
       <p>Tgres also aims to be a useful time-series processing Golang package (or a set of packages). This means that in Go the code also needs to be clean and readable, and that there ought to be a conceptual correspondence between the DSL and how one might to something at the lower level in Go. Again, the vision here is still blurry, and more thinking is required.</p> 
       <p>For Statsd functionality, the network protocol is supported by the <a href="https://godoc.org/github.com/tgres/tgres/statsd">tgres/statsd</a> package while the aggregation is done by the <a href="https://godoc.org/github.com/tgres/tgres/aggregator">tgres/aggregator</a>. In addition, there is also support for “paced metrics” which let you aggregate data <em>before</em> it is passed on to the Tgres receiver and becomes a data point, which is useful in situations where you have some kind of an iteration that would otherwise generate millions of measurements per second.</p> 
       <p>The finest resolution for Tgres is a millisecond. Nanoseconds seems too small to be practical, though it shouldn’t be too hard to change it, as internally Tgres uses native Go types for time and duration - the milliseconds are the integers in the database.</p> 
       <p>When the Data points are received via the network, the job of parsing the network stuff is done by the code in the <a href="https://godoc.org/github.com/tgres/tgres/daemon">tgres/daemon</a> package with some help from <a href="https://godoc.org/github.com/tgres/tgres/http">tgres/http</a> and <a href="https://godoc.org/github.com/tgres/tgres/statsd">tgres/statsd</a>, as well as potentially others (e.g. Python pickle decoding).</p> 
       <p>Once received and correctly parsed, they are passed on to the <a href="https://godoc.org/github.com/tgres/tgres/receiver">tgres/receiver</a>. The receiver’s job is to check whether this series ident is known to us by checking the cache or that it needs to be loaded from the database or created. Once the appropriate series is found, the receiver updates the in-memory cache of the <a href="https://godoc.org/github.com/tgres/tgres/rrd#RoundRobinArchive">RRAs</a> for the series (which causes the data points to be evenly spaced) as well as periodically flushes data points to the data base. The receiver also controls the <a href="https://godoc.org/github.com/tgres/tgres/aggregator">aggregator</a> of statsd metrics.</p> 
       <p>The database interface code is in the <a href="https://godoc.org/github.com/tgres/tgres/serde">tgres/serde</a> package which supports PostgreSQL or an in-memory database (useful in situations where persistence is not required or during testing).</p> 
       <p>When Tgres is queried for data, it loads it from the database into a variety of implementations of the Series interface in the <a href="https://godoc.org/github.com/tgres/tgres/series">tgres/series</a> package as controlled by the <a href="https://godoc.org/github.com/tgres/tgres/dsl">tgres/dsl</a> responsible for figuring out what is asked of it in the query.</p> 
       <p>In addition to all of the above, Tgres supports clustering, though this is highly experimental at this point. The idea is that a cluster of Tgres instances (all backed by the same database, at least for now) would split the series amongst themselves and forward data points to the node which is responsible for a particular series. The nodes are placed behind a load-balancer of some kind, and with this set up nodes can go in and out of the cluster without any overall downtime for maximum availability. The clustering logic lives in <a href="https://godoc.org/github.com/tgres/tgres/cluster">tgres/cluster</a>.</p> 
       <p>This is an overly simplistic overview which hopefully conveys that there are a lot of pieces to Tgres.</p> 
       <h2 id="future">Future</h2> 
       <p>In addition to a new/better DSL, there are lots of interesting ideas, and if you have any please chime in on Github.</p> 
       <p>One thing that is missing in the telemetry world is encryption, authentication and access control so that tools like Tgres could be used to store health data securely.</p> 
       <p>A useful feature might be interoperability with big data tools to store the original data points and perhaps provide means for pulling them out of BigQuery or whatever and replay them into series - this way we could change the resolution to anything at will.</p> 
       <p>Or little details like a series alias - so that a series could be renamed. The way this would work is you rename a series while keeping its old ident as an alias, then take your time to make sure all the agents send data under the new name, at which point the alias can go away.</p> 
       <p>Lots can also be done on the scalability front with improved clustering, sharding, etc.</p> 
       <h2 id="we-could-use-your-help">We Could Use Your Help</h2> 
       <p>Last but not least, this is an Open Source project. It works best when people who share the vision also contribute to the project, and this is where you come in. If you’re interested in learning more about time series and databases, please check it out and feel free to contribute in any way you can!</p> 
      </div> 
     </article> 
     <article> 
      <header> 
       <h1 class="entry-title"><a href="/blog/2017/02/28/tgres-load-testing-follow-up/">Tgres Load Testing Follow Up</a></h1> 
       <p class="meta"> <time datetime="2017-02-28T21:40:00-05:00" pubdate data-updated="true">Feb 28<span>th</span>, 2017</time> | <a href="/blog/2017/02/28/tgres-load-testing-follow-up/#disqus_thread">Comments</a> </p> 
      </header> 
      <div class="entry-content">
       <p>To follow up on the <a href="/blog/2017/02/23/can-tgres-outperform-graphite/">previous post</a>, after a bunch of tweaking, here is Tgres (<a href="https://github.com/tgres/tgres/commit/90924e4afa4ac8bef61caf46c3439794983660ec">commit</a>) receiving over 150,000 data points per second across 500,000 time series without any signs of the queue size or any other resource blowing up.</p> 
       <p>This is both Tgres and Postgres running on the same i2.2xlarge EC2 instance (8 cores, 64GB, SSD).</p> 
       <p><img src="/images/tgres_aws1_150k.png"></p> 
       <p>At this point I think there’s been enough load testing and optimization, and I am going to get back to crossing the t’s and dotting the i’s so that we can release the first version of Tgres.</p> 
      </div> 
     </article> 
     <div class="pagination"> 
      <a class="prev" href="/blog/page/2/">? Older</a> 
      <a href="/blog/archives">Blog Archives</a> 
     </div> 
    </div> 
    <aside class="sidebar"> 
     <section> 
      <!-- script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 200;
google_ad_height = 200;
google_ad_format = "200x200_as";
google_ad_type = "image";
//-->  
      <div style="text-align: center;"> 
       <div style="text-align: left; width: 200px; display: block; margin-left: auto; margin-right: auto;"> 
        <!-- script type="text/javascript"
            src="https://pagead2.googlesyndication.com/pagead/show_ads.js">
            </script --> 
       </div> 
      </div> 
     </section> 
     <section> 
      <p> <small>Google ads gone. Send me some crypto, TIA!</small><br><br> <tt><small>Bitcoin: 1GrishapUx3mofmQuTbL4JEEMdzGgeSEcu</small></tt><br> <tt><small>Litecoin: LXLGrXXQM2t5ckq4gmznsVzpRNhRVD1V8w</small></tt><br> </p> 
     </section> 
     <section> 
      <h1>About Me</h1> 
      <p> </p>
      <div style="width: 75%; margin: 0 auto;"> 
       <a href="https://twitter.com/humblehack" class="twitter-follow-button" data-show-count="">Follow @humblehack</a> 
      </div> 
      <p></p> 
      <p>I am currently a (Data) Hacker at <a href="http://voxmedia.com">Vox Media</a>.</p> 
      <p>Grisha is a common Russian short name for Gregory. It is pronounced more like Greesha.</p> 
      <p>Years ago I wrote <a href="http://modpython.org">mod_python</a>, which became a hugely succesful OSS Project and is still in use by millions of sites.</p> 
      <p>I am a former VP and member emeritus of the <a href="http://apache.org">Apache Software Foundation</a>.</p> 
      <p>I started programming professionally back when I was a teenager. I’ve spent most of my early career working at large ISP’s solving industrial-scale hosting challenges. Since around 2009 I’ve become more intersted in and now work exclusively on data infrastuctre, both big and small, but mostly big.</p> 
      <p>I was born and grew up in Moscow, Russia, though I’ve lived in the Washington, DC (USA) area for more than half of my life now. Our kids were born and go to school here, it’s gradually become home for us.</p> 
     </section> 
     <section> 
      <h1>Recent Posts</h1> 
      <ul id="recent_posts"> 
       <li class="post"> <a href="/blog/2017/09/28/electricity-cost-of-1-bitcoin/">Electricity cost of 1 Bitcoin (Sep 2017)</a> </li> 
       <li class="post"> <a href="/blog/2017/09/25/bitcoin-value-2/">Bitcoin: USD Value</a> </li> 
       <li class="post"> <a href="/blog/2017/09/22/bitcoin-value/">Bitcoin: Better Ink than Gold?</a> </li> 
       <li class="post"> <a href="/blog/2017/07/04/tgres-status-july-2017/">Tgres Status - July 4th 2017</a> </li> 
       <li class="post"> <a href="/blog/2017/04/27/simplistic-go-web-app/">Building a Go Web App in 2017</a> </li> 
      </ul> 
     </section> 
    </aside> 
   </div> 
  </div> 
  <footer role="contentinfo">
   <p> <img src="https://www.ispol.com/grisha_org.gif" height="1" width="1"> Copyright © 2017 - Gregory Trubetskoy - <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> </p> 
  </footer> 
  <script type="text/javascript">
      var disqus_shortname = 'grisha';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script> 
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>   
 </body>
</html>