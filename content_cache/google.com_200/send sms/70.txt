<!doctype html>
<html>
 <head> 
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"> 
  <title>StrongLoop - Two-Factor Authentication with LoopBack </title> 
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,300italic,400italic,500italic"> 
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu+Mono"> 
  <!--
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
    --> 
  <link rel="stylesheet" href="https://strongloop.com/css/font-awesome.min.css"> 
  <!-- link rel="stylesheet" href="https://strongloop.com/css/prism.css" --> 
  <link rel="stylesheet" href="https://strongloop.com/css/main.css"> 
  <link rel="stylesheet" href="https://strongloop.com/css/customstyles.css"> 
  <link rel="stylesheet" href="https://strongloop.com/css/syntax.css"> 
  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css"> 
  <script src="//code.jquery.com/jquery-1.10.2.min.js"></script> 
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-placeholder/2.0.7/jquery.placeholder.min.js"></script> 
  <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/0.6.11/fastclick.min.js"></script> 
  <script src="https://strongloop.com/js/prism.js"></script>
  <script>$('input, textarea').placeholder();</script> 
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/r29/html5.min.js"></script><![endif]--> 
  <script src="https://strongloop.com/js/main.js"></script> 
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script> 
  <link rel="shortcut icon" href="https://strongloop.com/favicon.ico"> 
  <link rel="alternate" type="application/rss+xml" title="StrongLoop RSS" href="https://strongloop.com/feed.xml"> 
 </head> 
 <body class="js-body"> 
  <div class="c-wrapper js-wrapper"> 
   <header class="c-masthead"> 
    <div class="c-container x-flex-v js-masthead-container"> 
     <a href="https://strongloop.com" class="_logo x-flex-v no_icon"></a> 
     <nav class="_nav js-masthead-nav"> 
      <ul class="_nav-list js-nav-list"> 
       <li class="_nav-item "> <a class="no_icon" href="https://strongloop.com/projects/" title="Projects">Projects</a> </li> 
       <li class="_nav-item -active"> <a class="no_icon" href="https://strongloop.com/strongblog/" title="Blog">Blog</a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://strongloop.com/newsletter/" title="Newsletter">Newsletter</a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://strongloop.com/events/" title="Events">Events</a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://strongloop.com/faq/" title="FAQ">FAQ</a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://strongloop.com/about/" title="About">About</a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://twitter.com/StrongLoop"><i class="fa fa-twitter" aria-hidden="true"></i></a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://www.facebook.com/strongloop/"><i class="fa fa-facebook" aria-hidden="true"></i></a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://www.linkedin.com/groups/5046525"><i class="fa fa-linkedin" aria-hidden="true"></i></a> </li> 
       <li class="_nav-item no-foot"> <a class="no_icon" href="https://github.com/strongloop"><i class="fa fa-github" aria-hidden="true"></i></a> </li> 
      </ul> 
     </nav> 
     <button class="_menu js-menu"> <i class="fa fa-bars"></i> <span class="x-hide">Menu</span> </button> 
     <!--
    <iframe src="https://ghbtns.com/github-btn.html?user=strongloop&repo=loopback&type=follow" class="c-github-follow"></iframe> --> 
    </div> 
   </header> 
   <section class="c-section x-green"> 
    <div class="c-container -padded"> 
     <div class="c-grid"> 
      <div class="_col -col-1-1"> 
       <h1 class="c-heading -h1">Two-Factor Authentication with LoopBack</h1> 
       <p class="author">by <a class="no_icon" href="https://strongloop.com/authors/Jordan_Kasper">Jordan Kasper</a> </p> 
       <p class="post-meta"><time>Mar 3, 2015</time> / <a class="no_icon" href="https://strongloop.com/strongblog/tag_How-To.html">How-To</a>, <a class="no_icon" href="https://strongloop.com/strongblog/tag_LoopBack.html">LoopBack</a> </p> 
      </div> 
     </div> 
    </div> 
   </section> 
   <section class="c-section x-white"> 
    <div class="c-container"> 
     <div class="c-grid"> 
      <div class="_col -col-4-5 strictwidth"> 
       <div class="post-content"> 
        <div class="share"> 
         <!-- Load Facebook SDK for JavaScript --> 
         <div id="fb-root"></div> 
         <script>(function(d, s, id) {
                  var js, fjs = d.getElementsByTagName(s)[0];
                  if (d.getElementById(id)) return;
                  js = d.createElement(s); js.id = id;
                  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.9&appId=243237449414858";
                  fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));
                </script> 
         <div class="fb-share-button" data-href="https://strongloop.com//strongblog/two-factor-authentication-with-loopback/" data-layout="button_count" data-size="small" data-mobile-iframe="true">
          <a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://strongloop.com//strongblog/two-factor-authentication-with-loopback/%2F&amp;src=sdkpreparse">Share</a>
         </div> 
         <a class="twitter-share-button no_icon" href="https://twitter.com/share" data-size="large" data-text="Two-Factor Authentication with LoopBack" data-url="https://strongloop.com//strongblog/two-factor-authentication-with-loopback/" data-related="twitterapi,twitter"> <i class="fa fa-twitter" aria-hidden="true"></i> Tweet </a> 
         <a class="newshare-share-button no_icon linkedinshare" href="http://www.linkedin.com/shareArticle?mini=true&amp;url=https://strongloop.com//strongblog/two-factor-authentication-with-loopback/" target="_blank"> <i class="fa fa-linkedin" aria-hidden="true"></i> Share </a> 
         <a class="newshare-share-button no_icon redditshare" href="http://reddit.com/submit?url==https://strongloop.com//strongblog/two-factor-authentication-with-loopback/&amp;title=Two-Factor Authentication with LoopBack" target="_blank"> <i class="fa fa-reddit" aria-hidden="true"></i> Share </a> 
         <a class="newshare-share-button pinterestshare no_icon" href="javascript:void((function()%7Bvar%20e=document.createElement('script');e.setAttribute('type','text/javascript');e.setAttribute('charset','UTF-8');e.setAttribute('src','http://assets.pinterest.com/js/pinmarklet.js?r='+Math.random()*99999999);document.body.appendChild(e)%7D)());"> <i class="fa fa-pinterest" aria-hidden="true"></i> Share </a> 
         <a class="newshare-share-button tumblrshare no_icon" href="http://www.tumblr.com/share/link?url=https://strongloop.com//strongblog/two-factor-authentication-with-loopback/&amp;title=Two-Factor Authentication with LoopBack" target="_blank"> <i class="fa fa-tumblr" aria-hidden="true"></i> Share </a> 
        </div> 
        <p><a href="http://confoo.ca/en"><img class="alignright size-medium" src="https://strongloop.com/blog-assets/2015/02/confoo.gif" alt="Confoo"></a>Before I get into the code and walk you through it, I wanted to talk about my motivation for this post. I recently spoke at the <a href="http://confoo.ca">Confoo developer conference</a> in Montreal. If you haven’t been, it’s a whirlwind of <a href="http://confoo.ca/en/2015/session/the-future-is-now-javascript-es6-and-traceur">new technologies</a>, <a href="http://confoo.ca/en/2015/session/tracking-your-data-cross-the-fourth-dimension">complex data theories</a>, <a href="http://confoo.ca/en/2015/session/confessions-of-a-remote-worker">useful soft skills</a>, and <a href="http://confoo.ca/en/2015/session/a-rebasing-workflow-for-git">solid, practical information</a> for technologists of all sorts and levels. I’ve had the pleasure of attending (and speaking) the last two years and I always find an abundance of good information and good networking opportunities. This year was the first time that StrongLoop has had a presence, but given the contacts made with both users of <a href="http://loopback.io">LoopBack</a> and new potential partners like <a href="http://basho.com/riak/">Riak</a> and <a href="http://nexmo.com">Nexmo</a>, I hope we are able to go back next year.</p> 
        <blockquote> 
         <p><em>What’s LoopBack? It’s an open source framework for quickly building APIs in Node and getting them connected to data.</em></p> 
        </blockquote> 
        <p>Based on the frequency of sessions surrounding it and conversations in the hallways, I can confidently tell you that the big story was APIs. From code frameworks to authentication to monitoring, everyone is moving in that direction. Indeed, the popularity of our own Al Tsang’s <a href="http://www.slideshare.net/altsang/node-the-integration-fabric-of-the-future">presentation at Node Summit</a> has shown that momentum in the Node.js community and beyond. And Node is built well for just such a task.</p> 
        <h2 id="what-about-authentication"><strong>What about authentication?</strong></h2> 
        <p><img class="alignright size-medium" style="width: 25%;" src="https://strongloop.com/blog-assets/2014/04/api_security.png" alt="Lock">LoopBack already has <a href="http://docs.strongloop.com/display/public/LB/Authentication%2C+authorization%2C+and+permissions">authentication and authorization</a> baked in. There is a base `User` class that you can use directly or extend to suit your needs. Each model in LoopBack can also have a rich set of access control rules built in using the existing user roles. I’m not going to talk in depth about these mechanisms, but you can read more at the link above. Instead, I want to focus on some insights from one of the sessions at Confoo: <a href="http://confoo.ca/en/2015/session/the-beginner-s-guide-to-alternative-authorization">Chris Cornutt’s “Beginner’s Guide to Alternative Authorization”</a>.</p> 
        <p>You can review the <a href="https://speakerdeck.com/ccornutt/the-beginners-guide-to-alternative-authentication">slides from his talk on his SpeakerDeck page</a>, but let me give you the TL;DR version: There are a lot of different authentication mechanisms, and all of them have their own nuances, benefits, and issues. This session was just an overview of a lot of those mechanisms, but it got me thinking about the authentication built into LoopBack and how a developer might make that more secure using something like a multi-factor process.</p> 
        <p>So, without further ado, let’s see how we can extend the existing LoopBack User login system to use two-factor authentication with a time-based, sms-delivered code.</p> 
        <!--more--> 
        <h2 id="time-based-and-sms"><strong>Time Based and SMS</strong></h2> 
        <p><img class="alignright size-medium" src="https://strongloop.com/blog-assets/2013/07/sl_graphics__08.png" alt="mobile (sms)">There are certainly many enhanced authentication mechanisms, as Chris’ presentation demonstrates, but we need to focus on something widely applicable to web applications and something we can build in one blog post! With the abundance of SMS APIs out there, sending a time-based code should be simple. Why time-based? Well, we want the user to only be able to use this code as they’re logging in, so we want it to be useless after an appropriate amount of time (maybe 60 seconds?).</p> 
        <p>The basic login process will change from a simple email and password form entry to a 2.5 step process:</p> 
        <ol> 
         <li>User requests a two-factor code… 
          <ul> 
           <li>The user will enter their email and password, which will be verified.</li> 
           <li>The system will send a unique code to their mobile device.</li> 
          </ul> </li> 
         <li>The user must enter that code into the UI to complete the “log in” process.</li> 
        </ol> 
        <h2 id="ok-im-sold-how-do-i-implement-it"><strong>Ok, I’m sold… How do I implement it?</strong></h2> 
        <p>First, spin up a <a href="http://strongloop.com/get-started/">new LoopBack project</a> (you’ll need to have the StrongLoop controller installed: `npm install -g strongloop`):</p> 
        <div class="language-js highlighter-rouge">
         <pre class="highlight"><code><span class="o">~</span><span class="nx">$</span> <span class="nx">slc</span> <span class="nx">loopback</span>
</code></pre> 
        </div> 
        <p>Follow the prompts to create your application, then <a href="http://docs.strongloop.com/display/public/LB/Creating+models">create a new model</a> which extends the `User` class – I called mine “Employee”. Inside our new Employee model we’ll create two new <a href="http://docs.strongloop.com/display/public/LB/Extend+your+API">remote methods</a> for our 2(.5) step process. I’m going to skip straight to the methods themselves, but you can read about how to create them at the link in the last sentence.</p> 
        <p>Here is our function for requesting a new two-factor, time-limited code. Note that it does 3 basic things: find the user, check their password, and send them a code. I’ve left out a bunch of error handling, but you can see it in the <a href="https://github.com/strongloop/loopback-example-two-factor/blob/master/common/models/employee.js">example repository</a>. We’re also using the <a href="https://github.com/markbao/speakeasy">speakeasy library</a> to generate our tokens, so we’ll require that first (be sure to install it as a dependency: `npm install –save speakeasy`).</p> 
        <div class="language-js highlighter-rouge">
         <pre class="highlight"><code><span class="kd">var</span> <span class="nx">speakeasy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'speakeasy'</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Employee</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">Employee</span><span class="p">.</span><span class="nx">requestCode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">credentials</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">where</span><span class="p">:</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="nx">credentials</span><span class="p">.</span><span class="nx">email</span> <span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">user</span><span class="p">.</span><span class="nx">hasPassword</span><span class="p">(</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">isMatch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isMatch</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Note that you’ll want to change the secret to something a lot more secure!</span>
          <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">speakeasy</span><span class="p">.</span><span class="nx">totp</span><span class="p">({</span><span class="na">key</span><span class="p">:</span> <span class="s1">'APP_SECRET'</span> <span class="o">+</span> <span class="nx">credentials</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Two factor code for '</span> <span class="o">+</span> <span class="nx">credentials</span><span class="p">.</span><span class="nx">email</span> <span class="o">+</span> <span class="s1">': '</span> <span class="o">+</span> <span class="nx">code</span><span class="p">);</span>

          <span class="c1">// [TODO] hook into your favorite SMS API and send your user their code!</span>

          <span class="nx">fn</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">now</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'Sorry, but that email and password do not match!'</span><span class="p">);</span>
          <span class="nx">err</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">401</span><span class="p">;</span>
          <span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="s1">'LOGIN_FAILED'</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="p">};</span>
</code></pre> 
        </div> 
        <p>Once the user has been sent their time-limited verification code they will need an endpoint to submit it to in order to complete the login process. Keep in mind that this code expires quickly (30 seconds is the default for speakeasy), so our UI should be ready to accept the code right away (no fumbling through multiple pages!).</p> 
        <p>Again, in the example below I have left out a lot of audits for brevity in this blog post. Be sure to audit everything!</p> 
        <div class="language-js highlighter-rouge">
         <pre class="highlight"><code><span class="nx">Employee</span><span class="p">.</span><span class="nx">loginWithCode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">credentials</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'Sorry, but that verification code does not work!'</span><span class="p">);</span>
  <span class="nx">err</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">401</span><span class="p">;</span>
  <span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="s1">'LOGIN_FAILED'</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">where</span><span class="p">:</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="nx">credentials</span><span class="p">.</span><span class="nx">email</span> <span class="p">}</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// And don’t forget to match this secret to the one in requestCode()</span>
    <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">speakeasy</span><span class="p">.</span><span class="nx">totp</span><span class="p">({</span><span class="na">key</span><span class="p">:</span> <span class="s1">'APP_SECRET'</span> <span class="o">+</span> <span class="nx">credentials</span><span class="p">.</span><span class="nx">email</span><span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">!==</span> <span class="nx">credentials</span><span class="p">.</span><span class="nx">twofactor</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Everything looks good, so now we can create the access token, which</span>
    <span class="c1">// is used for all future API calls to authenticate the user.</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">createAccessToken</span><span class="p">(</span><span class="mi">86400</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">token</span><span class="p">.</span><span class="nx">__data</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
      <span class="nx">fn</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre> 
        </div> 
        <p>Great! We’re almost done with the server side of things. All we need to do is make those two new remote methods publicly available, otherwise you would have to be logged in to log in. : )</p> 
        <p>Open the generated `/common/models/employee.json` file and update the “acls” object to allow access from `$everyone` for both methods:</p> 
        <div class="language-js highlighter-rouge">
         <pre class="highlight"><code><span class="s2">"acls"</span><span class="err">:</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">"principalType"</span><span class="p">:</span> <span class="s2">"ROLE"</span><span class="p">,</span>
    <span class="s2">"principalId"</span><span class="p">:</span> <span class="s2">"$everyone"</span><span class="p">,</span>
    <span class="s2">"permission"</span><span class="p">:</span> <span class="s2">"ALLOW"</span><span class="p">,</span>
    <span class="s2">"property"</span><span class="p">:</span> <span class="s2">"requestCode"</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="s2">"principalType"</span><span class="p">:</span> <span class="s2">"ROLE"</span><span class="p">,</span>
    <span class="s2">"principalId"</span><span class="p">:</span> <span class="s2">"$everyone"</span><span class="p">,</span>
    <span class="s2">"permission"</span><span class="p">:</span> <span class="s2">"ALLOW"</span><span class="p">,</span>
    <span class="s2">"property"</span><span class="p">:</span> <span class="s2">"loginWithCode"</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre> 
        </div> 
        <h2 id="what-about-sms-integration"><strong>What about SMS integration?</strong></h2> 
        <p>You may have noticed that there is a `[TODO]` item in the `Employee.requestCode()` method to send that code via SMS to the user. I haven’t included that code because it will require some integration and account set up on your part. That said, many of the SMS and voice API companies have very simple REST APIs of their own that you can hit. In fact, it might be as simple as this (if you were using <a href="https://www.nexmo.com/">Nexmo</a>):</p> 
        <div class="language-js highlighter-rouge">
         <pre class="highlight"><code><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'https'</span><span class="p">);</span>
<span class="nx">https</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span>
  <span class="s1">'https://rest.nexmo.com'</span> <span class="o">+</span>
      <span class="s1">'/sms/json?api_key=[YOUR_KEY]&amp;api_secret=[YOUR_SECRET]'</span> <span class="o">+</span>
      <span class="s1">'&amp;from=[YOUR_NUMBER]&amp;to=[USER_MOBILE_#]'</span> <span class="o">+</span>
      <span class="s1">'&amp;text=Your+verification+code+is+'</span> <span class="o">+</span> <span class="nx">code</span><span class="p">,</span>
  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// all done! handle the data as you need to</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// handle errors somewhow</span>
<span class="p">});</span>
</code></pre> 
        </div> 
        <blockquote> 
         <h3 id="push-notifications">Push Notifications</h3> 
         <p><em>While it’s out of scope for this article, if SMS isn’t your thing and you’re already developing a native mobile application, you could also deliver the two-factor code using <a href="http://docs.strongloop.com/display/public/LB/Push+notifications">LoopBack’s push notification component</a>!</em></p> 
        </blockquote> 
        <p>That’s it for the server! At this point you could execute `slc run` and go to <a href="http://localhost:3000/explorer">http://localhost:3000/explorer</a> and see your new model and the custom remote methods. However, they aren’t very interesting without seeing them in action. So let’s build out a&nbsp;lightweight front end to see how everything fits together.</p> 
        <p><img class="aligncenter size-large" src="https://strongloop.com/blog-assets/2015/02/two-factor-explorer.png" alt="LoopBack explorer showing new routes"></p> 
        <h2 id="a-lightweight-login-form"><strong>A Lightweight Login Form</strong></h2> 
        <p><strong>**&nbsp;</strong>**First, you need to follow the <a href="http://docs.strongloop.com/display/public/LB/Add+a+static+web+page">instructions here</a> for adding a middleware configuration for serving static files from the “/client” directory; then we can add a new HTML file inside that directory. You can grab <a href="https://github.com/strongloop/loopback-example-two-factor/blob/master/client/index.html">the file from my example repository</a>, but here is the important part, the form:</p> 
        <p><img class="aligncenter size-large" src="https://strongloop.com/blog-assets/2015/02/two-factor-form.png" alt="A basic two-factor login form"></p> 
        <p>Now we can add a `<script>\` tag at the bottom for our UI code to call those endpoints. We’ll use some simple Ajax calls and DOM manipulation to achieve our goal, but don’t get caught up in the particulars, your UI may differ widely. This is more to demonstrate how to use the endpoints we just created!</script></p> 
        <p>When the user submits the form we’ll check to see if they have a verification code yet, and if not, request one for them. Once they have a code we’ll send the second API call to complete the login process.</p> 
        <p>Note that the code below has been cut short for brevity! You can see the actual, <a href="https://github.com/strongloop/loopback-example-two-factor/blob/master/client/two-factor.js">full UI JavaScript code</a> in the example repository.</p> 
        <div class="language-js highlighter-rouge">
         <pre class="highlight"><code><span class="nb">document</span>
  <span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'login'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'submit'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'[name=code]'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ajaxCall</span><span class="p">({</span>
        <span class="na">url</span><span class="p">:</span> <span class="s1">'/api/Employees/requestCode'</span><span class="p">,</span>
        <span class="na">method</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="nx">emailFromForm</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="nx">passFromForm</span> <span class="p">},</span>
        <span class="na">headers</span><span class="p">:</span> <span class="p">{</span><span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span> <span class="p">},</span>
        <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s1">'Your code is has been sent by SMS!'</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">ajaxCall</span><span class="p">({</span>
        <span class="na">url</span><span class="p">:</span> <span class="s1">'/api/Employees/loginWithCode'</span><span class="p">,</span>
        <span class="na">method</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">email</span><span class="p">:</span> <span class="nx">emailFromForm</span><span class="p">,</span> <span class="na">twofactor</span><span class="p">:</span> <span class="nx">codeFromForm</span> <span class="p">},</span>
        <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span> <span class="p">},</span>
        <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

          <span class="nx">alert</span><span class="p">(</span><span class="s1">'You have logged in!'</span><span class="p">);</span>

          <span class="c1">// The access token will be in the data for use with future API calls!</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
</code></pre> 
        </div> 
        <h2 id="show-me-the-app"><strong>Show me the app!</strong></h2> 
        <p>You can access the <a href="https://github.com/strongloop/loopback-example-two-factor">full example application code</a> on Github, just clone the repository (or download the code), execute `npm install` from a console to install all dependencies, then execute `slc run` to start the application! Head to <a href="http://localhost:3000">http://localhost:3000</a> to see the application in action! You’ll want to have the console up, since we don’t have SMS integration hooked up yet, the verification code will simply print to the server console.</p> 
        <p><img class="aligncenter size-large" src="https://strongloop.com/blog-assets/2015/02/two-factor-code.png" alt="The server console with the two-factor code prompt"></p> 
        <h2 id="they-cant-be-all-there-is"><strong>They can’t be all there is?!</strong></h2> 
        <p>That’s really it! With just a couple of remote methods we can turn a fresh LoopBack application into a secure, two-factor authenticated system. Of course, it’s important to know what the right authentication mechanism is for your application and users. Additionally, you’ll want to add proper access controls to all of your API methods. Check out the <a href="http://docs.strongloop.com/display/public/LB/Tutorial%3A+access+control">tutorial on our documentation site</a> for more information on setting that up!</p> 
        <blockquote> 
         <p><strong>Want More?</strong></p> 
         <p>If this post only whet your appetite for more information on LoopBack, Access Control Layers, APIs, authentication, or even SMS via Node.js then hit me up on <a href="http://twitter.com/jakerella">Twitter (@jakerella)</a>! Or just post a comment, let’s keep the discussion of security going!</p> 
        </blockquote> 
        <div class="share" style="padding-bottom:10px;"> 
         <!-- Load Facebook SDK for JavaScript --> 
         <div id="fb-root"></div> 
         <script>(function(d, s, id) {
                  var js, fjs = d.getElementsByTagName(s)[0];
                  if (d.getElementById(id)) return;
                  js = d.createElement(s); js.id = id;
                  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.9&appId=243237449414858";
                  fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));
                </script> 
         <div class="fb-share-button" data-href="https://strongloop.com//strongblog/two-factor-authentication-with-loopback/" data-layout="button_count" data-size="small" data-mobile-iframe="true">
          <a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://strongloop.com//strongblog/two-factor-authentication-with-loopback/%2F&amp;src=sdkpreparse">Share</a>
         </div> 
         <a class="twitter-share-button no_icon" href="https://twitter.com/share" data-size="large" data-text="Two-Factor Authentication with LoopBack" data-url="https://strongloop.com//strongblog/two-factor-authentication-with-loopback/" data-related="twitterapi,twitter"> <i class="fa fa-twitter" aria-hidden="true"></i> Tweet </a> 
         <a class="newshare-share-button no_icon linkedinshare" href="http://www.linkedin.com/shareArticle?mini=true&amp;url=https://strongloop.com//strongblog/two-factor-authentication-with-loopback/" target="_blank"> <i class="fa fa-linkedin" aria-hidden="true"></i> Share </a> 
         <a class="newshare-share-button no_icon redditshare" href="http://reddit.com/submit?url==https://strongloop.com//strongblog/two-factor-authentication-with-loopback/&amp;title=Two-Factor Authentication with LoopBack" target="_blank"> <i class="fa fa-reddit" aria-hidden="true"></i> Share </a> 
         <a class="newshare-share-button pinterestshare no_icon" href="javascript:void((function()%7Bvar%20e=document.createElement('script');e.setAttribute('type','text/javascript');e.setAttribute('charset','UTF-8');e.setAttribute('src','http://assets.pinterest.com/js/pinmarklet.js?r='+Math.random()*99999999);document.body.appendChild(e)%7D)());"> <i class="fa fa-pinterest" aria-hidden="true"></i> Share </a> 
         <a class="newshare-share-button tumblrshare no_icon" href="http://www.tumblr.com/share/link?url=https://strongloop.com//strongblog/two-factor-authentication-with-loopback/&amp;title=Two-Factor Authentication with LoopBack" target="_blank"> <i class="fa fa-tumblr" aria-hidden="true"></i> Share </a> 
         <br> 
        </div> 
       </div> 
      </div> 
      <div class="_col -col-1-5"> 
       <ul> 
        <li><a class="no_icon" href="https://strongloop.com/blog-archives/">All posts</a></li> 
        <li><a class="no_icon" href="https://strongloop.com/blog-authors/">All authors</a></li> 
       </ul> 
       <h3>Categories:</h3> 
       <ul> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_API-Connect.html">API Connect</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_API-Microgateway.html">API Microgateway</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_API-Tip.html">API Tip</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Bluemix.html">Bluemix</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Cloud.html">Cloud</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Community.html">Community</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_ES2015-ES6.html">ES2015 ES6</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Events.html">Events</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Express.html">Express</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_How-To.html">How-To</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_JavaScript-Language.html">JavaScript Language</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_LoopBack.html">LoopBack</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Mobile.html">Mobile</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_News.html">News</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Node-core.html">Node core</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Node-DevOps.html">Node DevOps</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Open-API-Spec.html">Open API Spec</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Product.html">Product</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Resources.html">Resources</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Tutorial.html">Tutorial</a> </li> 
        <li> <a class="no_icon" href="https://strongloop.com/strongblog/tag_Watson.html">Watson</a> </li> 
       </ul> 
      </div> 
     </div> 
    </div> 
   </section> 
   <footer class="c-footer x-darkgrey"> 
    <div class="c-container -padded"> 
     <div class="legal"> 
      <a target="_new" href="https://www.ibm.com/privacy/us/en/?lnk=flg-priv-usen?lnk=flg">Privacy Policy</a> 
      <br> 
      <a target="_new" href="https://www.ibm.com/legal/us/en/?lnk=flg-tous-usen?lnk=flg">Terms of Use</a> 
      <div class="_copyright">
        © Copyright 2017, IBM 
      </div> 
     </div> 
     <a href="https://strongloop.com" class="_logo x-flex-v no_icon"></a> 
     <nav class="_nav js-masthead-nav"> 
      <ul class="_nav-list js-nav-list"> 
       <li class="_nav-item "> <a class="no_icon" href="https://strongloop.com/projects/" title="Projects">Projects</a> </li> 
       <li class="_nav-item -active"> <a class="no_icon" href="https://strongloop.com/strongblog/" title="Blog">Blog</a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://strongloop.com/newsletter/" title="Newsletter">Newsletter</a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://strongloop.com/events/" title="Events">Events</a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://strongloop.com/faq/" title="FAQ">FAQ</a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://strongloop.com/about/" title="About">About</a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://twitter.com/StrongLoop"><i class="fa fa-twitter" aria-hidden="true"></i></a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://www.facebook.com/strongloop/"><i class="fa fa-facebook" aria-hidden="true"></i></a> </li> 
       <li class="_nav-item "> <a class="no_icon" href="https://www.linkedin.com/groups/5046525"><i class="fa fa-linkedin" aria-hidden="true"></i></a> </li> 
       <li class="_nav-item no-foot"> <a class="no_icon" href="https://github.com/strongloop"><i class="fa fa-github" aria-hidden="true"></i></a> </li> 
      </ul> 
     </nav> 
     <iframe src="https://ghbtns.com/github-btn.html?user=strongloop&amp;repo=loopback&amp;type=follow" class="c-github-follow"></iframe> 
    </div> 
   </footer> 
  </div>   
  <!-- the google_analytics_id gets auto inserted from the config file --> 
  <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-102526298-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>  
 </body>
</html>