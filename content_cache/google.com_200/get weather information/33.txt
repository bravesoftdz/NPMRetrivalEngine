<!doctype html>
<html lang="en">
 <!--
	generated in 0.234 seconds
	31316 bytes batcached for 360 seconds
-->
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(e,n,t){function r(t){if(!n[t]){var o=n[t]={exports:{}};e[t][0].call(o.exports,function(n){var o=e[t][1][n];return r(o||n)},o,o.exports)}return n[t].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<t.length;o++)r(t[o]);return r}({1:[function(e,n,t){function r(){}function o(e,n,t){return function(){return i(e,[c.now()].concat(u(arguments)),n?null:this,t),n?void 0:this}}var i=e("handle"),a=e(2),u=e(3),f=e("ee").get("tracer"),c=e("loader"),s=NREUM;"undefined"==typeof window.newrelic&&(newrelic=s);var p=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],d="api-",l=d+"ixn-";a(p,function(e,n){s[n]=o(d+n,!0,"api")}),s.addPageAction=o(d+"addPageAction",!0),s.setCurrentRouteName=o(d+"routeName",!0),n.exports=newrelic,s.interaction=function(){return(new r).get()};var m=r.prototype={createTracer:function(e,n){var t={},r=this,o="function"==typeof n;return i(l+"tracer",[c.now(),e,t],r),function(){if(f.emit((o?"":"no-")+"fn-start",[c.now(),r,o],t),o)try{return n.apply(this,arguments)}finally{f.emit("fn-end",[c.now()],t)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(e,n){m[n]=o(l+n)}),newrelic.noticeError=function(e){"string"==typeof e&&(e=new Error(e)),i("err",[e,c.now()])}},{}],2:[function(e,n,t){function r(e,n){var t=[],r="",i=0;for(r in e)o.call(e,r)&&(t[i]=n(r,e[r]),i+=1);return t}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],3:[function(e,n,t){function r(e,n,t){n||(n=0),"undefined"==typeof t&&(t=e?e.length:0);for(var r=-1,o=t-n||0,i=Array(o<0?0:o);++r<o;)i[r]=e[n+r];return i}n.exports=r},{}],4:[function(e,n,t){n.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],ee:[function(e,n,t){function r(){}function o(e){function n(e){return e&&e instanceof r?e:e?f(e,u,i):i()}function t(t,r,o,i){if(!d.aborted||i){e&&e(t,r,o);for(var a=n(o),u=m(t),f=u.length,c=0;c<f;c++)u[c].apply(a,r);var p=s[y[t]];return p&&p.push([b,t,r,a]),a}}function l(e,n){v[e]=m(e).concat(n)}function m(e){return v[e]||[]}function w(e){return p[e]=p[e]||o(t)}function g(e,n){c(e,function(e,t){n=n||"feature",y[t]=n,n in s||(s[n]=[])})}var v={},y={},b={on:l,emit:t,get:w,listeners:m,context:n,buffer:g,abort:a,aborted:!1};return b}function i(){return new r}function a(){(s.api||s.feature)&&(d.aborted=!0,s=d.backlog={})}var u="nr@context",f=e("gos"),c=e(2),s={},p={},d=n.exports=o();d.backlog=s},{}],gos:[function(e,n,t){function r(e,n,t){if(o.call(e,n))return e[n];var r=t();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,n,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return e[n]=r,r}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],handle:[function(e,n,t){function r(e,n,t,r){o.buffer([e],r),o.emit(e,n,t)}var o=e("ee").get("handle");n.exports=r,r.ee=o},{}],id:[function(e,n,t){function r(e){var n=typeof e;return!e||"object"!==n&&"function"!==n?-1:e===window?0:a(e,i,function(){return o++})}var o=1,i="nr@id",a=e("gos");n.exports=r},{}],loader:[function(e,n,t){function r(){if(!x++){var e=h.info=NREUM.info,n=d.getElementsByTagName("script")[0];if(setTimeout(s.abort,3e4),!(e&&e.licenseKey&&e.applicationID&&n))return s.abort();c(y,function(n,t){e[n]||(e[n]=t)}),f("mark",["onload",a()+h.offset],null,"api");var t=d.createElement("script");t.src="https://"+e.agent,n.parentNode.insertBefore(t,n)}}function o(){"complete"===d.readyState&&i()}function i(){f("mark",["domContent",a()+h.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(u=Math.max((new Date).getTime(),u))-h.offset}var u=(new Date).getTime(),f=e("handle"),c=e(2),s=e("ee"),p=window,d=p.document,l="addEventListener",m="attachEvent",w=p.XMLHttpRequest,g=w&&w.prototype;NREUM.o={ST:setTimeout,SI:p.setImmediate,CT:clearTimeout,XHR:w,REQ:p.Request,EV:p.Event,PR:p.Promise,MO:p.MutationObserver};var v=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-1044.min.js"},b=w&&g&&g[l]&&!/CriOS/.test(navigator.userAgent),h=n.exports={offset:u,now:a,origin:v,features:{},xhrWrappable:b};e(1),d[l]?(d[l]("DOMContentLoaded",i,!1),p[l]("load",r,!1)):(d[m]("onreadystatechange",o),p[m]("onload",r)),f("mark",["firstbyte",u],null,"api");var x=0,E=e(4)},{}]},{},["loader"]);</script> 
  <title>Composing the results of nested asynchronous calls in Javascript »  Perry Donham   | Blog Archive  | Boston University</title> 
  <!--meta cluster--> 
  <meta name="copyright" content="© 2017 Boston University"> 
  <link rel="alternate" type="application/rss+xml" title="Perry Donham  RSS Feed" href="https://sites.bu.edu/perryd/feed/"> 
  <!--css--> 
  <link rel="stylesheet" media="screen" href="https://sites.bu.edu/perryd/wp-content/themes/flexi-framework/css/reset.css"> 
  <link rel="stylesheet" media="screen" href="https://sites.bu.edu/perryd/wp-content/themes/flexi-red/style.css"> 
  <link rel="stylesheet" media="print" href="https://sites.bu.edu/perryd/wp-content/themes/flexi-framework/css/print.css"> 
  <script>
		document.documentElement.className += 'has-js';
	</script> 
  <link rel="dns-prefetch" href="//s.w.org"> 
  <link rel="alternate" type="application/rss+xml" title="Perry Donham  » Composing the results of nested asynchronous calls in Javascript Comments Feed" href="https://sites.bu.edu/perryd/2017/07/11/composing-the-results-of-nested-asynchronous-calls-in-javascript/feed/"> 
  <script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/sites.bu.edu\/perryd\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.7"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script> 
  <style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style> 
  <script type="text/javascript" src="https://sites.bu.edu/perryd/wp-includes/js/jquery/jquery.js?ver=1.12.4"></script> 
  <script type="text/javascript" src="https://sites.bu.edu/perryd/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1"></script> 
  <link rel="https://api.w.org/" href="https://sites.bu.edu/perryd/wp-json/"> 
  <link rel="prev" title="The Death of Trust" href="https://sites.bu.edu/perryd/2017/02/15/death-of-trust/"> 
  <link rel="canonical" href="https://sites.bu.edu/perryd/2017/07/11/composing-the-results-of-nested-asynchronous-calls-in-javascript/"> 
  <link rel="shortlink" href="https://sites.bu.edu/perryd/?p=237"> 
  <link rel="alternate" type="application/json+oembed" href="https://sites.bu.edu/perryd/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fsites.bu.edu%2Fperryd%2F2017%2F07%2F11%2Fcomposing-the-results-of-nested-asynchronous-calls-in-javascript%2F"> 
  <link rel="alternate" type="text/xml+oembed" href="https://sites.bu.edu/perryd/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fsites.bu.edu%2Fperryd%2F2017%2F07%2F11%2Fcomposing-the-results-of-nested-asynchronous-calls-in-javascript%2F&amp;format=xml"> 
  <meta name="last-updated" content="2017-07-11T21:11:26-04:00"> 
  <script type="text/javascript">
			//<![CDATA[
		function bu_ga_track_pageview(e){var a,t=bu_ga_get_trackers();for(e||(e=void 0),_gaq.push(["_trackPageview",e]),a=0;a<t.length;a++)_gaq.push([t[a]+"._trackPageview",e])}function bu_ga_track_event(e){("undefined"==typeof e.value||null===e.value||isNaN(e.value))&&(e.value=0),"undefined"!=typeof e.delay&&null!==e.delay||(e.delay=0),"undefined"!=typeof e.noninteract&&null!==e.noninteract||(e.noninteract=!0),e.value=parseFloat(e.value);var a,t=bu_ga_get_trackers();for(_gaq.push(["_trackEvent",e.category,e.action,e.label,e.value,e.noninteract]),a=0;a<t.length;a++)_gaq.push([t[a]+"._trackEvent",e.category,e.action,e.label,e.value,e.noninteract]);e.delay&&setTimeout(function(){return!0},100)}function bu_ga_track_social(e){"undefined"!=typeof e.target&&"null"!=typeof e.target||(e.target=void 0),"undefined"!=typeof e.path&&"null"!=typeof e.path||(e.path=void 0);var a,t=bu_ga_get_trackers();for(_gaq.push(["_trackSocial",e.network,e.action,e.target,e.path]),a=0;a<t.length;a++)_gaq.push([t[a]+"._trackSocial",e.network,e.action,e.target,e.path])}function bu_ga_get_trackers(){return"undefined"==typeof buGa||"undefined"==typeof buGa.trackerNames?[]:buGa.trackerNames}function bu_ga_get_tracker(e){if("undefined"==typeof buGa||"undefined"==typeof buGa.trackerIds)return null;if("undefined"==typeof e||"null"==typeof e)return"";var a=buGa.trackerIds;for(var t in a)if(a[t]===e)return"a"===t?"":t;return null}var buGa = {"trackerNames":["b"],"trackerIds":{"a":"UA-124985-28","b":"UA-81713788-1"}};

			var _gaq = _gaq || [];

						_gaq.push(['_setAccount', 'UA-124985-28']);
			_gaq.push(['_trackPageview']);
						/* begin other trackers */
			
						_gaq.push(['b._setAccount', 'UA-81713788-1']);
			_gaq.push(['b._trackPageview']);
			
			(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();
			//]]>
		</script> 
  <link rel="stylesheet" id="custom-css-css" type="text/css" href="https://sites.bu.edu/perryd/files/custom.min.css?8"> 
  <!--[if lt IE 7]>
		<style>body {behavior: url(https://sites.bu.edu/perryd/wp-content/themes/flexi-framework/css/csshover3.htc);}</style>
		<script src="https://sites.bu.edu/perryd/wp-content/themes/flexi-framework/scripts/ie6pngfix.js"></script>
		<script>DD_belatedPNG.fix('img, #quicksearch, *');</script>
	<![endif]--> 
 </head> 
 <body class="med_2col_right med single"> 
  <div id="wrapper"> 
   <div id="header" role="banner"> 
    <div class="container"> 
     <div id="masthead"> 
      <h1><a href="https://sites.bu.edu/perryd">
        <div class="text-header" style="color: #fff">
         Perry Donham @ BUCS
        </div></a></h1> 
      <p></p> 
     </div>
     <!--/#masthead--> 
     <form role="search" method="get" action="http://www.bu.edu/phpbin/search/cms.php" id="quicksearch">
      <fieldset>
       <input type="hidden" name="site" value="https://sites.bu.edu/perryd">
       <select name="context" id="qs_search_scope"><option value="site">This Site</option><option value="bumc">BU Medical</option><option value="all_of_bu">All BU</option><option value="maps">BU Maps</option><option value="directory">BU Directory</option><option value="google">Google</option></select>
       <input name="q" type="text" aria-label="Search" class="search-field" id="q" title="Search for:">
       <input class="button search-submit" type="submit" name="do_search" value="Search">
      </fieldset>
     </form> 
     <div id="pnb" role="navigation"> 
      <ul id="nav" class=" ">
       <li class="page_item page-item-5"> <a class="level_1" href="https://sites.bu.edu/perryd/">Welcome</a> </li> 
       <li class="page_item page-item-15"> <a class="level_1" href="https://sites.bu.edu/perryd/cs101-intro-to-computer-science/">CS101</a> </li> 
       <li class="page_item page-item-17"> <a class="level_1" href="https://sites.bu.edu/perryd/cs411-software-engineering/">CS411</a> </li> 
       <li class="page_item page-item-173"> <a class="level_1" href="https://sites.bu.edu/perryd/cs591/">CS591</a> </li> 
       <li class="page_item page-item-44"> <a class="level_1" href="https://sites.bu.edu/perryd/tools/">Tools</a> 
        <ul> 
         <li class="page_item page-item-75"> <a class="level_2" href="https://sites.bu.edu/perryd/tools/jetbrains/">JetBrains</a> </li> 
         <li class="page_item page-item-46"> <a class="level_2" href="https://sites.bu.edu/perryd/tools/brackets/">Brackets</a> </li> 
         <li class="page_item page-item-77"> <a class="level_2" href="https://sites.bu.edu/perryd/tools/uml/">UML</a> </li> 
        </ul> </li> 
       <li class="page_item page-item-54"> <a class="level_1" href="https://sites.bu.edu/perryd/about-me/">About</a> 
        <ul> 
         <li class="page_item page-item-61"> <a class="level_2" href="https://sites.bu.edu/perryd/about-me/about-me-2/">About Me</a> </li> 
         <li class="page_item page-item-52"> <a class="level_2" href="https://sites.bu.edu/perryd/about-me/contacthours/">Contact/Hours</a> </li> 
         <li class="page_item page-item-59"> <a class="level_2" href="https://sites.bu.edu/perryd/about-me/encryption/">Privacy</a> </li> 
        </ul> </li> 
      </ul> 
     </div>
     <!--/#pnb--> 
    </div>
    <!--/.container--> 
   </div>
   <!--/#header--> 
   <div id="content" role="main"> 
    <div class="container"> 
     <div id="col1" class="main"> 
      <div class="container"> 
       <div class="content-panel full-post post" id="post-237"> 
        <h1>Composing the results of nested asynchronous calls in Javascript</h1> 
        <p class="meta"> <span class="category"><em>in <a href="https://sites.bu.edu/perryd/category/javascript/" rel="category tag">Javascript</a>, <a href="https://sites.bu.edu/perryd/category/mean/" rel="category tag">MEAN</a>, <a href="https://sites.bu.edu/perryd/category/promises/" rel="category tag">Promises</a></em></span> <br> July 11th, 2017 </p> 
        <h2>Grokking asynchronicity</h2> 
        <p>One of&nbsp;the toughest things to get your head around in Javascript is how to handle nested asynchronous calls, especially when a&nbsp;function depends on the result of a preceding one. I see this quite a bit in my software engineering course where teams are required to synthesize new information from two distinct third-party data sources. The pattern is to look something up that returns a collection, and then look something else up for each of&nbsp;the members in the collection.</p> 
        <p>There are multiple approaches to this problem, but most rely on Javascript Promises, either from a third-party library in ES5 and earlier or ES6s built-in Promises. In this article well use both by using ES6 native Promises and the async.js package. This isnt a discussion of ES6 Promises per se, but it might help you get to the point of understanding them.</p> 
        <p>The file discussed here is intended to be mounted on a route in a Node/Express application:</p> 
        <pre style="padding-left: 30px;"><span>//From app.js
const </span><span>rp </span>= <span>require</span>(<span>'./routes/request-promises'</span>)
<span>app</span>.<span>use</span>(<span>'/rp'</span>, <span>rp</span>)</pre> 
        <p>[Unfortunately the WordPress implementation used here does a horrific job displaying code, so the code snippets below are images for the bulk of the discussion. The complete file is available at the bottom of the post.]</p> 
        <p>The route here&nbsp;uses&nbsp;two APIs:<br> <em>https://weathers.co</em> for current weather in 3 cities, and<br> <em>https://api.github.com/search/repositories?q=&lt;term&gt;</em> to search GitHub repos for&nbsp;the hottest city.</p> 
        <p>In our&nbsp;example well grab weather for 3 cities, pick the hottest one,&nbsp;then hit GitHub with a search for repos that have that citys name. Its a bit contrived&nbsp;but we just want to demonstrate using the results of one API call to populate a second when all of them are asynch.</p> 
        <p>There are two packages (apart from Express) used:</p> 
        <p><a href="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.58.58-PM.png"><img src="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.58.58-PM-636x201.png" alt="Screen Shot 2017-07-11 at 7.58.58 PM" width="415" height="131" class="alignnone wp-image-240" srcset="https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.58.58-PM-636x201.png 636w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.58.58-PM-768x243.png 768w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.58.58-PM.png 790w" sizes="(max-width: 415px) 100vw, 415px"></a></p> 
        <p>The first is a reduced-size packaging of the standard <em>request-promise</em> package; we dont need all of the features of the larger library. <em>request-promise</em> itself is a wrapper that adds Promises to the standard <em>request</em> package used to make network calls, for example to an HTTP endpoint.</p> 
        <p>Theres only one route in this module, a GET on the top-level URL. In the snippet above, this router is mounted at /rp, and so the complete URL path is http://localhost:3000/rp (assuming the server is set to listen to port 3000).</p> 
        <p><a href="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.55.41-PM.png"><img src="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.55.41-PM-636x221.png" alt="Screen Shot 2017-07-11 at 7.55.41 PM" width="659" height="229" class="alignnone wp-image-239" srcset="https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.55.41-PM-636x221.png 636w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.55.41-PM-768x267.png 768w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.55.41-PM-1024x356.png 1024w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-7.55.41-PM.png 1236w" sizes="(max-width: 659px) 100vw, 659px"></a></p> 
        <p>On line 50 the <em>async.waterfall</em> method is used to create a chain of functions that will execute in turn. Each function returns a Promise, and so the next function in line waits until the preceding functions Promise is resolved. We need this because each function provides data that the following function will use in some way. That data is provided&nbsp;to each function in turn along with a callback, which is the next function in the waterfall.</p> 
        <p><em>async.waterfall</em> takes two parameters in this implementation: An array of functions to call in order, and a final function (<em>renderTable </em>on line 51)&nbsp;to execute last. A small side note: The final function can be anonymous, but when debugging a big application it can be tough to figure out exactly which anonymous function out of potentially hundreds is causing a problem. Naming those functions helps immensely when debugging!</p> 
        <h3>getCityTemperatures</h3> 
        <p>The first function in the waterfall, <em>getCityTemperatures</em>, calls the weathers.co API for each city in a hardcoded array. This is the&nbsp;first function in the waterfall and so it receives only one param, the callback (cb).</p> 
        <p><a href="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.12.06-PM.png"><img src="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.12.06-PM-636x549.png" alt="Screen Shot 2017-07-11 at 8.12.06 PM" width="636" height="549" class="alignnone size-medium wp-image-241" srcset="https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.12.06-PM-636x549.png 636w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.12.06-PM-768x663.png 768w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.12.06-PM-1024x884.png 1024w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.12.06-PM.png 1200w" sizes="(max-width: 636px) 100vw, 636px"></a></p> 
        <p>This is the most interesting function of the three because it has to do an API call for&nbsp;each city in the <em>cities</em> array, and they all are asynchronous calls. We cant return from the function&nbsp;until all of the city weather has been collected.</p> 
        <p>In each API call, once the current temperature is known it is plugged into the citys object&nbsp;in the <em>cities</em> array. (Note that weathers.co doesnt always return the actual current temperature.&nbsp;Often it is a cached value.)&nbsp;The technique here is to create a Promise that encompasses the API calls on line 83. This Promise represents the entire function, and it wont be resolved until all of the city weather has been collected.</p> 
        <p>A second&nbsp;Promise is set up in the local function <em>getWeather</em> on line 91,&nbsp;and thats the one that handles&nbsp;each individual citys API call. <em>request.get()</em> itself returns a Promise on line 92 (because<br> we are using the request-promise-lite package), and so we make the <em>request.get()</em> and follow&nbsp;it with a &nbsp;then() which will run when the API call returns. The resolve() at line 96&nbsp;gets us out of this inner Promise and on to the next one.</p> 
        <p>Note that we dont yet execute <em>getWeather()</em>,&nbsp;were just <em>defining</em> it here. Line 109 uses the <em>Array.map</em> method to return an array that has three functions in it. Each function has one of the city objects passed into it, and each returns a Promise (as defined on line 91). That <em>cityPromises</em> array looks like</p> 
        <pre>[getWeather({name: 'Miami', temperature: null}),&nbsp;<span>getWeather({name: 'Atlanta', temperature: null}),&nbsp;</span><span>getWeather({name: 'Boston', temperature: null})]</span></pre> 
        <p>after line 109 completes.</p> 
        <p>We <em>still</em> havent executed anything. The mapping in line 109 sets us up to use the <em>Promise.all( )</em> method from the ES6 native Promise library in line 121, which only resolves when all of the Promises in its input array have resolved. Its a bit like the async.waterfall( ) call from line 50, but in this case order doesnt matter. If any of the Promises reject, the entire Promise.all( ) structure rejects at that moment, even if there are outstanding unresolved Promises.</p> 
        <p>Once all of the Promises have resolved (meaning that each citys weather has been recorded, the then( ) in line 122 executes, and calls the passed-in callback with the now-complete array of cities and temperatures. The <em>null</em> value handed to the callback is interpreted as an error object.</p> 
        <p>Of interest here is that Promise.all( ) is, practically speaking, running the requests in parallel.</p> 
        <h3>getHottestCity</h3> 
        <p>The next function in the chain, getHottestCity, simply finds the largest temperature in the array of cities and returns that citys object to the next function in the waterfall. This is synchronous code and so doesnt require a Promise.</p> 
        <p><a href="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.31.14-PM.png"><img src="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.31.14-PM-636x189.png" alt="Screen Shot 2017-07-11 at 8.31.14 PM" width="697" height="207" class="alignnone wp-image-242" srcset="https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.31.14-PM-636x189.png 636w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.31.14-PM-768x228.png 768w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.31.14-PM-1024x304.png 1024w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.31.14-PM.png 1362w" sizes="(max-width: 697px) 100vw, 697px"></a></p> 
        <p>Line 140 creates a slice with just the temperatures from the <em>cities</em> array and calls <em>Math.max( )</em> to determine the largest value. Line 143 then looks for the hottest temperature in the original cities array and returns the corresponding object. Both of these lines use the ES6 way of defining functions with fat-arrow notation (=&gt;), and line 140 uses the new spread operator.</p> 
        <p>Once the hot city has been determined it is passed to the next function in the waterfall in line 148. Here again, the <em>null</em> is in the place of an error object.</p> 
        <h3>findGithubRepos</h3> 
        <p>The next-to-last function in the waterfall searches Github for projects that include the name of the hot city discovered earlier. The User-Agent header in line 167 is required by the Github search API  you can change it to any string that you like.</p> 
        <p><a href="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.42.25-PM.png"><img src="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.42.25-PM-636x359.png" alt="Screen Shot 2017-07-11 at 8.42.25 PM" width="650" height="367" class="alignnone wp-image-243" srcset="https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.42.25-PM-636x359.png 636w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.42.25-PM-768x434.png 768w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.42.25-PM-1024x579.png 1024w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-8.42.25-PM.png 1242w" sizes="(max-width: 650px) 100vw, 650px"></a></p> 
        <p>The API call in line 165 uses <em>request-promise</em> (from line 29) and so returns a Promise. Once the Promise is resolved, the <em>then( )</em> function builds an array of objects from some of the data returned.</p> 
        <p>In line 180 the completed array of items is passed to the next function in the waterfall along with the original hot city object.</p> 
        <h3>The final function</h3> 
        <p>The last function to execute simply takes the results of our waterfall and renders a Pug page on line 57.</p> 
        <p><a href="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-9.00.01-PM.png"><img src="/perryd/files/2017/07/Screen-Shot-2017-07-11-at-9.00.01-PM-636x155.png" alt="Screen Shot 2017-07-11 at 9.00.01 PM" width="636" height="155" class="alignnone size-medium wp-image-244" srcset="https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-9.00.01-PM-636x155.png 636w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-9.00.01-PM-768x187.png 768w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-9.00.01-PM-1024x249.png 1024w, https://sites.bu.edu/perryd/files/2017/07/Screen-Shot-2017-07-11-at-9.00.01-PM.png 1274w" sizes="(max-width: 636px) 100vw, 636px"></a></p> 
        <p>Heres a <a href="https://gist.github.com/pdonham/8d2c7e0ccd482150a6877b5075794b23">link to the complete file</a>. If If you have questions or corrections, leave a comment!</p> 
        <p>&nbsp;</p> 
        <p>&nbsp;</p> 
       </div>
       <!--/.content--> 
       <p class="meta"> <span class="tags">Tagged <em><a href="https://sites.bu.edu/perryd/tag/asynchronous/" rel="tag">asynchronous</a>, <a href="https://sites.bu.edu/perryd/tag/es6/" rel="tag">ES6</a></em></span> </p> 
       <div id="commentform_wrapper" class="buforms"> 
        <h3 id="respond">Post Your Comment</h3> 
        <form action="https://sites.bu.edu/perryd/wp-comments-post.php" method="post" id="commentform"> 
         <fieldset> 
          <div>
           <label for="author">Name<em class="required">*</em></label>
           <input type="text" name="author" id="author" value="" size="22" tabindex="1" aria-required="true">
          </div> 
          <div>
           <label for="email">Email<em class="required">*</em></label>
           <input type="text" name="email" id="email" value="" size="22" tabindex="2" aria-required="true">
          </div> 
          <div>
           <label for="url">Website</label>
           <input type="text" name="url" id="url" value="" size="22" tabindex="3">
          </div> 
          <div>
           <label for="comment">Comment <span>(<a href="http://www.bu.edu/tech/web/departments/wordpress/management/comment-guidelines/">view guidelines</a>)</span></label>
           <textarea name="comment" id="comment" cols="100%" rows="10" tabindex="4"></textarea>
          </div> 
          <div>
           <input name="submit" type="submit" id="submit" tabindex="5" value="Submit Comment">
          </div> 
          <p class="cancel-comment-reply"><a rel="nofollow" id="cancel-comment-reply-link" href="/perryd/2017/07/11/composing-the-results-of-nested-asynchronous-calls-in-javascript/#respond" style="display:none;">Click here to cancel reply.</a></p> 
          <input type="hidden" name="comment_post_ID" value="237" id="comment_post_ID"> 
          <input type="hidden" name="comment_parent" id="comment_parent" value="0"> 
          <p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="0cbb617be2"></p>
          <p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="157"></p> 
         </fieldset> 
        </form> 
       </div>
       <!-- /#commentform_wrapper --> 
      </div>
      <!-- /.container --> 
     </div>
     <!-- /.main --> 
     <div id="col2" class="sub" role="complementary"> 
      <div id="sidebar2"> 
       <div class="widget widget_rss" id="rss-2">
        <h2 class="widgettitle"><a class="rsswidget" href="http://fetchrss.com/rss/568aeb308a93f86b27a7e58853054023035.xml"><img class="rss-widget-icon" style="border:0" width="14" height="14" src="https://sites.bu.edu/perryd/wp-includes/images/rss.png" alt="RSS"></a> <a class="rsswidget" href="https://twitter.com/perrydbucs">Twitter: @perrydBUCS (RSS/XML)</a></h2>
        <ul>
         <li><a class="rsswidget" href="https://twitter.com/perrydBUCS/status/915009828010942464">RT @richardpbacon: Number of Americans killed on battlefields in all wars in history: 1,396,733 Killed by firearms in the US since 1968:</a> <span class="rss-date">October 2, 2017</span></li>
         <li><a class="rsswidget" href="https://twitter.com/perrydBUCS/status/914943408963227649">RT @Alyssa_Milano: Trump Signs Bill Revoking Obama-Era Gun Checks for People With Mental Illnesses - https://t.co/0xfK5E5Uc9</a> <span class="rss-date">October 2, 2017</span></li>
         <li><a class="rsswidget" href="https://twitter.com/perrydBUCS/status/914905713914376194">Its time to designate @NRA a terrorist organization. Congress, if you take money from them you have blood on your hands. #enough</a> <span class="rss-date">October 2, 2017</span></li>
         <li><a class="rsswidget" href="https://twitter.com/perrydBUCS/status/914904512724389888">RT @bostonherald: .@RepJoeKennedy said "enough is enough" following #LasVegasShooting, calls for action on gun control https://t.co/Pha0t4Y</a> <span class="rss-date">October 2, 2017</span></li>
         <li><a class="rsswidget" href="https://twitter.com/perrydBUCS/status/914496852950740992">RT @RepJoeKennedy: Programs GOP Congress let expire last night -healthcare for low-income kids -Community health centers -Loans for low-inc</a> <span class="rss-date">October 1, 2017</span></li>
        </ul>
       </div> 
      </div> 
     </div>
     <!-- /.sub --> 
    </div>
    <!-- /.container --> 
    <div id="footbar1" class="footbar  even_3col" role="complementary"> 
     <div class="container"> 
      <div class="widget_container footbar_widget1">
       <div class="widget widget_archive" id="archives-3">
        <h2 class="widgettitle">Older posts</h2> 
        <ul> 
         <li><a href="https://sites.bu.edu/perryd/2017/07/">July 2017</a>&nbsp;(1)</li> 
         <li><a href="https://sites.bu.edu/perryd/2017/02/">February 2017</a>&nbsp;(1)</li> 
         <li><a href="https://sites.bu.edu/perryd/2017/01/">January 2017</a>&nbsp;(3)</li> 
         <li><a href="https://sites.bu.edu/perryd/2016/12/">December 2016</a>&nbsp;(4)</li> 
         <li><a href="https://sites.bu.edu/perryd/2016/11/">November 2016</a>&nbsp;(2)</li> 
         <li><a href="https://sites.bu.edu/perryd/2016/07/">July 2016</a>&nbsp;(1)</li> 
         <li><a href="https://sites.bu.edu/perryd/2016/04/">April 2016</a>&nbsp;(2)</li> 
         <li><a href="https://sites.bu.edu/perryd/2016/03/">March 2016</a>&nbsp;(2)</li> 
         <li><a href="https://sites.bu.edu/perryd/2016/02/">February 2016</a>&nbsp;(1)</li> 
         <li><a href="https://sites.bu.edu/perryd/2016/01/">January 2016</a>&nbsp;(2)</li> 
        </ul> 
       </div>
      </div>
      <div class="widget_container footbar_widget2">
       <div class="widget widget_text" id="text-2">
        <h2 class="widgettitle">Links</h2> 
        <div class="textwidget">
         <a href="http://www.acm.org" target="_new">Assoc. of Computing Machinery (ACM)</a> 
         <br> 
         <a href="http://www.eff.org" target="_new">Electronic Frontier Foundation (EFF)</a> 
         <br> 
         <a href="https://aclu.org" target="_new">ACLU <br></a>
        </div>
        <a href="https://aclu.org" target="_new"> </a>
       </div>
      </div>
      <a href="https://aclu.org" target="_new"> </a>
     </div>
     <!-- /.container -->
     <a href="https://aclu.org" target="_new"> </a>
    </div>
    <!-- /#footbar -->
    <a href="https://aclu.org" target="_new"> </a>
   </div>
   <!--/#content-->
   <a href="https://aclu.org" target="_new"> </a>
  </div>
  <!--/#wrapper-->
  <a href="https://aclu.org" target="_new"> </a>
  <div id="footer" role="contentinfo">
   <a href="https://aclu.org" target="_new"> 
    <div class="container masterplate"> 
     <a href="http://www.bu.edu" title="Boston University Homepage"><img src="https://sites.bu.edu/perryd/wp-content/themes/flexi-framework/images/boston-university-logo.gif" alt="Boston University Logo"></a> 
     <ul> 
      <li><a href="http://www.bu.edu" rel="external">Boston University</a></li>
      <li><a href="http://www.bu.edu/search" rel="external">Search</a></li>
      <li><a href="http://www.bu.edu/directory" rel="external">Directory</a></li>
      <li><a href="http://www.bu.edu/today" rel="external">BU Today</a></li>
     </ul> 
     <ul> 
      <li><span class="footer-disclaimer"><a href="http://www.bu.edu/tech/policies/websites-disclaimer/">Disclaimer</a></span></li> 
     </ul> 
    </div></a>
   <!--/.container--> 
  </div>
  <!--/#footer--> 
  <script type="text/javascript">
		(function($) {

			var ajaxurl = "https://sites.bu.edu/perryd/wp-admin/admin-ajax.php";

			if (jQuery('.sortable').length) {
				
				var data = {
					action: 'sortable_scripts'
				};
				$.post(ajaxurl, data, function(scripts) {
					var s = document.getElementsByTagName('script')[0];
					$(s).before(scripts);
				}); 
				
			}
		})(jQuery);
		</script> 
  <script type="text/javascript" src="https://sites.bu.edu/perryd/wp-includes/js/wp-embed.min.js?ver=4.6.7"></script> 
  <script type="text/javascript" src="https://sites.bu.edu/perryd/wp-content/mu-plugins/akismet/_inc/form.js?ver=4.0"></script> 
  <script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","licenseKey":"b19c58809e","applicationID":"7212547","transactionName":"YV1SNkUDWEQDBRdQDFgXcQFDC1lZTRUKVwRaXQ==","queueTime":0,"applicationTime":239,"atts":"TRpFQA0ZSxtAB0EDGEtF","errorBeacon":"bam.nr-data.net","agent":""}</script> 
 </body>
</html>