<!doctype html>
<html>
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <title>How To Setup A Transparent Content Filtering Proxy | Geeky Tidbits</title> 
  <meta name="description" content="To speed up web access and block obscene content on my home network, I setup a transparent content filtering proxy on my Arch Linux server with the help of S..."> 
  <link href="//fonts.googleapis.com/css?family=Poly" rel="stylesheet" type="text/css"> 
  <link rel="stylesheet" href="/css/main.css?cache_mode=none"> 
  <link rel="canonical" href="https://www.geekytidbits.com/transparent-content-filtering-proxy/"> 
  <link rel="alternate" type="application/rss+xml" title="Geeky Tidbits" href="https://www.geekytidbits.com/feed/"> 
 </head> 
 <body> 
  <header class="site-header"> 
   <div class="wrapper"> 
    <a class="site-title" href="/"> <img src="/media/geekytidbits.png" alt="Geeky Tidbits Logo"> </a> 
    <div class="site-description">
     Tidbits on software development, technology and other geeky stuff.
    </div> 
   </div> 
  </header> 
  <div class="page-content"> 
   <div class="wrapper"> 
    <div class="sidebar"> 
     <img class="head-shot" alt="Brady Holt" width="145px" height="145px" src="//s.gravatar.com/avatar/ae474dd4a074fd22e897c4c54770c05a?s=290"> 
     <h3>Brady Holt</h3> 
     <h4>Geek, developer at <a target="_blank" href="https://www.youneedabudget.com/">YNAB</a>, voider of warranties</h4> 
     <nav class="site-nav"> 
      <ul> 
       <li> <a class="page-link" href="/about-me/">About Me</a> </li> 
       <li> <a class="page-link" href="/projects/">Projects</a> </li> 
       <li> <a class="page-link" href="/posts/">Posts</a> </li> 
      </ul> 
     </nav> 
     <p>Connect with me!</p> 
     <ul class="social-links"> 
      <li> <a href="https://github.com/bradyholt"> 
        <svg class="social" viewbox="0 0 35 35"> 
         <path fill="#444444" d="M16 0c-8.837 0-16 7.163-16 16s7.163 16 16 16 16-7.163 16-16-7.163-16-16-16zM25.502 25.502c-1.235 1.235-2.672 2.204-4.272 2.881-0.406 0.172-0.819 0.323-1.238 0.453v-2.398c0-1.26-0.432-2.188-1.297-2.781 0.542-0.052 1.039-0.125 1.492-0.219s0.932-0.229 1.438-0.406 0.958-0.388 1.359-0.633 0.786-0.563 1.156-0.953 0.68-0.833 0.93-1.328 0.448-1.089 0.594-1.781 0.219-1.456 0.219-2.289c0-1.615-0.526-2.99-1.578-4.125 0.479-1.25 0.427-2.609-0.156-4.078l-0.391-0.047c-0.271-0.031-0.758 0.083-1.461 0.344s-1.492 0.688-2.367 1.281c-1.24-0.344-2.526-0.516-3.859-0.516-1.344 0-2.625 0.172-3.844 0.516-0.552-0.375-1.075-0.685-1.57-0.93s-0.891-0.411-1.188-0.5-0.573-0.143-0.828-0.164-0.419-0.026-0.492-0.016-0.125 0.021-0.156 0.031c-0.583 1.479-0.635 2.839-0.156 4.078-1.052 1.135-1.578 2.51-1.578 4.125 0 0.833 0.073 1.596 0.219 2.289s0.344 1.286 0.594 1.781 0.56 0.938 0.93 1.328 0.755 0.708 1.156 0.953 0.854 0.456 1.359 0.633 0.984 0.313 1.438 0.406 0.95 0.167 1.492 0.219c-0.854 0.583-1.281 1.51-1.281 2.781v2.445c-0.472-0.14-0.937-0.306-1.394-0.5-1.6-0.677-3.037-1.646-4.272-2.881s-2.204-2.672-2.881-4.272c-0.7-1.655-1.055-3.414-1.055-5.23s0.355-3.575 1.055-5.23c0.677-1.6 1.646-3.037 2.881-4.272s2.672-2.204 4.272-2.881c1.655-0.7 3.415-1.055 5.23-1.055s3.575 0.355 5.23 1.055c1.6 0.677 3.037 1.646 4.272 2.881s2.204 2.672 2.881 4.272c0.7 1.655 1.055 3.415 1.055 5.23s-0.355 3.575-1.055 5.23c-0.677 1.6-1.646 3.037-2.881 4.272z"></path> 
        </svg>GitHub </a> </li> 
      <li> <a href="https://stackoverflow.com/users/626911/brady?tab=profile"> 
        <svg class="social" viewbox="0 0 35 35"> 
         <path fill="#444444" d="M32 20v12h-32v-12h4v8h24v-8zM6 22h20v4h-20zM6.473 17.671l0.866-3.905 19.526 4.328-0.866 3.905zM8.739 9.642l1.69-3.625 18.126 8.452-1.69 3.625zM30.991 11.296l-2.435 3.173-15.867-12.175 1.761-2.294h1.82z"></path> 
        </svg>Stack Overflow </a> </li> 
      <li> <a href="https://twitter.com/bradymholt"> 
        <svg class="social" viewbox="0 0 35 35"> 
         <path fill="#444444" d="M32 6.076c-1.177 0.522-2.443 0.875-3.771 1.034 1.355-0.813 2.396-2.099 2.887-3.632-1.269 0.752-2.674 1.299-4.169 1.593-1.198-1.276-2.904-2.073-4.792-2.073-3.626 0-6.565 2.939-6.565 6.565 0 0.515 0.058 1.016 0.17 1.496-5.456-0.274-10.294-2.888-13.532-6.86-0.565 0.97-0.889 2.097-0.889 3.301 0 2.278 1.159 4.287 2.921 5.465-1.076-0.034-2.088-0.329-2.974-0.821-0.001 0.027-0.001 0.055-0.001 0.083 0 3.181 2.263 5.834 5.266 6.437-0.551 0.15-1.131 0.23-1.73 0.23-0.423 0-0.834-0.041-1.235-0.118 0.835 2.608 3.26 4.506 6.133 4.559-2.247 1.761-5.078 2.81-8.154 2.81-0.53 0-1.052-0.031-1.566-0.092 2.905 1.863 6.356 2.95 10.064 2.95 12.076 0 18.679-10.004 18.679-18.68 0-0.285-0.006-0.568-0.019-0.849 1.283-0.926 2.396-2.082 3.276-3.398z"></path> 
        </svg>Twitter </a> </li> 
      <li> <a href="https://www.linkedin.com/in/bradyholt"> 
        <svg class="social" viewbox="0 0 35 35"> 
         <path fill="#444444" d="M12 12h5.535v2.837h0.079c0.77-1.381 2.655-2.837 5.464-2.837 5.842 0 6.922 3.637 6.922 8.367v9.633h-5.769v-8.54c0-2.037-0.042-4.657-3.001-4.657-3.005 0-3.463 2.218-3.463 4.509v8.688h-5.767v-18z"></path> 
         <path fill="#444444" d="M2 12h6v18h-6v-18z"></path> 
         <path fill="#444444" d="M8 7c0 1.657-1.343 3-3 3s-3-1.343-3-3c0-1.657 1.343-3 3-3s3 1.343 3 3z"></path> 
        </svg>LinkedIn </a> </li> 
      <li> <a href="/feed/"> 
        <svg class="social" viewbox="0 0 35 35"> 
         <path fill="#444444" d="M4.259 23.467c-2.35 0-4.259 1.917-4.259 4.252 0 2.349 1.909 4.244 4.259 4.244 2.358 0 4.265-1.895 4.265-4.244-0-2.336-1.907-4.252-4.265-4.252zM0.005 10.873v6.133c3.993 0 7.749 1.562 10.577 4.391 2.825 2.822 4.384 6.595 4.384 10.603h6.16c-0-11.651-9.478-21.127-21.121-21.127zM0.012 0v6.136c14.243 0 25.836 11.604 25.836 25.864h6.152c0-17.64-14.352-32-31.988-32z"></path> 
        </svg>Feed </a> </li> 
     </ul> 
    </div> 
    <div class="post"> 
     <header class="post-header"> 
      <h1 class="post-title">How To Setup A Transparent Content Filtering Proxy</h1> 
      <p class="post-meta">Aug 10, 2011</p> 
     </header> 
     <article class="post-content"> 
      <p>To speed up web access and block obscene content on my home network, I setup a transparent content filtering proxy on my Arch Linux server with the help of <a href="http://www.squid-cache.org/" target="_blank">Squid </a>and <a href="http://dansguardian.org/" target="_blank">DansGuardian</a>. &nbsp; &nbsp;Below are the steps I took to get it all working.</p> 
      <h3 id="install-and-configure-squid-web-proxy">Install and configure Squid (web proxy)</h3> 
      <p>Squid will act as our proxy server which should speed up our web browsing and allow the content filter (DansGuardian, explained below) to function as it requires one.</p> 
      <ul> 
       <li>Run: <strong>pacman -S squid</strong> to install</li> 
       <li>The default config file for squid is pretty much ready to go. &nbsp;It’s a good thing because there are an overwhelming number of configuration options. &nbsp;Anyway, keep the default config but add/change the following in your **/etc/squid/squid.conf **file.</li> 
      </ul> 
      <pre class="brush:text;">acl localhost src 127.0.0.1/32
http_access allow localhost
http_access deny all
http_port 3128 transparent
dns_nameservers 208.67.222.123, 208.67.220.123 #OpenDNS FamilyShield DNS</pre> 
      <p><em>Note: The IP addresses specified for dns_nameservers are the&nbsp;<a href="https://www.opendns.com/landings/familyshield" target="_blank">OpenDNS FamilyShield</a>&nbsp;DNS servers. &nbsp;This speeds up DNS lookups and provides a simple way to have an up-to-date blacklist for pornographic sites. &nbsp;This will work in tandem with DansGuardian to filter web content.</em></p> 
      <ul> 
       <li>Start Squid by running <strong>/etc/rc.d/squid start</strong></li> 
      </ul> 
      <h3 id="install-and-configure-dansguardian-content-filter">Install and configure DansGuardian (content filter)</h3> 
      <p>DansGuardian is the powerful, fast, open-source content filtering engine we will use. &nbsp;It is very configurable but I will keep it simple for demonstration purposes.</p> 
      <ul> 
       <li>Run: <strong>pacman -S dansguardian</strong> to install</li> 
       <li>Make sure the following configuration options are set in your <strong>/etc/dansguardian/dansguardian.conf</strong> file</li> 
      </ul> 
      <pre class="brush:text;">filterport = 8888
proxyport = 3128</pre> 
      <ul> 
       <li>Start DansGuardian by running <strong>/etc/rc.d/dansguradian start</strong></li> 
      </ul> 
      <h3 id="configure-your-router">Configure Your Router</h3> 
      <p>To make our solution truly *transparent *and avoid the need to configure each computer in our network individually, we need to make our router redirect outgoing web traffic to our proxy server that is running DansGuardian and Squid. &nbsp;To do this, you’ll need a router running Linux (most do) and one that allows telnet or SSH access. &nbsp;I have a Netgear router and after searching on the web found that if you navigate to the address:&nbsp;http://192.168.1.1/<strong>setup.cgi?todo=debug</strong> (192.168.1.1 being your router IP, of course), the router will allow telnet access on port 23, with the same credentials you use to login to the web interface. &nbsp;Once you have connected, run the following command to redirect outgoing port 80 request:</p> 
      <pre class="brush:text;">iptables -t nat -A PREROUTING -i br0 -s ! 192.168.1.2 -d ! 192.168.1.2 -p tcp --dport 80 -j DNAT --to 192.168.1.2:8888</pre> 
      <h3 id="notes">Notes</h3> 
      <ul> 
       <li>192.168.1.2 is the IP address of our proxy server. &nbsp;You’ll need to change this to match your own server’s address.</li> 
       <li>It is likely that if you change anything through the web admin interface of your router, the iptables information will get overwritten. &nbsp;You will need to re-run the above command if/when you make changes. &nbsp;I actually setup a cron job that runs daily to reset the iptables configuration. &nbsp;It first uses wget with http authentication to access the /setup.cgi?todo=debug page so that telnet access will be enabled and then issues remote telnet commands to configure iptables. &nbsp;This is not necessary but makes for a more stable setup.</li> 
       <li>To further ensure no machines are able to access the internet directly, I recommend configuring (through web admin interface) your router to block outgoing port 80 traffic from all IP addresses except the IP of your proxy server (192.158.1.2 in my case). &nbsp;This is usually pretty easy to do and varies depending on the router you use. Remember, as mentioned above, you might need to re-run the iptables command after locking down outgoing traffic.</li> 
      </ul> 
      <h3 id="that8217s-it">That’s It!</h3> 
      <p>Now, if you browse to a website on a &nbsp;client machine in your local network, it should send all the data through your &nbsp;proxy server and provide content filtering. &nbsp;There is no client configuration (i.e. proxy settings) needed as we have set things up in a transparent manner.</p> 
      <p>A good next step would be to read up on <a href="http://dansguardian.org/downloads/detailedinstallation2.html" target="_blank">configuring DansGuardian</a>&nbsp;and make it work to suite your needs.</p> 
     </article> 
     <div id="disqus_thread"></div> 
     <script type="text/javascript">
        
        var disqus_identifier = '579 http://www.geekytidbits.com/?p=579';
        
        var disqus_container_id = 'disqus_thread';
        var disqus_shortname = 'geekytidbits';
        var disqus_url = 'http://www.geekytidbits.com/transparent-content-filtering-proxy/';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> 
     <noscript>
      Please enable JavaScript to view the 
      <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
     </noscript> 
    </div> 
   </div> 
  </div> 
  <div class="wrapper"> 
   <footer class="site-footer">
     © 2017 Brady Holt 
   </footer> 
  </div> 
  <script>
        (function(i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-19416043-2', 'auto');
        ga('send', 'pageview');
    </script>   
 </body>
</html>