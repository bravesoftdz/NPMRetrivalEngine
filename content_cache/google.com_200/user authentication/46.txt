<!doctype html>
<html>
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <meta name="author" content="Sahat Yalkabov"> 
  <meta name="description" content="Full-Stack JavaScript Developer"> 
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"> 
  <title>How To Implement Password Reset In Node.js</title> 
  <!-- Google Authorship --> 
  <link rel="author" href="https://plus.google.com/+SahatYalkabov?rel=author"> 
  <!-- Favicon --> 
  <link rel="shortcut icon" href="/favicon.png"> 
  <!-- Styles --> 
  <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700" rel="stylesheet" type="text/css"> 
  <link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet" type="text/css"> 
  <link href="//fonts.googleapis.com/css?family=Alegreya:400,700" rel="stylesheet" type="text/css"> 
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"> 
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css"> 
  <link rel="stylesheet" href="//code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css"> 
  <link rel="stylesheet" href="/assets/css/main.css"> 
  <script type="application/ld+json">
{
"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "How To Implement Password Reset In Node.js",
"alternativeHeadline": "In this tutorial, we'll go over how to create a forgot your password feature using Express, MongoDB, Passport and Nodemailer. We will build a complete application from scratch. This guide assumes as little possible, and thus covers some basic stuff along the way.",
"image": "/images/blog/password-reset-cover.jpg",
"datePublished": "2014-02-26T00:00:00-05:00",
"description": "In this tutorial, we'll go over how to create a forgot your password feature using Express, MongoDB, Passport and Nodemailer. We will build a complete application from scratch. This guide assumes as little possible, and thus covers some basic stuff along the way."
}
</script> 
  <style>
  .carbon-container,
  #carbonads {
    max-width: 400px;
    margin-top: 30px;
    margin-bottom: 20px;
    height: 100px;
    background-color: rgba(0, 0, 0, 0.25);
    padding: 10px;
    box-shadow: inset 0 2px 2px rgba(0, 0, 0, 0.05);
    border-radius: 4px;
  }

  .carbon-container {
    height: inherit;
  }

  .carbon-img {
    float: left;
    margin-right: 15px;
  }

  .carbon-text {
    display: block;
    font-size: 12px;
    line-height: 1.5;
    color: #fff !important;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.25), 0 0 1px rgba(0, 0, 0, 0.5);
    text-decoration: none !important;
  }

  .carbon-poweredby {
    font-size: 75%;
    color: rgba(255, 255, 255, 0.85) !important;
    text-decoration: none !important;
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.25), 0 0 1px rgba(0, 0, 0, 0.5);
  }
</style> 
 </head> 
 <body> 
  <div class="navigation"> 
   <a href="/" class="logo" title="Site Logo">Sahat <strong>Yalkabov</strong></a> 
   <ul class="menu"> 
    <li><a href="/projects" title="Projects">Projects</a></li> 
    <li><a href="https://github.com/sahat" title="GitHub">GitHub</a></li> 
   </ul> 
  </div> 
  <div class="content" role="main"> 
   <article class="post"> 
    <div class="article-image"> 
     <div class="post-image-image" style="background-image: url(/images/blog/password-reset-cover.jpg)"></div> 
     <div class="post-meta"> 
      <h1 class="post-title">How To Implement Password Reset In Node.js</h1> 
      <div class="cf post-meta-text">
        In this tutorial, we'll go over how to create a forgot your password feature using Express, MongoDB, Passport and Nodemailer. We will build a complete application from scratch. This guide assumes as little possible, and thus covers some basic stuff along the way. 
       <p>Published on <strong>February 26, 2014</strong></p> 
      </div> 
      <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&amp;serve=C6AILKT&amp;placement=sahatyalkabovcom" id="_carbonads_js"></script> 
      <p class="cf post-meta-text carbon-container hidden"> <i class="fa fa-bullhorn"></i> Please consider disabling your ad blocker on this site. </p> 
     </div> 
    </div> 
    <div class="post-reading"> 
     <i class="ion-clock"></i>
     <span class="post-reading-time"></span> read 
    </div> 
    <section class="post-content"> 
     <div class="top-share"> 
      <iframe src="https://ghbtns.com/github-btn.html?user=sahat&amp;type=follow" frameborder="0" scrolling="0" width="104px" height="20px"></iframe> 
      <a href="https://twitter.com/share" class="twitter-share-button" {count} data-text="How To Implement Password Reset In Node.js" data-via="EvNowAndForever">Tweet</a> 
      <a href="https://twitter.com/EvNowAndForever" class="twitter-follow-button" data-show-count="false">Follow @EvNowAndForever</a> 
      <div class="fb-like" data-href="http://sahatyalkabov.com/how-to-implement-password-reset-in-nodejs/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div> 
     </div> 
     <p><strong>May 25, 2014:</strong> Updated tutorial for Express 4.x.</p> 
     <hr> 
     <p>To see password reset in action, check out this <a href="http://hackathonstarter.herokuapp.com/">Live Demo</a> from the <a href="http://github.com/sahat/hackathon-starter">Hackathon Starter</a> project.</p> 
     <p>Let’s begin by installing the Express application generator. That will allow us to create a new Express project skeleton from the command line.</p> 
     <div class="language-bash highlighter-rouge">
      <pre class="highlight"><code>sudo npm install -g express-generator
</code></pre> 
     </div> 
     <p><strong>Note:</strong> Do not use <code class="highlighter-rouge">sudo</code> if you are on Windows.</p> 
     <p>To create a new Express project run the following command:</p> 
     <div class="language-bash highlighter-rouge">
      <pre class="highlight"><code>express myapp
</code></pre> 
     </div> 
     <p><img src="/images/blog/password-reset-1.png"></p> 
     <p>Next, install NPM dependencies:</p> 
     <div class="language-bash highlighter-rouge">
      <pre class="highlight"><code><span class="nb">cd </span>myapp <span class="o">&amp;&amp;</span> npm install
</code></pre> 
     </div> 
     <p>Before proceeding any further, let’s cleanup this project from all that garbage created by the Express generator.</p> 
     <p>Delete <strong>bin</strong> and <strong>routes</strong> folders, as well as <strong>views/error.jade</strong> template. Then replace <strong>app.js</strong> with the following contents:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">favicon</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'static-favicon'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'morgan'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cookie-parser'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="c1">// Middleware</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'port'</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'views'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'view engine'</span><span class="p">,</span> <span class="s1">'jade'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">favicon</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logger</span><span class="p">(</span><span class="s1">'dev'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'public'</span><span class="p">)));</span>

<span class="c1">// Routes</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="p">{</span> <span class="na">title</span><span class="p">:</span> <span class="s1">'Express'</span> <span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'port'</span><span class="p">),</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Express server listening on port '</span> <span class="o">+</span> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'port'</span><span class="p">));</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>If you run the app now, you should see the following <em>“Welcome to Express”</em> page.</p> 
     <p><img src="/images/blog/password-reset-1.5.png" alt=""></p> 
     <p>We will be using <a href="https://github.com/andris9/Nodemailer">Nodemailer</a> for sending password reset emails, <a href="http://mongoosejs.com">Mongoose</a> for interacting with MongoDB and <a href="http://passportjs.com/">Passport</a> for user authentication. Additionally we will need <a href="https://www.npmjs.org/package/bcrypt-nodejs">bcrypt-nodejs</a> for hashing user passwords and <a href="https://github.com/caolan/async">async</a> library to avoid dealing with nested callbacks by using with the help of <code class="highlighter-rouge">async.waterfall</code> method. Also, as of Express 4.0+ you have to install <a href="https://github.com/expressjs/session">session</a> middleware separately.</p> 
     <p>To install these modules run the following command:</p> 
     <div class="language-bash highlighter-rouge">
      <pre class="highlight"><code>npm install --save async express-session mongoose nodemailer passport passport-local bcrypt-nodejs
</code></pre> 
     </div> 
     <p><strong>Note:</strong> By passing <code class="highlighter-rouge">--save</code> flag, those packages will be automatically added to <code class="highlighter-rouge">package.json</code>. I can’t recall how many times I have installed packages locally, but then forgot to add them to <code class="highlighter-rouge">package.json</code>.</p> 
     <p>Next, add these modules at the top of <code class="highlighter-rouge">app.js</code>:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express-session'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">nodemailer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'nodemailer'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'passport'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">LocalStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'passport-local'</span><span class="p">).</span><span class="nx">Strategy</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">bcrypt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bcrypt-nodejs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'async'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>
</code></pre> 
     </div> 
     <p><strong>Note:</strong> We didn’t have to install <code class="highlighter-rouge">crypto</code> library as it is part of Node.js. We will be using it for generating random token during a password reset.</p> 
     <p>Add the session middleware right after <code class="highlighter-rouge">app.use(cookieParser())</code>:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span> <span class="na">secret</span><span class="p">:</span> <span class="s1">'session secret key'</span> <span class="p">}));</span>
</code></pre> 
     </div> 
     <p>From here on, we will be working entirely inside <code class="highlighter-rouge">app.js</code>, while ocassionally switching to templates. I am only doing it for the purposes of this tutorial, in order to keep things simple. If you are building a mediums-sized application (or larger), it would be in your best interests to modularize your code.</p> 
     <p>Since we are using Mongoose to interact with MongoDB, we will first need to create a <code class="highlighter-rouge">User</code> model before we can do anything. But even before that, we need to have a Schema. Let’s start by defining the <code class="highlighter-rouge">User</code> schema. Add this right after the module dependencies.</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="kd">var</span> <span class="nx">userSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
  <span class="na">username</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="na">email</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="na">password</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="na">resetPasswordToken</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">resetPasswordExpires</span><span class="p">:</span> <span class="nb">Date</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>Each schema maps to a MongoDB collection. And each key - username, email, password, etc., defines a property in our MongoDB documents. For example, this is how our User document would look in a database:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">()</span>
<span class="p">{</span>
	<span class="s2">"__v"</span> <span class="err">:</span> <span class="mi">0</span><span class="p">,</span>
	<span class="s2">"_id"</span> <span class="err">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">"530c17c1fb8c96752498e120"</span><span class="p">),</span>
	<span class="s2">"email"</span> <span class="err">:</span> <span class="s2">"sahat@me.com"</span><span class="p">,</span>
	<span class="s2">"password"</span> <span class="err">:</span> <span class="s2">"$2a$05$ANZrgWJqVo9j1tqgCMwe2.LCFnU43bUAYW9rA3Nsx4WchPM.cELEi"</span><span class="p">,</span>
	<span class="s2">"username"</span> <span class="err">:</span> <span class="s2">"sahat"</span>
<span class="p">}</span>
</code></pre> 
     </div> 
     <p><strong>Note:</strong> Properties <code class="highlighter-rouge">resetPasswordToken</code> and <code class="highlighter-rouge">resetPassword</code> are not part of the above document, because they are set only after password reset is submitted. And since we haven’t specified default values, those properties will not be set when creating a new user.</p> 
     <p>Besides specifying a structure of documents, Mongoose schemas also define <a href="http://mongoosejs.com/docs/guide.html#methods">instance methods</a> and <a href="http://mongoosejs.com/docs/middleware.html">middleware</a>. And that’s exactly what we will use next.</p> 
     <p>It would not be smart to store passwords in plaintext, clearly visible. If your database is compromised, you (or your users) are pretty much screwed. To avoid that, we will need to hash user’s passwords. And that’s where <code class="highlighter-rouge">bcrypt</code> comes in. Now, consider a scenario where you have a signup page, an account management page where users can update their existing password and a reset password page where users can set a new password. Do you really want to implement the same password hashing logic in all three places? Instead, you should use Mongoose middleware to hash a password on <code class="highlighter-rouge">save()</code>.</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">userSchema</span><span class="p">.</span><span class="nx">pre</span><span class="p">(</span><span class="s1">'save'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">SALT_FACTOR</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">isModified</span><span class="p">(</span><span class="s1">'password'</span><span class="p">))</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>

  <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">genSalt</span><span class="p">(</span><span class="nx">SALT_FACTOR</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">salt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

    <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">hash</span><span class="p">;</span>
      <span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p><strong>Note:</strong> This code snippet was taken from a <a href="https://github.com/jaredhanson/passport-local">passport-local</a> example.</p> 
     <p>Next, to perform password verification when user tries to sign-in, we will use the following Mongoose instance method:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">userSchema</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">comparePassword</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">candidatePassword</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">candidatePassword</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">isMatch</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">isMatch</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre> 
     </div> 
     <p>To use our <code class="highlighter-rouge">userSchema</code>, we need to convert it into a Model we can work with. Add this line right after the instance method we have just defined:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'User'</span><span class="p">,</span> <span class="nx">userSchema</span><span class="p">);</span>
</code></pre> 
     </div> 
     <p>Before we can interact with the database, we must first connect to one. If you already have MongoDB installed on your machine, and it is up and running, then simply add this line somewhere in your <code class="highlighter-rouge">app.js</code>. I typically place it right before (or after) <code class="highlighter-rouge">var app = express();</code>.</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">);</span>
</code></pre> 
     </div> 
     <p>Or, if you do not have MongoDB installed on your computer, you may use this demo database that I have created just for this tutorial:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">mongodb</span><span class="err">:</span><span class="c1">//demo:demo@ds027759.mongolab.com:27759/demo);</span>
</code></pre> 
     </div> 
     <p>Now, let’s move on to Passport configuration. You need to configure three pieces to use Passport for authentication:</p> 
     <ol> 
      <li>Authentication strategies</li> 
      <li>Application middleware</li> 
      <li>Sessions</li> 
     </ol> 
     <p>To setup a Local strategy (username and password), add the following code anywhere after the <code class="highlighter-rouge">User</code> model declaration:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">LocalStrategy</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">username</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="s1">'Incorrect username.'</span> <span class="p">});</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">comparePassword</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">isMatch</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isMatch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="s1">'Incorrect password.'</span> <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}));</span>
</code></pre> 
     </div> 
     <p><strong>Note:</strong> This code snippet is almost identical to the one found on <a href="http://passportjs.org/guide/configure/">Passport | Configure</a> page.</p> 
     <p>Next, we need to add the Passport middleware to our Express configuration. It is important that you place these two lines after <code class="highlighter-rouge">app.use(session({ secret: 'session secret key' }))</code>. More often than not, order matters when it comes to Express middleware.</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">session</span><span class="p">());</span>
</code></pre> 
     </div> 
     <p>For example, this is how it would look all together:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="c1">// Middleware</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'port'</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'views'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'view engine'</span><span class="p">,</span> <span class="s1">'jade'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">favicon</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logger</span><span class="p">(</span><span class="s1">'dev'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span> <span class="na">secret</span><span class="p">:</span> <span class="s1">'session secret key'</span> <span class="p">}));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">session</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'public'</span><span class="p">)));</span>
</code></pre> 
     </div> 
     <p>And lastly, we need to add <em>serialize</em> and <em>deserialize</em> passport methods. You can read more about it on <a href="http://passportjs.org/guide/configure/">Passport | Configure</a> page, but essentially it allows you to stay logged-in when navigating between different pages within your application.</p> 
     <p>Add this code before or after your <em>LocalStrategy</em>:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">passport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">passport</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>At this point your <code class="highlighter-rouge">app.js</code> should look, more or less, something like this:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">favicon</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'static-favicon'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'morgan'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cookie-parser'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express-session'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">nodemailer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'nodemailer'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'passport'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">LocalStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'passport-local'</span><span class="p">).</span><span class="nx">Strategy</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">bcrypt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'bcrypt-nodejs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">async</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'async'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'crypto'</span><span class="p">);</span>

<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">LocalStrategy</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">username</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="s1">'Incorrect username.'</span> <span class="p">});</span>
    <span class="nx">user</span><span class="p">.</span><span class="nx">comparePassword</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">isMatch</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isMatch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="s1">'Incorrect password.'</span> <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}));</span>

<span class="nx">passport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">passport</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">User</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">userSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
  <span class="na">username</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="na">email</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="na">password</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">required</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
  <span class="na">resetPasswordToken</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
  <span class="na">resetPasswordExpires</span><span class="p">:</span> <span class="nb">Date</span>
<span class="p">});</span>

<span class="nx">userSchema</span><span class="p">.</span><span class="nx">pre</span><span class="p">(</span><span class="s1">'save'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">SALT_FACTOR</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">isModified</span><span class="p">(</span><span class="s1">'password'</span><span class="p">))</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>

  <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">genSalt</span><span class="p">(</span><span class="nx">SALT_FACTOR</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">salt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

    <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="nx">salt</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">hash</span><span class="p">;</span>
      <span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="nx">userSchema</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">comparePassword</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">candidatePassword</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">candidatePassword</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">isMatch</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">isMatch</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'User'</span><span class="p">,</span> <span class="nx">userSchema</span><span class="p">);</span>

<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="c1">// Middleware</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'port'</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'views'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'views'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'view engine'</span><span class="p">,</span> <span class="s1">'jade'</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">favicon</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">logger</span><span class="p">(</span><span class="s1">'dev'</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span> <span class="na">secret</span><span class="p">:</span> <span class="s1">'session secret key'</span> <span class="p">}));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">session</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'public'</span><span class="p">)));</span>

<span class="c1">// Routes</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="p">{</span> <span class="na">title</span><span class="p">:</span> <span class="s1">'Express'</span> <span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'port'</span><span class="p">),</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Express server listening on port '</span> <span class="o">+</span> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'port'</span><span class="p">));</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>We are done with the configuration step, so let’s move on to defining our routes: <code class="highlighter-rouge">/login</code>, <code class="highlighter-rouge">/logout</code>, <code class="highlighter-rouge">/signup</code>. We will add a few more routes for resetting a password shortly.</p> 
     <p>Update the <code class="highlighter-rouge">/</code> route to include <code class="highlighter-rouge">user: req.user</code> property and add the new <code class="highlighter-rouge">/login</code> route:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="s1">'Express'</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'login'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">user</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>Our <code class="highlighter-rouge">GET /login</code> route simply renders a page. When the login operation completes, <code class="highlighter-rouge">user</code> will be assigned to <code class="highlighter-rouge">req.user</code>. To check if user is signed-in or not, inside templates, we have to pass <code class="highlighter-rouge"><span class="p">{</span><span class="w"> </span><span class="err">user:</span><span class="w"> </span><span class="err">req.user</span><span class="w"> </span><span class="p">}</span></code> explicitly. For instance, you may want to display <strong>Login</strong> and <strong>Create Account</strong> links to guests and <strong>Logout</strong> link to authenticated users.</p> 
     <p>We will come back to that in a moment, but for now let’s create a login template. Inside the <strong>views</strong> folder create <code class="highlighter-rouge">login.jade</code> with the following content:</p> 
     <pre><code class="language-jade">extends layout

block content
  form(method='POST')
    legend Login
    .form-group
      label(for='username') Username
      input.form-control(type='text', name='username', autofocus)
    .form-group
      label(for='password') Password
      input.form-control(type='password', name='password')
    button.btn.btn-primary(type='submit') Login
    a.btn.btn-link(href='/forgot') Forgot Password?
</code></pre> 
     <p><strong>Note:</strong> If this is your first time working with Jade templates, I recommend to take a look at this interactive <a href="http://naltatis.github.io/jade-syntax-docs/">Jade Syntax Documentation</a>.</p> 
     <p>Let’s switch over to <code class="highlighter-rouge">layout.jade</code> so we can add jQuery and Bootstrap libraries. Inside <code class="highlighter-rouge">head</code> block add these three lines:</p> 
     <pre><code class="language-jade">link(rel='stylesheet', href='//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css')
script(src='//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js')
script(src='//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js')
</code></pre> 
     <p>And while we are here, let’s also add a Navbar in <code class="highlighter-rouge">layout.jade</code>. Place this code inside <code class="highlighter-rouge">body</code> tag, but before <code class="highlighter-rouge">block content</code>:</p> 
     <pre><code class="language-jade">.navbar.navbar-inverse.navbar-static-top(role='navigation')
  .container
    .navbar-header
      button.navbar-toggle(type='button', data-toggle='collapse', data-target='.navbar-collapse')
        span.sr-only Toggle navigation
        span.icon-bar
        span.icon-bar
        span.icon-bar
      a.navbar-brand(href='/') Project name
    .collapse.navbar-collapse
      ul.nav.navbar-nav
        li.active
          a(href='/') Home
        if user
          li
            a(href='/logout') Logout
        else
          li
            a(href='/login') Login
          li
            a(href='/signup') Signup
</code></pre> 
     <p>Notice the <em>if/else</em> statement. Recall what I said earlier about passing <code class="highlighter-rouge"><span class="p">{</span><span class="w"> </span><span class="err">user:</span><span class="w"> </span><span class="err">req.user</span><span class="w"> </span><span class="p">}</span></code> to a template. This essentially allows us to display different content, depending on whether <code class="highlighter-rouge">user</code> is defined or not.</p> 
     <p>Also, to make things prettier, let’s add some padding to our page content by wrapping <code class="highlighter-rouge">block content</code> with <code class="highlighter-rouge">.container</code> element.</p> 
     <pre><code class="language-jade">.container
  block content
</code></pre> 
     <p>Here is how your <code class="highlighter-rouge">layout.jade</code> should look at this point:</p> 
     <pre><code class="language-jade">doctype html
html
  head
    title= title
    link(rel='stylesheet', href='//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css')
    script(src='//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js')
    script(src='//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js')
  body
    .navbar.navbar-inverse.navbar-static-top(role='navigation')
      .container
        .navbar-header
          button.navbar-toggle(type='button', data-toggle='collapse', data-target='.navbar-collapse')
            span.sr-only Toggle navigation
            span.icon-bar
            span.icon-bar
            span.icon-bar
          a.navbar-brand(href='/') Project name
        .collapse.navbar-collapse
          ul.nav.navbar-nav
            li.active
              a(href='/') Home
            if user
              li
                a(href='/logout') Logout
            else
              li
                a(href='/login') Login
              li
                a(href='/signup') Signup

    .container
      block content
</code></pre> 
     <p>Try visiting the <code class="highlighter-rouge">/login</code> route. If you are not using something like <a href="https://github.com/remy/nodemon">nodemon</a>, you will need to manually restart the node.js server before you see new changes. Looks better now, doesn’t it?</p> 
     <p><img src="/images/blog/password-reset-2.png"></p> 
     <p>If we try to submit a form right now, we will get an error, because we haven’t created <code class="highlighter-rouge">POST /login</code> route yet. Let’s do that next.</p> 
     <p>Back in <code class="highlighter-rouge">app.js</code> add the following route:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">'local'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">logIn</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">})(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p><strong>Note:</strong> This code snippet was taken from a <a href="https://github.com/jaredhanson/passport-local/blob/master/examples/express3-mongoose/app.js#L149">passport-local</a> example.</p> 
     <p>You now have a fully working login form, except there is no way to test it since we haven’t created any users yet. This would be a right time to create a signup page.</p> 
     <p>Add the following route to <code class="highlighter-rouge">app.js</code>:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/signup'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'signup'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">user</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>In your <strong>views</strong> folder create <code class="highlighter-rouge">signup.jade</code> file with the following contents:</p> 
     <pre><code class="language-jade">extends layout

block content
  form(method='POST')
    legend Signup
    .form-group
      label(for='username') Username
      input.form-control(type='text', name='username', autofocus)
    .form-group
      label(for='email') Email
      input.form-control(type='text', name='email')
    .form-group
      label(for='password') Password
      input.form-control(type='password', name='password')
    .form-group
      label(for='confirm') Confirm Password
      input.form-control(type='password', name='confirm')
    button.btn.btn-primary(type='submit') Signup
</code></pre> 
     <p><strong>Note:</strong> Confirm Password currently doesn’t do anything. In a real-world scenario you would compare <code class="highlighter-rouge">req.body.confirm</code> with <code class="highlighter-rouge">req.body.password</code> to see if they are equal. Take a look at <a href="https://github.com/ctavan/express-validator">express-validator</a> if you are interested in learning more about data validation.</p> 
     <p>This is how our <code class="highlighter-rouge">/signup</code> page would look like, if you followed along the tutorial:</p> 
     <p><img src="/images/blog/password-reset-3.png"></p> 
     <p>Just as with the login form, we will need to create a POST route to handle the form on the signup page.</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/signup'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">({</span>
      <span class="na">username</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
      <span class="na">email</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">});</span>

  <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">logIn</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>Here we create a new <code class="highlighter-rouge">User</code> object with the values passed into the form. On a successful database save, user is immediately logged-in, then redirected to the home page.</p> 
     <p>Oh, one last thing, let’s add the logout route:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/logout'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>At this stage you have a basic, but functional application with <strong>Home</strong>, <strong>Login</strong> and <strong>Signup</strong> pages. We have everything but the password reset feature, which was the entire point of this tutorial.</p> 
     <p>Create a new route in <code class="highlighter-rouge">app.js</code> and a corresponding template, <code class="highlighter-rouge">forgot.jade</code>:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/forgot'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'forgot'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">user</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <pre><code class="language-jade">extends layout

block content
  form(method='POST')
    legend Forgot Password
    .form-group
      label(for='email') Email
      input.form-control(type='text', name='email', autofocus)
    button.btn.btn-primary(type='submit') Reset Password
</code></pre> 
     <p>Before we proceed any further, let’s add flash messages to notify users about success and error messages. Go ahead and run:</p> 
     <div class="language-bash highlighter-rouge">
      <pre class="highlight"><code>npm install express-flash --save
</code></pre> 
     </div> 
     <p>and then add it to <code class="highlighter-rouge">app.js</code>:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="kd">var</span> <span class="nx">flash</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express-flash'</span><span class="p">);</span>
</code></pre> 
     </div> 
     <p>Finally, add the <code class="highlighter-rouge">flash()</code> function with the rest of your Express middleware. I have placed it right after <code class="highlighter-rouge">app.use(session({ secret: 'session secret key' }))</code>, although it might still work if you place it elsewhere.</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">flash</span><span class="p">());</span>
</code></pre> 
     </div> 
     <p>To display flash messages, inside <code class="highlighter-rouge">layout.jade</code> let’s add the following code to the <code class="highlighter-rouge">.container</code> element, right before <code class="highlighter-rouge">block content</code>:</p> 
     <pre><code class="language-jade">.container
  if messages.error
    .alert.alert-danger
      div= messages.error
  if messages.info
    .alert.alert-info
      div= messages.info
  if messages.success
    .alert.alert-success
      div= messages.success
  block content
</code></pre> 
     <p>Ok, so far so good. Now, it’s going to get slightly more complicated. Add the following route to handle the form on <code class="highlighter-rouge">/forgot</code> page:</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/forgot'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">async</span><span class="p">.</span><span class="nx">waterfall</span><span class="p">([</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">buf</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'hex'</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">email</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="s1">'No account with that email address exists.'</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/forgot'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">user</span><span class="p">.</span><span class="nx">resetPasswordToken</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>
        <span class="nx">user</span><span class="p">.</span><span class="nx">resetPasswordExpires</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3600000</span><span class="p">;</span> <span class="c1">// 1 hour</span>

        <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">smtpTransport</span> <span class="o">=</span> <span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">(</span><span class="s1">'SMTP'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">service</span><span class="p">:</span> <span class="s1">'SendGrid'</span><span class="p">,</span>
        <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">user</span><span class="p">:</span> <span class="s1">'!!! YOUR SENDGRID USERNAME !!!'</span><span class="p">,</span>
          <span class="na">pass</span><span class="p">:</span> <span class="s1">'!!! YOUR SENDGRID PASSWORD !!!'</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">mailOptions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">to</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'passwordreset@demo.com'</span><span class="p">,</span>
        <span class="na">subject</span><span class="p">:</span> <span class="s1">'Node.js Password Reset'</span><span class="p">,</span>
        <span class="na">text</span><span class="p">:</span> <span class="s1">'You are receiving this because you (or someone else) have requested the reset of the password for your account.\n\n'</span> <span class="o">+</span>
          <span class="s1">'Please click on the following link, or paste this into your browser to complete the process:\n\n'</span> <span class="o">+</span>
          <span class="s1">'http://'</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s1">'/reset/'</span> <span class="o">+</span> <span class="nx">token</span> <span class="o">+</span> <span class="s1">'\n\n'</span> <span class="o">+</span>
          <span class="s1">'If you did not request this, please ignore this email and your password will remain unchanged.\n'</span>
      <span class="p">};</span>
      <span class="nx">smtpTransport</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">'info'</span><span class="p">,</span> <span class="s1">'An e-mail has been sent to '</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">+</span> <span class="s1">' with further instructions.'</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s1">'done'</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/forgot'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>Here we are using <a href="https://github.com/caolan/async">async</a> module to avoid nesting callbacks within callbacks within callbacks. We start out by randomly generating a token that looks like this - <em>94b422c1f87568a06a198da66fe2ef8cc963641d</em>. It doesn’t mean anything, we only care that it is somewhat unique, i.e. no two exact password reset tokens at one time. We then pass that token down the <em>async.waterfall</em> to the next function that looks up a user by the provided e-mail address. If there is an account with such e-mail address, we set <code class="highlighter-rouge">resetPasswordToken</code> to that randomly generated token and set <code class="highlighter-rouge">resetPasswordExpires</code> 1 hour into the future. In other words, password reset link will be active only for 1 hour, afterwards that link becomes invalid.</p> 
     <p>Next, we send out an e-mail to the user using <a href="https://github.com/andris9/Nodemailer">Nodemailer</a> and <a href="http://sendgrid.com/">SendGrid</a>. If you prefer not to use SendGrid, change <code class="highlighter-rouge">service</code> string to any of the following: <em>Gmail</em>, <em>Mailgun</em>, <em>iCloud</em>, <em>Hotmail</em>. For a full list of service providers see <a href="https://github.com/andris9/Nodemailer">Nodemailer</a> GitHub repo.</p> 
     <p><img src="/images/blog/password-reset-4.png"></p> 
     <p>You should receive an email that looks something like this: <img src="/images/blog/password-reset-8.png"></p> 
     <p>Clicking on that link won’t do anything since we have not implemented <code class="highlighter-rouge">/reset</code> route yet. Let’s do that right now.</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/reset/:token'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">resetPasswordToken</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="na">resetPasswordExpires</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="p">}</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="s1">'Password reset token is invalid or has expired.'</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/forgot'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">'reset'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>It immediately checks if there exists a user with a given password reset token <strong>and</strong> that token has not expired yet. If user is found, it will display a page to setup a new password.</p> 
     <p>And the <code class="highlighter-rouge">reset.jade</code> template:</p> 
     <pre><code class="language-jade">extends layout

block content
  form(method='POST')
    legend Reset Password
    .form-group
      label(for='password') New Password
      input.form-control(type='password', name='password', value='', placeholder='New password', autofocus=true)
    .form-group
      label(for='confirm') Confirm Password
      input.form-control(type='password', name='confirm', value='', placeholder='Confirm password')
    .form-group
      button.btn.btn-primary(type='submit') Update Password
</code></pre> 
     <p>This is what you would see in a case of a valid token:</p> 
     <p><img src="/images/blog/password-reset-5.png"></p> 
     <p>And finally, we need to add a POST controller for the <code class="highlighter-rouge">/reset/:token</code> route. It is very similar to the <code class="highlighter-rouge">/forgot</code> route.</p> 
     <div class="language-js highlighter-rouge">
      <pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/reset/:token'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">async</span><span class="p">.</span><span class="nx">waterfall</span><span class="p">([</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">resetPasswordToken</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="na">resetPasswordExpires</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gt</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="p">}</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="s1">'Password reset token is invalid or has expired.'</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'back'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
        <span class="nx">user</span><span class="p">.</span><span class="nx">resetPasswordToken</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="nx">user</span><span class="p">.</span><span class="nx">resetPasswordExpires</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

        <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">req</span><span class="p">.</span><span class="nx">logIn</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">smtpTransport</span> <span class="o">=</span> <span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">(</span><span class="s1">'SMTP'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">service</span><span class="p">:</span> <span class="s1">'SendGrid'</span><span class="p">,</span>
        <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">user</span><span class="p">:</span> <span class="s1">'!!! YOUR SENDGRID USERNAME !!!'</span><span class="p">,</span>
          <span class="na">pass</span><span class="p">:</span> <span class="s1">'!!! YOUR SENDGRID PASSWORD !!!'</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="kd">var</span> <span class="nx">mailOptions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">to</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'passwordreset@demo.com'</span><span class="p">,</span>
        <span class="na">subject</span><span class="p">:</span> <span class="s1">'Your password has been changed'</span><span class="p">,</span>
        <span class="na">text</span><span class="p">:</span> <span class="s1">'Hello,\n\n'</span> <span class="o">+</span>
          <span class="s1">'This is a confirmation that the password for your account '</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">+</span> <span class="s1">' has just been changed.\n'</span>
      <span class="p">};</span>
      <span class="nx">smtpTransport</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span> <span class="s1">'Success! Your password has been changed.'</span><span class="p">);</span>
        <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre> 
     </div> 
     <p>We begin by checking if the password reset token is still valid. It is not unlikely that a user opens the link from their e-mail and leaves the browser open for more than one hour (at which point token should no longer be valid).</p> 
     <p>If the user is found, update his/her password and <code class="highlighter-rouge">$unset</code> <em>resetPasswordToken</em> and <em>resetPasswordExpires</em> fields. User is then immediately signed-in. Right after that an email is sent to the user notifying about the password change.</p> 
     <p><img src="/images/blog/password-reset-7.png"></p> 
     <p>Upon a successful password reset you would be redirected to the home page with a success flash message:</p> 
     <p><img src="/images/blog/password-reset-6.png"></p> 
     <p>That’s all I have! I hope you enjoyed this tutorial. For questions &amp; comments send me an email at sahat[at]me[dot]com.</p> 
    </section> 
    <div class="post-footer"> 
     <section class="share"> 
      <ul class="rrssb-buttons clearfix"> 
       <li class="rrssb-email"> <a href="mailto:sahat@me.com"> <span class="rrssb-icon"> 
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="28px" height="28px" viewbox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve">
           <g>
            <path d="M20.111 26.147c-2.336 1.051-4.361 1.401-7.125 1.401c-6.462 0-12.146-4.633-12.146-12.265 c0-7.94 5.762-14.833 14.561-14.833c6.853 0 11.8 4.7 11.8 11.252c0 5.684-3.194 9.265-7.399 9.3 c-1.829 0-3.153-0.934-3.347-2.997h-0.077c-1.208 1.986-2.96 2.997-5.023 2.997c-2.532 0-4.361-1.868-4.361-5.062 c0-4.749 3.504-9.071 9.111-9.071c1.713 0 3.7 0.4 4.6 0.973l-1.169 7.203c-0.388 2.298-0.116 3.3 1 3.4 c1.673 0 3.773-2.102 3.773-6.58c0-5.061-3.27-8.994-9.303-8.994c-5.957 0-11.175 4.673-11.175 12.1 c0 6.5 4.2 10.2 10 10.201c1.986 0 4.089-0.43 5.646-1.245L20.111 26.147z M16.646 10.1 c-0.311-0.078-0.701-0.155-1.207-0.155c-2.571 0-4.595 2.53-4.595 5.529c0 1.5 0.7 2.4 1.9 2.4 c1.441 0 2.959-1.828 3.311-4.087L16.646 10.068z" />
           </g>
          </svg> </span> <span class="rrssb-text">Send Email</span> </a> </li> 
       <li class="rrssb-twitter"> <a href="https://twitter.com/home?status=How To Implement Password Reset In Node.js http://sahatyalkabov.com/how-to-implement-password-reset-in-nodejs/ via @EvNowAndForever" class="popup"> <span class="rrssb-icon"> 
          <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewbox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve"> 
           <path d="M24.253,8.756C24.689,17.08,18.297,24.182,9.97,24.62c-3.122,0.162-6.219-0.646-8.861-2.32
                      c2.703,0.179,5.376-0.648,7.508-2.321c-2.072-0.247-3.818-1.661-4.489-3.638c0.801,0.128,1.62,0.076,2.399-0.155
                      C4.045,15.72,2.215,13.6,2.115,11.077c0.688,0.275,1.426,0.407,2.168,0.386c-2.135-1.65-2.729-4.621-1.394-6.965
                      C5.575,7.816,9.54,9.84,13.803,10.071c-0.842-2.739,0.694-5.64,3.434-6.482c2.018-0.623,4.212,0.044,5.546,1.683
                      c1.186-0.213,2.318-0.662,3.329-1.317c-0.385,1.256-1.247,2.312-2.399,2.942c1.048-0.106,2.069-0.394,3.019-0.851
                      C26.275,7.229,25.39,8.196,24.253,8.756z" /> 
          </svg> </span> <span class="rrssb-text">share on twitter</span> </a> </li> 
       <li class="rrssb-facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://sahatyalkabov.com/how-to-implement-password-reset-in-nodejs/" class="popup"> <span class="rrssb-icon"> 
          <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewbox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve"> 
           <path d="M27.825,4.783c0-2.427-2.182-4.608-4.608-4.608H4.783c-2.422,0-4.608,2.182-4.608,4.608v18.434
                          c0,2.427,2.181,4.608,4.608,4.608H14V17.379h-3.379v-4.608H14v-1.795c0-3.089,2.335-5.885,5.192-5.885h3.718v4.608h-3.726
                          c-0.408,0-0.884,0.492-0.884,1.236v1.836h4.609v4.608h-4.609v10.446h4.916c2.422,0,4.608-2.188,4.608-4.608V4.783z" /> 
          </svg> </span> <span class="rrssb-text">share on facebook</span> </a> </li> 
       <li class="rrssb-googleplus"> <a href="https://plus.google.com/share?url=http://sahatyalkabov.com/how-to-implement-password-reset-in-nodejs/" class="popup"> <span class="rrssb-icon"> 
          <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="28px" height="28px" viewbox="0 0 28 28" enable-background="new 0 0 28 28" xml:space="preserve"> 
           <g> 
            <g> 
             <path d="M14.703,15.854l-1.219-0.948c-0.372-0.308-0.88-0.715-0.88-1.459c0-0.748,0.508-1.223,0.95-1.663
                                  c1.42-1.119,2.839-2.309,2.839-4.817c0-2.58-1.621-3.937-2.399-4.581h2.097l2.202-1.383h-6.67c-1.83,0-4.467,0.433-6.398,2.027
                                  C3.768,4.287,3.059,6.018,3.059,7.576c0,2.634,2.022,5.328,5.604,5.328c0.339,0,0.71-0.033,1.083-0.068
                                  c-0.167,0.408-0.336,0.748-0.336,1.324c0,1.04,0.551,1.685,1.011,2.297c-1.524,0.104-4.37,0.273-6.467,1.562
                                  c-1.998,1.188-2.605,2.916-2.605,4.137c0,2.512,2.358,4.84,7.289,4.84c5.822,0,8.904-3.223,8.904-6.41
                                  c0.008-2.327-1.359-3.489-2.829-4.731H14.703z M10.269,11.951c-2.912,0-4.231-3.765-4.231-6.037c0-0.884,0.168-1.797,0.744-2.511
                                  c0.543-0.679,1.489-1.12,2.372-1.12c2.807,0,4.256,3.798,4.256,6.242c0,0.612-0.067,1.694-0.845,2.478
                                  c-0.537,0.55-1.438,0.948-2.295,0.951V11.951z M10.302,25.609c-3.621,0-5.957-1.732-5.957-4.142c0-2.408,2.165-3.223,2.911-3.492
                                  c1.421-0.479,3.25-0.545,3.555-0.545c0.338,0,0.52,0,0.766,0.034c2.574,1.838,3.706,2.757,3.706,4.479
                                  c-0.002,2.073-1.736,3.665-4.982,3.649L10.302,25.609z"></path> 
             <polygon points="23.254,11.89 23.254,8.521 21.569,8.521 21.569,11.89 18.202,11.89 18.202,13.604 21.569,13.604 21.569,17.004
                                  23.254,17.004 23.254,13.604 26.653,13.604 26.653,11.89      "></polygon> 
            </g> 
           </g> 
          </svg> </span> <span class="rrssb-text">share on google+</span> </a> </li> 
      </ul> 
     </section> 
    </div> 
   </article> 
  </div> 
  <footer>
    © 2017 Sahat Yalkabov. Powered by 
   <a href="http://jekyllrb.com">Jekyll</a> and 
   <a href="https://pages.github.com">GitHub Pages</a>. 
  </footer> 
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> 
  <script src="/assets/js/vendor/readingTime.min.js"></script> 
  <script src="/assets/js/vendor/rrssb.min.js"></script> 
  <!-- Google Analytics --> 
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-17023058-2', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script> 
  <!-- AdBlock --> 
  <script>
  (function() {
    var tryMessage = function() {
      setTimeout(function() {
        if (!document.getElementById('carbonads')) {
          $('.carbon-container').removeClass('hidden');
        }
      }, 2000);
    };

    if (window.addEventListener) {
      window.addEventListener('load', tryMessage, false);
    } else {
      window.attachEvent('onload', tryMessage);
    }
  })();
</script> 
  <!-- Reading Time --> 
  <script>
  $('.post').readingTime({
    remoteTarget: '.post-content',
    readingTimeTarget: '.post-reading-time'
  });

  // Parallax background
  $(window).resize(parallaxBackground);
  $(window).scroll(parallaxBackground);

  var $image = $('.post-image-image');
  function parallaxBackground() {
    var scrollTotal = $(window).scrollTop();

    if (scrollTotal < 0 || scrollTotal > 1500) {
      return;
    }
    var opacity = 1 - Math.max(scrollTotal / 300, 0);
    opacity = opacity > 0.3 ? opacity : 0.3;
    $image.css('opacity', opacity);

    scrollTotal = Math.floor(scrollTotal / 2);
    $('.post .article-image .post-image-image').css({
      transform: 'translate3d(0,' + scrollTotal + 'px,0)'
    });
  }
</script> 
  <!-- Twitter --> 
  <script>!function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
  if (!d.getElementById(id)) {
    js = d.createElement(s);
    js.id = id;
    js.src = p + '://platform.twitter.com/widgets.js';
    fjs.parentNode.insertBefore(js, fjs);
  }
}(document, 'script', 'twitter-wjs');</script> 
  <!-- Facebook --> 
  <script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5&appId=535088106626462";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>   
 </body>
</html>