<!doctype html>
<html class="no-js hasSidebar hasPageActions hasBreadcrumb " lang="en-us" dir="ltr">
 <head> 
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <meta property="og:title" content="Cloud-to-device messages with Azure IoT Hub (Node)"> 
  <meta property="og:image" content="https://docs.microsoft.com/_themes/docs.theme/master/en-us/_themes/images/microsoft-header.png"> 
  <meta name="twitter:card" content="summary"> 
  <meta name="twitter:site" content="@docsmsft"> 
  <meta name="twitter:title" content="Cloud-to-device messages with Azure IoT Hub (Node)"> 
  <meta name="twitter:description" content="How to send cloud-to-device messages to a device from an Azure IoT hub using the Azure IoT SDKs for Node.js. You modify a simulated device app to receive cloud-to-device messages and modify a back-end app to send the cloud-to-device messages."> 
  <meta name="twitter:image" content="https://docs.microsoft.com/_themes/docs.theme/master/en-us/_themes/images/microsoft-header.png"> 
  <meta name="twitter:image:alt" content="Microsoft Logo"> 
  <meta name="breadcrumb_path" content="/azure/bread/toc.json"> 
  <meta name="ms.devlang" content="javascript"> 
  <meta name="ms.tgt_pltfrm" content="na"> 
  <meta name="ms.assetid" content="3ca8a78f-ade2-46e8-8a49-d5d599cdf1f1"> 
  <meta name="author" content="dominicbetts"> 
  <meta name="editor" content=""> 
  <meta name="description" content="How to send cloud-to-device messages to a device from an Azure IoT hub using the Azure IoT SDKs for Node.js. You modify a simulated device app to receive cloud-to-device messages and modify a back-end app to send the cloud-to-device messages."> 
  <meta name="ms.author" content="dobett"> 
  <meta name="manager" content="timlt"> 
  <meta name="documentationcenter" content="nodejs"> 
  <meta name="ms.topic" content="article"> 
  <meta name="services" content="iot-hub"> 
  <meta name="ms.service" content="iot-hub"> 
  <meta name="ms.date" content="06/16/2017"> 
  <meta name="ms.workload" content="na"> 
  <meta name="search.ms_sitename" content="Docs"> 
  <meta name="search.ms_docsetname" content="azure-documents"> 
  <meta name="version" content="0"> 
  <meta name="locale" content="en-us"> 
  <meta name="site_name" content="Docs"> 
  <meta name="search.ms_product" content="Azure"> 
  <meta name="depot_name" content="Azure.azure-documents"> 
  <meta name="updated_at" content="2017-09-27 10:08 PM"> 
  <meta name="gitcommit" content="https://github.com/MicrosoftDocs/azure-docs-pr/blob/1558b384de51c4a144d8aeb918a7931382b8f882/articles/iot-hub/iot-hub-node-node-c2d.md"> 
  <meta name="original_content_git_url" content="https://github.com/MicrosoftDocs/azure-docs-pr/blob/live/articles/iot-hub/iot-hub-node-node-c2d.md"> 
  <meta name="document_id" content="e1cc9b16-921f-65a3-4eaf-8df9c2d28888"> 
  <meta name="pagetype" content="Conceptual"> 
  <meta name="toc_rel" content="TOC.json"> 
  <meta name="pdf_url_template" content="https://docs.microsoft.com/pdfstore/en-us/Azure.azure-documents/{branchName}{pdfName}"> 
  <meta name="word_count" content="992"> 
  <meta name="scope" content="Azure"> 
  <link href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-node-node-c2d" rel="canonical"> 
  <title>Cloud-to-device messages with Azure IoT Hub (Node) | Microsoft Docs</title> 
  <link rel="stylesheet" href="/_themes/docs.theme/master/en-us/_themes/css/870b0825531b1b071dff.site.css "> 
  <link rel="stylesheet" href="/_themes/docs.theme/master/en-us/_themes/css/870b0825531b1b071dff.conceptual.css "> 
  <link rel="stylesheet" href="/_themes/docs.theme/master/en-us/_themes/global/css/azureHeader.css?v=4"> 
  <link rel="stylesheet" href="https://azure.microsoft.com/en-us/asset/menucss/"> 
  <script>
	var msDocs = {
		data:{
			contentLocale: 'en-us',
			contentDir: 'ltr',
			userLocale: 'en-us',
			userDir: 'ltr',
			pathToTheme: '/_themes/docs.theme/master/en-us/_themes/',
			pageTemplate: 'Conceptual',
			brand: 'azure',
			forceVersionPicker:false		},
		functions:{},
		settings:{
			extendBreadcrumb: false
		}
	};
	if (!('Promise' in window && 'resolve' in window.Promise && 'reject' in window.Promise && 'all' in window.Promise && 'race' in window.Promise)) {
		document.write('<script src="/_themes/docs.theme/master/en-us/_themes/global/js/bluebird.min.js"><\/script>');
	}
	</script> 
  <!--[if lt IE 9]>
		<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.4.min.js"></script>
		<script src="/_themes/docs.theme/master/en-us/_themes/global/js/polyfills/all.js"></script>
<script src="/_themes/docs.theme/master/en-us/_themes/global/js/azureHeader/respond_and_ie8Setup_combine.js"></script>	<![endif]--> 
  <!--[if gte IE 9]><!--> 
  <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.2.4.min.js"></script> 
  <!--<![endif]--> 
  <script>window.jQuery || document.write('<script src="/_themes/docs.theme/master/en-us/_themes/global/js/jquery/jquery-1.12.4.min.js"><\/script>')</script> 
  <script src="/_themes/docs.theme/master/en-us/_themes/global/js/global.min.js?v=263"></script> 
  <script src="/_themes/docs.theme/master/en-us/_themes/global/js/azureHeader/loader.js?v=4"></script> 
 </head> 
 <body> 
  <div id="lca-cookie-notification" class="cookieContainer"> 
  </div> 
  <div id="headerAreaHolder" class="az_h default" ms.pgarea="header" data-bi-name="header"> 
   <div class="azure-header_holder"> 
    <div class="azure-header"> 
     <header class="azure-header_temp"> 
      <div class="row column"> 
       <a href="https://azure.microsoft.com/en-us/" class="logo" title="Microsoft Azure"> 
        <svg x="0px" y="0px" width="165px" height="20px" viewbox="0 0 165 20"> 
         <path fill="#29A5DE" d="M18,19H16V7.1C16,6.2,16,5,16.1,3.7h0c-0.2,0.8-0.4,1.4-0.5,1.7L9.5,19h-1l-6-13.5c-0.2-0.4-0.3-1-0.5-1.8
							h0C2,4.4,2,5.5,2,7.1V19H0V1.3h2.7l5.4,12.3c0.4,0.9,0.7,1.7,0.8,2.1H9c0.4-1,0.6-1.7,0.9-2.2l5.5-12.3H18V19z" /> 
         <path fill="#29A5DE" d="M22.8,3.1c-0.4,0-0.7-0.1-0.9-0.4s-0.4-0.6-0.4-0.9s0.1-0.7,0.4-0.9c0.3-0.3,0.6-0.4,0.9-0.4
							c0.4,0,0.7,0.1,0.9,0.4c0.3,0.3,0.4,0.6,0.4,0.9c0,0.4-0.1,0.7-0.4,0.9C23.5,3,23.2,3.1,22.8,3.1z M23.8,19h-2V6.3h2V19z" /> 
         <path fill="#29A5DE" d="M35.8,18.4c-1,0.6-2.1,0.9-3.5,0.9c-1.8,0-3.3-0.6-4.4-1.8c-1.1-1.2-1.7-2.7-1.7-4.6c0-2.1,0.6-3.7,1.8-5
							C29.4,6.7,30.9,6,32.9,6C34,6,35,6.2,35.9,6.7v2.1c-0.9-0.7-1.9-1-3-1c-1.3,0-2.3,0.5-3.2,1.4c-0.8,0.9-1.2,2.1-1.2,3.6
							c0,1.5,0.4,2.6,1.2,3.5c0.8,0.9,1.8,1.3,3.1,1.3c1.1,0,2.1-0.4,3.1-1.1V18.4z" /> 
         <path fill="#29A5DE" d="M44.9,8.4C44.5,8.1,44,8,43.3,8c-0.9,0-1.6,0.4-2.2,1.2c-0.6,0.8-0.9,1.9-0.9,3.3V19h-2V6.3h2v2.6h0
							c0.3-0.9,0.7-1.6,1.3-2.1c0.6-0.5,1.3-0.7,2-0.7c0.5,0,0.9,0.1,1.2,0.2V8.4z" /> 
         <path fill="#29A5DE" d="M51.4,19.3c-1.9,0-3.4-0.6-4.5-1.8c-1.1-1.2-1.7-2.7-1.7-4.7c0-2.1,0.6-3.8,1.7-5S49.7,6,51.7,6
							c1.9,0,3.4,0.6,4.4,1.7c1.1,1.2,1.6,2.8,1.6,4.8c0,2-0.6,3.6-1.7,4.8C54.8,18.6,53.3,19.3,51.4,19.3z M51.5,7.7
							c-1.3,0-2.3,0.4-3.1,1.3c-0.8,0.9-1.1,2.1-1.1,3.7c0,1.5,0.4,2.7,1.1,3.5c0.8,0.9,1.8,1.3,3.1,1.3c1.3,0,2.3-0.4,3-1.3
							c0.7-0.8,1.1-2,1.1-3.6c0-1.6-0.4-2.8-1.1-3.6C53.8,8.2,52.8,7.7,51.5,7.7z" /> 
         <path fill="#29A5DE" d="M59.5,18.5v-2.2c1.1,0.8,2.3,1.2,3.6,1.2c1.8,0,2.7-0.6,2.7-1.8c0-0.3-0.1-0.6-0.2-0.9
							c-0.2-0.2-0.4-0.4-0.6-0.6c-0.3-0.2-0.6-0.3-0.9-0.5c-0.3-0.1-0.7-0.3-1.1-0.4c-0.6-0.2-1-0.4-1.5-0.7c-0.4-0.2-0.8-0.5-1.1-0.8
							c-0.3-0.3-0.5-0.6-0.6-1c-0.1-0.4-0.2-0.8-0.2-1.3c0-0.6,0.1-1.1,0.4-1.6C60.2,7.7,60.5,7.3,61,7c0.5-0.3,1-0.5,1.5-0.7
							C63.1,6.1,63.7,6,64.3,6c1.1,0,2.1,0.2,2.9,0.6v2c-0.9-0.6-2-0.9-3.2-0.9c-0.4,0-0.7,0-1,0.1c-0.3,0.1-0.6,0.2-0.8,0.4
							c-0.2,0.2-0.4,0.3-0.5,0.6c-0.1,0.2-0.2,0.5-0.2,0.7c0,0.3,0.1,0.6,0.2,0.8c0.1,0.2,0.3,0.4,0.5,0.6c0.2,0.2,0.5,0.3,0.8,0.5
							c0.3,0.1,0.7,0.3,1.1,0.5c0.6,0.2,1.1,0.4,1.5,0.7c0.4,0.2,0.8,0.5,1.1,0.8c0.3,0.3,0.6,0.6,0.7,1c0.2,0.4,0.3,0.8,0.3,1.3
							c0,0.6-0.1,1.2-0.4,1.6c-0.3,0.5-0.6,0.8-1.1,1.1c-0.5,0.3-1,0.5-1.6,0.7c-0.6,0.1-1.2,0.2-1.9,0.2C61.6,19.3,60.4,19,59.5,18.5z" /> 
         <path fill="#29A5DE" d="M75.6,19.3c-1.9,0-3.4-0.6-4.5-1.8c-1.1-1.2-1.7-2.7-1.7-4.7c0-2.1,0.6-3.8,1.7-5C72.4,6.6,73.9,6,75.9,6
							c1.9,0,3.4,0.6,4.4,1.7c1.1,1.2,1.6,2.8,1.6,4.8c0,2-0.6,3.6-1.7,4.8C79,18.6,77.5,19.3,75.6,19.3z M75.7,7.7
							c-1.3,0-2.3,0.4-3.1,1.3c-0.8,0.9-1.1,2.1-1.1,3.7c0,1.5,0.4,2.7,1.1,3.5c0.8,0.9,1.8,1.3,3.1,1.3c1.3,0,2.3-0.4,3-1.3
							c0.7-0.8,1.1-2,1.1-3.6c0-1.6-0.4-2.8-1.1-3.6C78.1,8.2,77,7.7,75.7,7.7z" /> 
         <path fill="#29A5DE" d="M97.6,8.1V6.3h-3.2V2.6l-2,0.7v3.1h-2.6h-1.5h-1.4V4.4c0-1.8,0.7-2.7,2.1-2.7c0.5,0,0.9,0.1,1.3,0.3V0.2
							C89.9,0.1,89.4,0,88.8,0c-1.1,0-2.1,0.4-2.9,1.2c-0.8,0.8-1.1,1.8-1.1,3.1v2h-2.2v1.7h2.2V19h2V8.1h1.4h1.5h2.6v7.5
							c0,2.5,1.1,3.7,3.3,3.7c0.8,0,1.4-0.1,1.9-0.4v-1.7c-0.4,0.3-0.8,0.4-1.3,0.4c-0.7,0-1.1-0.2-1.4-0.5c-0.3-0.4-0.4-1-0.4-1.8V8.1
							H97.6z" /> 
         <path fill="#29A5DE" d="M119.9,19h-2.3l-1.9-5h-7.5l-1.8,5h-2.3L111,1.3h2.1L119.9,19z M115.1,12.1l-2.8-7.5
							c-0.1-0.2-0.2-0.6-0.3-1.2h0c-0.1,0.5-0.2,0.9-0.3,1.2l-2.7,7.5H115.1z" /> 
         <path fill="#29A5DE" d="M130.4,6.9l-7.5,10.3h7.4V19H120v-0.6l7.5-10.3h-6.8V6.3h9.7V6.9z" /> 
         <path fill="#29A5DE" d="M142.6,19h-2v-2h0c-0.8,1.5-2.1,2.3-3.9,2.3c-3,0-4.5-1.8-4.5-5.4V6.3h2v7.2c0,2.7,1,4,3.1,4
							c1,0,1.8-0.4,2.4-1.1c0.6-0.7,1-1.7,1-2.9V6.3h2V19z" /> 
         <path fill="#29A5DE" d="M152.6,8.4c-0.4-0.3-0.9-0.4-1.5-0.4c-0.9,0-1.6,0.4-2.2,1.2c-0.6,0.8-0.9,1.9-0.9,3.3V19h-2V6.3h2v2.6h0
							c0.3-0.9,0.7-1.6,1.3-2.1c0.6-0.5,1.3-0.7,2-0.7c0.5,0,0.9,0.1,1.2,0.2V8.4z" /> 
         <path fill="#29A5DE" d="M164,13.1h-8.9c0,1.4,0.4,2.5,1.1,3.3c0.7,0.8,1.7,1.1,3,1.1c1.4,0,2.7-0.5,3.9-1.4V18
							c-1.1,0.8-2.6,1.2-4.4,1.2c-1.8,0-3.2-0.6-4.2-1.7c-1-1.1-1.5-2.8-1.5-4.8c0-2,0.6-3.6,1.7-4.8c1.1-1.2,2.5-1.9,4.1-1.9
							s2.9,0.5,3.8,1.6s1.4,2.6,1.4,4.4V13.1z M161.9,11.4c0-1.2-0.3-2.1-0.8-2.7c-0.6-0.6-1.3-1-2.3-1c-1,0-1.8,0.3-2.4,1
							c-0.7,0.7-1.1,1.6-1.2,2.7H161.9z" /> 
        </svg> </a> 
       <a href="#" class="small-search" onclick="return false"><span class="icon icon-search"></span></a> 
      </div> 
     </header> 
    </div> 
   </div> 
  </div> 
  <div class="container mainContainer" lang="en-us" dir="ltr" ms.pgarea="body" data-bi-name="body"> 
   <main role="main" ms.cmpgrp="content" data-bi-name="content"> 
    <div id="main"> 
     <h1 id="send-cloud-to-device-messages-with-iot-hub-node" sourcefile="articles/iot-hub/iot-hub-node-node-c2d.md" sourcestartlinenumber="20" sourceendlinenumber="20">Send cloud-to-device messages with IoT Hub (Node)</h1> 
     <div class="metadata loading" ms.cmpgrp="page info" data-bi-name="page info"> 
      <div> 
       <time class="date" datetime="6/16/2017 12:00:00 AM">2017-6-16</time> 
       <span class="reading-time">4 minutes to read</span> 
       <span class="contributors-text">Contributors</span> 
       <ul class="contributors" ms.cmpgrp="contributors" data-bi-name="contributors"> 
        <li><a href="https://github.com/dominicbetts" title="dominicbetts" ms.cmpnm="contributorprofile" data-bi-name="contributorprofile"><img src="https://github.com/dominicbetts.png?size=16" alt="dominicbetts"></a></li> 
        <li><a href="https://github.com/msebolt" title="Matthew Sebolt" ms.cmpnm="contributorprofile" data-bi-name="contributorprofile"><img src="https://github.com/msebolt.png?size=16" alt="Matthew Sebolt"></a></li> 
        <li><a href="https://github.com/olivierbloch" title="Olivier Bloch" ms.cmpnm="contributorprofile" data-bi-name="contributorprofile"><img src="https://github.com/olivierbloch.png?size=16" alt="Olivier Bloch"></a></li> 
        <li><a href="https://github.com/elioda" title="elioda" ms.cmpnm="contributorprofile" data-bi-name="contributorprofile"><img src="https://github.com/elioda.png?size=16" alt="elioda"></a></li> 
       </ul> 
      </div> 
      <nav id="center-doc-outline" class="doc-outline" ms.cmpgrp="intopic toc" data-bi-name="intopic toc" role="navigation" aria-label="On page navigation"> 
       <h3>In this article</h3> 
      </nav> 
     </div> 
     <div>
      <div class="content"> 
       <div class="op_single_selector">
        <ul> 
         <li><a href="iot-hub-csharp-csharp-c2d" data-linktype="relative-path">C#</a></li> 
         <li><a href="iot-hub-java-java-c2d" data-linktype="relative-path">Java</a></li> 
         <li><a href="iot-hub-node-node-c2d" data-linktype="relative-path">Node.js</a></li> 
        </ul> 
       </div> 
       <h2 id="introduction">Introduction</h2> 
       <p>Azure IoT Hub is a fully managed service that helps enable reliable and secure bi-directional communications between millions of devices and a solution back end. The <a href="iot-hub-node-node-getstarted" data-linktype="relative-path">Get started with IoT Hub</a> tutorial shows how to create an IoT hub, provision a device identity in it, and code a simulated device app that sends device-to-cloud messages.</p> 
       <p>This tutorial builds on <a href="iot-hub-node-node-getstarted" data-linktype="relative-path">Get started with IoT Hub</a>. It shows you how to:</p> 
       <ul> 
        <li>From your solution back end, send cloud-to-device messages to a single device through IoT Hub.</li> 
        <li>Receive cloud-to-device messages on a device.</li> 
        <li>From your solution back end, request delivery acknowledgement (<em>feedback</em>) for messages sent to a device from IoT Hub.</li> 
       </ul> 
       <p>You can find more information on cloud-to-device messages in the <a href="iot-hub-devguide-messaging" data-linktype="relative-path">IoT Hub developer guide</a>.</p> 
       <p>At the end of this tutorial, you run two Node.js console apps:</p> 
       <ul> 
        <li><strong>SimulatedDevice</strong>, a modified version of the app created in <a href="iot-hub-node-node-getstarted" data-linktype="relative-path">Get started with IoT Hub</a>, which connects to your IoT hub and receives cloud-to-device messages.</li> 
        <li><strong>SendCloudToDeviceMessage</strong>, which sends a cloud-to-device message to the simulated device app through IoT Hub, and then receives its delivery acknowledgement.</li> 
       </ul> 
       <div class="NOTE">
        <h5>Note</h5>
        <p>IoT Hub has SDK support for many device platforms and languages (including C, Java, and Javascript) through Azure IoT device SDKs. For step-by-step instructions on how to connect your device to this tutorial's code, and generally to Azure IoT Hub, see the <a href="http://www.azure.com/develop/iot" data-linktype="external">Azure IoT Developer Center</a>.</p> 
       </div> 
       <p>To complete this tutorial, you need the following:</p> 
       <ul> 
        <li>Node.js version 4.0.x or later.</li> 
        <li>An active Azure account. (If you don't have an account, you can create a <a href="http://azure.microsoft.com/pricing/free-trial/" data-linktype="external">free account</a> in just a couple of minutes.)</li> 
       </ul> 
       <h2 id="receive-messages-in-the-simulated-device-app">Receive messages in the simulated device app</h2> 
       <p>In this section, you modify the simulated device app you created in <a href="iot-hub-node-node-getstarted" data-linktype="relative-path">Get started with IoT Hub</a> to receive cloud-to-device messages from the IoT hub.</p> 
       <ol> 
        <li>Using a text editor, open the SimulatedDevice.js file.</li> 
        <li><p>Modify the <strong>connectCallback</strong> function to handle messages sent from IoT Hub. In this example, the device always invokes the <strong>complete</strong> function to notify IoT Hub that it has processed the message. Your new version of the <strong>connectCallback</strong> function looks like the following snippet:</p> <pre><code class="lang-javascript">var connectCallback = function (err) {
  if (err) {
    console.log('Could not connect: ' + err);
  } else {
    console.log('Client connected');
    client.on('message', function (msg) {
      console.log('Id: ' + msg.messageId + ' Body: ' + msg.data);
      client.complete(msg, printResultFor('completed'));
    });
    // Create a message and send it to the IoT Hub every second
    setInterval(function(){
        var temperature = 20 + (Math.random() * 15);
        var humidity = 60 + (Math.random() * 20);            
        var data = JSON.stringify({ deviceId: 'myFirstNodeDevice', temperature: temperature, humidity: humidity });
        var message = new Message(data);
        message.properties.add('temperatureAlert', (temperature &gt; 30) ? 'true' : 'false');
        console.log("Sending message: " + message.getData());
        client.sendEvent(message, printResultFor('send'));
    }, 1000);
  }
};
</code></pre>
         <div class="NOTE">
          <h5>Note</h5>
          <p>If you use HTTP instead of MQTT or AMQP as the transport, the <strong>DeviceClient</strong> instance checks for messages from IoT Hub infrequently (less than every 25 minutes). For more information about the differences between MQTT, AMQP and HTTP support, and IoT Hub throttling, see the <a href="iot-hub-devguide-messaging" data-linktype="relative-path">IoT Hub developer guide</a>.</p> 
         </div> </li> 
       </ol> 
       <h2 id="send-a-cloud-to-device-message">Send a cloud-to-device message</h2> 
       <p>In this section, you create a Node.js console app that sends cloud-to-device messages to the simulated device app. You need the device ID of the device you added in the <a href="iot-hub-node-node-getstarted" data-linktype="relative-path">Get started with IoT Hub</a> tutorial. You also need the IoT Hub connection string for your hub that you can find in the <a href="https://portal.azure.com" data-linktype="external">Azure portal</a>.</p> 
       <ol> 
        <li><p>Create an empty folder called <strong>sendcloudtodevicemessage</strong>. In the <strong>sendcloudtodevicemessage</strong> folder, create a package.json file using the following command at your command prompt. Accept all the defaults:</p> <pre><code class="lang-shell">npm init
</code></pre></li> 
        <li><p>At your command prompt in the <strong>sendcloudtodevicemessage</strong> folder, run the following command to install the <strong>azure-iothub</strong> package:</p> <pre><code class="lang-shell">npm install azure-iothub --save
</code></pre></li> 
        <li>Using a text editor, create a <strong>SendCloudToDeviceMessage.js</strong> file in the <strong>sendcloudtodevicemessage</strong> folder.</li> 
        <li><p>Add the following <code>require</code> statements at the start of the <strong>SendCloudToDeviceMessage.js</strong> file:</p> <pre><code class="lang-javascript">'use strict';

var Client = require('azure-iothub').Client;
var Message = require('azure-iot-common').Message;
</code></pre></li> 
        <li><p>Add the following code to <strong>SendCloudToDeviceMessage.js</strong> file. Replace the "{iot hub connection string}" placeholder value with the IoT Hub connection string for the hub you created in the <a href="iot-hub-node-node-getstarted" data-linktype="relative-path">Get started with IoT Hub</a> tutorial. Replace the "{device id}" placeholder with the device ID of the device you added in the <a href="iot-hub-node-node-getstarted" data-linktype="relative-path">Get started with IoT Hub</a> tutorial:</p> <pre><code class="lang-javascript">var connectionString = '{iot hub connection string}';
var targetDevice = '{device id}';

var serviceClient = Client.fromConnectionString(connectionString);
</code></pre></li> 
        <li><p>Add the following function to print operation results to the console:</p> <pre><code class="lang-javascript">function printResultFor(op) {
  return function printResult(err, res) {
    if (err) console.log(op + ' error: ' + err.toString());
    if (res) console.log(op + ' status: ' + res.constructor.name);
  };
}
</code></pre></li> 
        <li><p>Add the following function to print delivery feedback messages to the console:</p> <pre><code class="lang-javascript">function receiveFeedback(err, receiver){
  receiver.on('message', function (msg) {
    console.log('Feedback message:')
    console.log(msg.getData().toString('utf-8'));
  });
}
</code></pre></li> 
        <li><p>Add the following code to send a message to your device and handle the feedback message when the device acknowledges the cloud-to-device message:</p> <pre><code class="lang-javascript">serviceClient.open(function (err) {
  if (err) {
    console.error('Could not connect: ' + err.message);
  } else {
    console.log('Service client connected');
    serviceClient.getFeedbackReceiver(receiveFeedback);
    var message = new Message('Cloud to device message.');
    message.ack = 'full';
    message.messageId = "My Message ID";
    console.log('Sending message: ' + message.getData());
    serviceClient.send(targetDevice, message, printResultFor('send'));
  }
});
</code></pre></li> 
        <li>Save and close <strong>SendCloudToDeviceMessage.js</strong> file.</li> 
       </ol> 
       <h2 id="run-the-applications">Run the applications</h2> 
       <p>You are now ready to run the applications.</p> 
       <ol> 
        <li><p>At the command prompt in the <strong>simulateddevice</strong> folder, run the following command to send telemetry to IoT Hub and to listen for cloud-to-device messages:</p> <pre><code class="lang-shell">node SimulatedDevice.js 
</code></pre><p> <img src="media/iot-hub-node-node-c2d/receivec2d.png" alt="Run the simulated device app" data-linktype="relative-path"></p> </li> 
        <li><p>At a command prompt in the <strong>sendcloudtodevicemessage</strong> folder, run the following command to send a cloud-to-device message and wait for the acknowledgment feedback:</p> <pre><code class="lang-shell">node SendCloudToDeviceMessage.js 
</code></pre><p> <img src="media/iot-hub-node-node-c2d/sendc2d.png" alt="Run the app to send the cloud-to-device command" data-linktype="relative-path"></p> 
         <div class="NOTE">
          <h5>Note</h5>
          <p>For simplicity's sake, this tutorial does not implement any retry policy. In production code, you should implement retry policies (such as exponential backoff), as suggested in the MSDN article <a href="https://msdn.microsoft.com/library/hh680901(v=pandp.50).aspx" data-linktype="external">Transient Fault Handling</a>.</p> 
         </div> </li> 
       </ol> 
       <h2 id="next-steps">Next steps</h2> 
       <p>In this tutorial, you learned how to send and receive cloud-to-device messages. </p> 
       <p>To see examples of complete end-to-end solutions that use IoT Hub, see <a href="https://azure.microsoft.com/documentation/suites/iot-suite/" data-linktype="external">Azure IoT Suite</a>.</p> 
       <p>To learn more about developing solutions with IoT Hub, see the <a href="iot-hub-devguide" data-linktype="relative-path">IoT Hub developer guide</a>.</p> 
       <!-- Images --> 
       <!-- Links --> 
      </div>
     </div> 
     <div id="comments-container" ms.cmpgrp="comments" data-bi-name="comments" role="form"></div> 
    </div> 
   </main> 
   <div class="pageActions"> 
    <div id="page-actions" ms.cmpgrp="pageactions" data-bi-name="pageactions" role="complementary"> 
     <div id="page-actions-content"> 
      <ul class="action-list"> 
       <li> <a href="#comments-container" id="comments-link" ms.cmpnm="comments" data-bi-name="comments"> <i class="icon icon-comments"></i>Comments </a> </li> 
       <li id="contenteditbtn"> <a href="https://github.com/Microsoft/azure-docs/blob/master/articles/iot-hub/iot-hub-node-node-c2d.md" title="Edit This Document" ms.cmpnm="edit" data-bi-name="edit"> <i class="icon icon-editor"></i>Edit </a> </li> 
       <li> <a href="#" class="sharebutton" title="Share This Document" ms.cmpnm="share" data-bi-name="share"><i class="icon icon-share"></i>Share</a> 
        <div class="share-container"> 
         <div>
          <a href="" class="share-twitter" ms.cmpnm="twitter" data-bi-name="twitter"><i class="icon icon-twitter"></i>Twitter</a>
         </div> 
         <div>
          <a href="" class="share-linkedin" ms.cmpnm="share-linkedin" data-bi-name="linkedin"><i class="icon icon-linkedin"></i>LinkedIn</a>
         </div> 
         <div>
          <a href="" class="share-facebook" ms.cmpnm="facebook" data-bi-name="facebook"><i class="icon icon-facebook"></i>Facebook</a>
         </div> 
         <div>
          <a href="" class="share-email" ms.cmpnm="email" data-bi-name="email"><i class="icon icon-email"></i>Email</a>
         </div> 
        </div> </li> 
       <li class="typeSep">|</li> 
       <li> <label for="theme-selector">Theme</label> <select id="theme-selector" data-bi-name="select-theme"> <option value="" class="removedOnload"></option> <option value="">Light</option> <option value="theme_night">Dark</option> </select> </li> 
      </ul> 
      <nav id="side-doc-outline" class="doc-outline" ms.cmpnm="intopic toc" data-bi-name="intopic toc" role="navigation" aria-label="On page navigation"> 
       <h3>In this article</h3> 
      </nav> 
     </div> 
    </div> 
   </div> 
   <ul class="breadcrumbs" ms.cmpgrp="breadcrumb" data-bi-name="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList" role="navigation" aria-label="Breadcrumb">
    <li></li>
   </ul> 
   <div class="sidebar" id="sidebar" ms.cmpgrp="left toc" data-bi-name="left toc" role="navigation" aria-label="Main Navigation" lang="en-us" dir="ltr"> 
    <div id="sidebarContent"> 
     <div class="filterHolder"> 
     </div> 
     <nav class="toc"></nav> 
     <div class="pdfDownloadHolder"></div> 
    </div> 
    <div class="tocSpace"></div> 
   </div> 
   <div id="menu-nav" class="dropdown-container" lang="en-us" dir="ltr"> 
    <div class="dropdown dropdown-full mobilenavi"> 
     <select> </select> 
    </div> 
   </div> 
  </div> 
  <div id="openFeedbackContainer" class="openfeedback-container footer-layout"></div> 
  <div class="container footerContainer"> 
   <footer id="footer" ms.pgarea="footer" data-bi-name="footer" class="footer-layout"> 
    <div class="container" role="contentinfo"> 
     <a data-mscc-ic="false" id="locale-selector-link" href="#" data-bi-name="select-locale" ms.cmpnm="select-locale"></a> 
     <ul class="links" ms.cmpgrp="footerlinks" data-bi-name="footerlinks"> 
      <li><a data-mscc-ic="false" href="https://docs.microsoft.com/teamblog" ms.cmpnm="bloglink" data-bi-name="bloglink">Blog</a></li> 
      <li><a data-mscc-ic="false" href="//privacy.microsoft.com/en-us/" ms.cmpnm="privacy" data-bi-name="privacy">Privacy &amp; Cookies</a></li> 
      <li><a data-mscc-ic="false" href="/en-us/legal/termsofuse" ms.cmpnm="termsofuse" data-bi-name="termsofuse">Terms of Use</a></li> 
      <li><a data-mscc-ic="false" href="//aka.ms/sitefeedback" ms.cmpnm="feedback" data-bi-name="feedback">Feedback</a></li> 
      <li id="impressum-section" hidden><a data-mscc-ic="false" id="impressum-link" href="#" ms.cmpnm="impressum" data-bi-name="impressum">Impressum</a></li> 
      <li><a data-mscc-ic="false" href="https://www.microsoft.com/en-us/legal/intellectualproperty/Trademarks/EN-US.aspx" ms.cmpnm="trademarks" data-bi-name="trademarks">Trademarks</a></li> 
     </ul> 
    </div> 
   </footer> 
  </div> 
  <script src="/_themes/docs.theme/master/en-us/_themes/javascript/870b0825531b1b071dff.conceptual.js"></script>  
 </body>
</html>