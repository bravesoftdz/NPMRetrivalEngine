<!-- casper-latest --><!doctype html>
<html>
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <title>Convert speech from an audio file to text using Google Speech API</title> 
  <meta name="description" content=""> 
  <meta name="HandheldFriendly" content="True"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <link rel="shortcut icon" href="/favicon.ico"> 
  <link rel="stylesheet" type="text/css" href="/assets/css/screen.css?v=ab3553ecfe"> 
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400"> 
  <link rel="stylesheet" type="text/css" href="/assets/css/prism.css?v=ab3553ecfe"> 
  <link rel="canonical" href="http://ghost.cod3.net/convert-speech-from-an-audio-file-to-text-using-google-speech-api/"> 
  <meta name="referrer" content="origin-when-cross-origin"> 
  <meta property="og:site_name" content="cod3.net"> 
  <meta property="og:type" content="article"> 
  <meta property="og:title" content="Convert speech from an audio file to text using Google Speech API"> 
  <meta property="og:description" content="The backstory I had to transcribe messages recorded from an iPhone in the m4a format, with a duration of 30 seconds to a couple of minutes, to text. After trying several APIs, I found the one from Google, without much surprise, to be the most accurate.  If you own an"> 
  <meta property="og:url" content="http://ghost.cod3.net/convert-speech-from-an-audio-file-to-text-using-google-speech-api/"> 
  <meta property="og:image" content="http://ghost.cod3.net/content/images/2017/02/graphophone-1.png"> 
  <meta property="article:published_time" content="2017-02-20T19:14:33.000Z"> 
  <meta property="article:modified_time" content="2017-02-20T19:14:33.000Z"> 
  <meta name="twitter:card" content="summary_large_image"> 
  <meta name="twitter:title" content="Convert speech from an audio file to text using Google Speech API"> 
  <meta name="twitter:description" content="The backstory I had to transcribe messages recorded from an iPhone in the m4a format, with a duration of 30 seconds to a couple of minutes, to text. After trying several APIs, I found the one from Google, without much surprise, to be the most accurate.  If you own an"> 
  <meta name="twitter:url" content="http://ghost.cod3.net/convert-speech-from-an-audio-file-to-text-using-google-speech-api/"> 
  <meta name="twitter:image" content="http://ghost.cod3.net/content/images/2017/02/graphophone-1.png"> 
  <meta name="twitter:label1" content="Written by"> 
  <meta name="twitter:data1" content="Julien"> 
  <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "cod3.net",
        "logo": "http://ghost.cod3.net/content/images/2015/08/zorro.gif"
    },
    "author": {
        "@type": "Person",
        "name": "Julien",
        "image": "//www.gravatar.com/avatar/d597a431570c72973cf7d77ac0815421?s=250&d=mm&r=x",
        "url": "http://ghost.cod3.net/author/julien/",
        "sameAs": [
            "https://twitter.com/j_____________n"
        ],
        "description": "French web developer, nice feathers, very tasty."
    },
    "headline": "Convert speech from an audio file to text using Google Speech API",
    "url": "http://ghost.cod3.net/convert-speech-from-an-audio-file-to-text-using-google-speech-api/",
    "datePublished": "2017-02-20T19:14:33.000Z",
    "dateModified": "2017-02-20T19:14:33.000Z",
    "image": "http://ghost.cod3.net/content/images/2017/02/graphophone-1.png",
    "description": "The backstory I had to transcribe messages recorded from an iPhone in the m4a format, with a duration of 30 seconds to a couple of minutes, to text. After trying several APIs, I found the one from Google, without much surprise, to be the most accurate.  If you own an"
}
    </script> 
  <meta name="generator" content="Ghost 0.9"> 
  <link rel="alternate" type="application/rss+xml" title="cod3.net" href="http://ghost.cod3.net/rss/"> 
 </head> 
 <body class="post-template nav-closed"> 
  <div class="nav"> 
   <h3 class="nav-title">Menu</h3> 
   <a href="#" class="nav-close"> <span class="hidden">Close</span> </a> 
   <ul> 
    <li class="nav-home" role="presentation"><a href="http://ghost.cod3.net/">Home</a></li> 
    <li class="nav-about-ghost" role="presentation"><a href="http://ghost.cod3.net/tag/ghost-tag/">About Ghost</a></li> 
    <li class="nav-about-debian" role="presentation"><a href="http://ghost.cod3.net/tag/debian/">About Debian</a></li> 
    <li class="nav-about-apache" role="presentation"><a href="http://ghost.cod3.net/tag/apache/">About Apache</a></li> 
   </ul> 
   <a class="subscribe-button icon-feed" href="http://ghost.cod3.net/rss/">Subscribe</a> 
  </div> 
  <span class="nav-cover"></span> 
  <div class="site-wrapper"> 
   <header class="main-header post-head " style="background-image: url(/content/images/2017/02/graphophone-1.png)"> 
    <nav class="main-nav overlay clearfix"> 
     <a class="blog-logo" href="http://ghost.cod3.net"><img src="/content/images/2015/08/zorro.gif" alt="cod3.net"></a> 
     <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a> 
    </nav> 
   </header> 
   <main class="content" role="main"> 
    <article class="post"> 
     <header class="post-header"> 
      <h1 class="post-title">Convert speech from an audio file to text using Google Speech API</h1> 
      <section class="post-meta"> 
       <time class="post-date" datetime="2017-02-20">20 February 2017</time> 
      </section> 
     </header> 
     <section class="post-content"> 
      <p><img src="/content/images/2017/02/transcript.gif" alt=""></p> 
      <h3 id="thebackstory">The backstory</h3> 
      <p>I had to transcribe messages recorded from an iPhone in the m4a format, with a duration of 30 seconds to a couple of minutes, to text. After trying several APIs, I found the one from Google, without much surprise, to be the most accurate. </p> 
      <p>If you own an Android phone, you can expect about the same accuracy as when you use the "OK Google" application to send an SMS message. So something like 80% hit, 20% gibberish. Which you know could be worse, if you have ever used the Youtube auto-caption feature.</p> 
      <p><img src="http://images5.fanpop.com/image/photos/31100000/Closed-Caption-FAIL-my-little-pony-friendship-is-magic-31183544-500-281.jpg" alt=""></p> 
      <p>This created the following issues for the project:</p> 
      <ul> 
       <li><p>The expected input format for the Google Speech API is LINEAR16 PCM (.wav), not m4a. </p></li> 
       <li><p>Audio files that last more than 1 minute must be uploaded to Google Storage, you can't send them to the Google Speech API directly.</p></li> 
      </ul> 
      <h3 id="thetasks">The tasks</h3> 
      <p>Let's split the problem into simple tasks:</p> 
      <ul> 
       <li><a href="#google-account">Create a Google Cloud account</a></li> 
       <li><a href="#linear16">Convert the audio file to LINEAR16</a></li> 
       <li><a href="#google-storage">Upload the converted file to Google Storage</a></li> 
       <li><a href="#google-speech">Send the uploaded file to the Speech API</a></li> 
       <li><a href="#console-log">Display the transcription into the console</a></li> 
      </ul> 
      <p><a name="google-account"></a><strong>Create a Google Cloud account</strong></p> 
      <p>I won't really go into details for this, just go to <a href="https://cloud.google.com/">https://cloud.google.com/</a> and follow the steps for signing up. You will have to create a service account for your application, so follow the instructions at <a href="https://cloud.google.com/speech/docs/common/auth#set_up_a_service_account">Creating a Service Account</a>.</p> 
      <p>Like instructed, save the JSON file generated with your credentials locally, and create a copy at the root of your project (as <code>credentials.json</code> for example).</p> 
      <p><a name="linear16"></a><strong>Convert the audio file to LINEAR16</strong> </p> 
      <p>The Google Speech API documentation specifies that the expected input format is LINEAR16, but never really explains concretely how to convert an existing file to this format.</p> 
      <p><img src="http://s2.quickmeme.com/img/4b/4b94a42e7d20c9c425695dc405a21b31a38422758873247d103fa0b9059863ac.jpg" alt=""></p> 
      <p>My knowledge about audio formats is really limited, but after a little while I found <a href="https://groups.google.com/forum/#!topic/cloud-speech-discuss/tbQHoaTTNH8">this conversation</a> and more specifically, this comment by <em>droidha...@gmail.com</em>:</p> 
      <blockquote> 
       <p>And here is an example for those that might be using ffmpeg to get audio from video sources or just using ffmpeg for conversion</p> 
       <p>ffmpeg foo.mp4 -f s16le -acodec pcm_s16le -vn -ac 1 -ar 16k foo.raw</p> 
       <p>the point to note is that its is s16le (little endian (intel) byte ordering) and this also down mixes to mono with -ac 1 and the -ar (audio rate) is 16k</p> 
      </blockquote> 
      <p>Though I'm still not sure if the last line really means something or was auto-generated by a Twitter bot, I downloaded the FFmpeg binary for my platform, tried the command and it worked!</p> 
      <p>So I had to code a node.js version of this command. I found a node module that wraps FFmpeg (fluent-ffmpeg). It's pretty well done but requires <a href="https://github.com/fluent-ffmpeg/node-fluent-ffmpeg#prerequisites">a specific installation of FFmpeg</a>.</p> 
      <p>After copying and tweaking bits from similar projects, I came up with the following code:</p> 
      <pre><code class="language-js">'use strict';

const ffmpeg = require('fluent-ffmpeg');  
const mime = require('mime');  
const fs = require('fs');

module.exports = (filePathIn, filePathOut) =&gt; new Promise((resolve, reject) =&gt; {  
    if (!filePathIn || !filePathOut) {
        throw new Error('You must specify a path for both input and output files.');
    }
    if (!fs.existsSync(filePathIn)) {
        throw new Error('Input file must exist.');
    }
    if (mime.lookup(filePathIn).indexOf('audio') &gt; -1) {
        try {
            ffmpeg()
                .input(filePathIn)
                .outputOptions([
                    '-f s16le',
                    '-acodec pcm_s16le',
                    '-vn',
                    '-ac 1',
                    '-ar 16k',
                    '-map_metadata -1'
                ])
                .save(filePathOut)
                .on('end', () =&gt; resolve(filePathOut));

        } catch (e) {
            reject(e);
        }
    } else {
        throw new Error('File must have audio mime.');
    }
});
</code></pre> 
      <p>Since I crave geek-cred, I published <a href="https://github.com/bouiboui/linear16">the source on Github</a> and <a href="https://www.npmjs.com/package/linear16">a package on npm</a>: </p> 
      <pre><code class="language-bash">npm i --save linear16  
</code></pre> 
      <p><a name="google-storage"></a><strong>Upload the converted file to Google Storage</strong></p> 
      <p><img src="https://uncivilpeasants.files.wordpress.com/2012/01/walrus1.png" alt=""></p> 
      <p>First, you will have to create a "bucket", a place where your files will be uploaded. You can do so through the SDK, I did it manually. It's very intuitive but <a href="https://cloud.google.com/storage/docs/creating-buckets">here's a tutorial</a> if you need some help.</p> 
      <p>The Google node SDK is pretty easy to use, just authenticate using your project id and your credentials file, select the bucket where you want to upload your files and specify the path of the file to upload:</p> 
      <pre><code class="language-js">const gcs = require('@google-cloud/storage')({  
    projectId: 'your-projectid-12345',
    keyFilename: './credentials.json'
});

const bucket = gcs.bucket('your-bucket-name');

module.exports = filePath =&gt; new Promise((resolve, reject) =&gt;  
    bucket.upload(filePath, function (err, file) {
        if (err) {
            reject(err);
        } else {
            resolve(file);
        }
    })
);
</code></pre> 
      <p><em>Don't forget to replace "your-project-id" and "your-bucket-name" in this script.</em></p> 
      <p>Once uploaded, the files are accessible throughout the Google API ecosystem via a special path, following this pattern: </p> 
      <pre><code>gs://your-bucket-name/your-file-name.ext  
</code></pre> 
      <p><a name="google-speech"></a><strong>Send the uploaded file to the Google Speech API</strong></p> 
      <p>The Speech API is also pretty easy to use, we have to specify the input format and use the <em>startRecognition</em> method. A pretty interesting feature of the Speech API is that it recognizes <a href="https://cloud.google.com/speech/docs/languages">a wide range of languages</a>.</p> 
      <pre><code class="language-js">const speechClient = require('@google-cloud/speech')({  
    projectId: 'your-projectid-12345',
    keyFilename: './credentials.json'
});

const options = {  
    'languageCode': 'en-US',
    'sampleRate': 16600,
    'encoding': 'LINEAR16'
};

module.exports = fileName =&gt;  
    new Promise((resolve, reject) =&gt; {
            speechClient.startRecognition(fileName, options, function (err, operation) {
                if (err) {
                    return reject(err)
                }
                operation
                    .on('error', function (err) {
                        return reject(err);
                    })
                    .on('complete', function (results) {
                        return resolve(results);
                    });
            });
        }
    );
</code></pre> 
      <p><em>Don't forget to replace "your-project-id" and "your-bucket-name" in this script.</em></p> 
      <p>Since we're dealing with an asynchronous request, the use of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises</a> is pretty fitting. Once the transcription is ready, the Promise will resolve with the resulting text.</p> 
      <p><a name="console-log"></a><strong>Display the transcription into the console</strong></p> 
      <p>At first I just displayed the text in the console, but since the transcription takes a little long (up to 1 minute for a minute-long file), I wanted a visual indicator that everything works correctly. </p> 
      <p>The simplest node module I found for this is the Spinner from <a href="https://github.com/nathanpeck/clui">clui</a>, which is an awesome pack of command-line UI components.</p> 
      <p>The result looks something like this: <img src="https://raw.githubusercontent.com/nathanpeck/clui/master/docs/spinner.gif" alt="" title=""></p> 
      <p>I also used <a href="https://www.npmjs.com/package/chalk">chalk</a> to add some colours to the output.</p> 
      <p><strong>Putting it all together</strong></p> 
      <p>I saved each component as a module:</p> 
      <ul> 
       <li><p>I published the LINEAR16 converter as the <code>linear16</code> package on npm, so I just have to call <code>require('linear16')</code> to use it.</p></li> 
       <li><p>I saved the Storage uploader as <code>libs/cloud-storage.js</code> and the Speech transcriber as <code>libs/cloud-speech.js</code>)</p></li> 
       <li><p>And I created a <code>index.js</code> main file to orchestrate all the operations.</p></li> 
      </ul> 
      <p>I think the result is pretty simple to follow, and it works! </p> 
      <pre><code class="language-js">'use strict';

const linear16 = require('linear16');  
const Spinner = require('clui').Spinner;

const cloudStore = require('./libs/cloud-storage');  
const cloudSpeech = require('./libs/cloud-speech');

const path = require('path');  
const chalk = require('chalk');

try {

    const countdown = new Spinner(`Starting...`);
    countdown.start();

    const params = {
        input: './input/input.m4a',
        output: './output/output.wav'
    };

    Promise.resolve(params)
        .then(paths =&gt; {
            countdown.message(`Converting ${path.basename(paths.input)} to ${path.basename(paths.output)}...`);
            return linear16(paths.input, paths.output);
        })
        .then(wavFile =&gt; {
            countdown.message(`Storing ${path.basename(wavFile)}...`);
            return cloudStore(wavFile);
        })
        .then(storageFile =&gt; {
            countdown.message(`Transcribing ${storageFile.name}...`);
            return cloudSpeech('gs://messages-audio/' + storageFile.name);
        })
        .then(transcription =&gt; {
            countdown.stop();
            console.log(chalk.green(transcription));
        })
        .catch(err =&gt; console.error(err));


} catch (err) {
    console.log(chalk.red(err.message));
    console.error(err);
}
</code></pre> 
      <p>I hope you enjoyed this post, don't hesitate to <a href="https://twitter.com/j_____________n">contact me on Twitter</a> if you have any question or comment!</p> 
     </section> 
     <footer class="post-footer"> 
      <figure class="author-image"> 
       <a class="img" href="/author/julien/" style="background-image: url(//www.gravatar.com/avatar/d597a431570c72973cf7d77ac0815421?s=250&amp;d=mm&amp;r=x)"><span class="hidden">Julien's Picture</span></a> 
      </figure> 
      <section class="author"> 
       <h4><a href="/author/julien/">Julien</a></h4> 
       <p>French web developer, nice feathers, very tasty.</p> 
       <div class="author-meta"> 
        <span class="author-location icon-location">Montpellier, France</span> 
        <span class="author-link icon-link"><a href="https://twitter.com/j_____________n">https://twitter.com/j_____________n</a></span> 
       </div> 
      </section> 
      <section class="share"> 
       <h4>Share this post</h4> 
       <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Convert%20speech%20from%20an%20audio%20file%20to%20text%20using%20Google%20Speech%20API&amp;url=http://ghost.cod3.net/convert-speech-from-an-audio-file-to-text-using-google-speech-api/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <span class="hidden">Twitter</span> </a> 
       <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://ghost.cod3.net/convert-speech-from-an-audio-file-to-text-using-google-speech-api/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"> <span class="hidden">Facebook</span> </a> 
       <a class="icon-google-plus" href="https://plus.google.com/share?url=http://ghost.cod3.net/convert-speech-from-an-audio-file-to-text-using-google-speech-api/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;"> <span class="hidden">Google+</span> </a> 
      </section> 
     </footer> 
    </article> 
   </main> 
   <aside class="read-next"> 
    <a class="read-next-story prev " style="background-image: url(/content/images/2015/11/1280px-Window_and_clock-_Mus-e_d-Orsay_10_April_2013.jpg)" href="/this-operation-requires-an-interactive-window-station/"> 
     <section class="post"> 
      <h2>This operation requires an interactive window station</h2> 
      <p>TL;DR: Leave your device plugged to your PC and "Refresh your PC" As an Android developer I've been…</p> 
     </section> </a> 
   </aside> 
   <footer class="site-footer clearfix"> 
    <section class="copyright">
     <a href="http://ghost.cod3.net">cod3.net</a> © 2017
    </section> 
    <section class="poweredby">
     Proudly published with 
     <a href="https://ghost.org">Ghost</a>
    </section> 
   </footer> 
  </div> 
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.0.min.js"></script> 
  <!-- You can safely delete this line if your theme does not require jQuery --> 
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script> 
  <script type="text/javascript" src="/assets/js/jquery.fitvids.js?v=ab3553ecfe"></script> 
  <script type="text/javascript" src="/assets/js/index.js?v=ab3553ecfe"></script> 
  <script type="text/javascript" src="/assets/js/prism.js?v=ab3553ecfe"></script>   
 </body>
</html>