<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
 <head> 
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
  <title>use Web::Scraper; - ???CPAN?????????</title> 
  <meta http-equiv="imagetoolbar" content="no"> 
  <link rel="shortcut icon" type="image/x-icon" href="http://blog.mag2.com/favicon.ico"> 
  <link rel="stylesheet" type="text/css" href="/styles-site.css"> 
 </head> 
 <body> 
  <div class="main"> 
   <h1><a href="/">???CPAN?????????</a></h1> 
   <div class="entry contents"> 
    <div class="cpanbook"> 
     <p><a href="http://cpanbook.koneta.org/"><img src="http://ecx.images-amazon.com/images/I/51GZEd2QiLL._SL90_.jpg" class="right"></a><b>???????</b></p> 
     <p>???????????<a href="http://cpanbook.koneta.org/">CPAN????????</a>???????????</p> 
     <p>?????????????</p> 
     <p>????????????????????<code>scraper { }</code>?????????????????<code>scraper</code>????????????????????</p> 
    </div> 
    <p><b>2007-12-29</b></p> 
    <h2 class="entry-title">use Web::Scraper;</h2> 
    <p>????????????</p> 
    <p>????????????????????????????????????? <a href="http://search.cpan.org/perldoc?Web::Scraper"><em>Web::Scraper</em></a> ???????????????????<em>???????</em>?HTML ????????????????????????????????????????????????????????????? miyagawa ????????</p> 
    <p>API ?????????????????? API ??????????????????????????HTML ??????????????????????? Perl ???????????????Web::Scraper ??????????????<a href="http://www.slideshare.net/miyagawa/web-scraper-shibuyapm-tech-talk-8">???????????</a>????????????????????</p> 
    <ul> 
     <li>???????? <em>CSS ???????</em>?? XPath??????????????</li> 
     <li>???????????<em>???????????????</em>???</li> 
     <li>?????? URL ??????????? Web::Scraper ?????????????????????<em>????????</em></li> 
    </ul> 
    <p>?????????????</p> 
    <h3>???</h3> 
    <p>Amazon ????????????????????????????</p> 
    <p><img src="/013-web-scraper/amazon.jpg"></p> 
    <pre><code>use Web::Scraper;
use URI;

# ????? yen ?????????????????
my $scraper = scraper {
    process '#buyboxTable b.price', 'yen' =&gt; 'TEXT';
};

# ????????URL????????
my $uri = new URI('http://www.amazon.co.jp/o/ASIN/B000WQKBE2/');

# ??????????????????????????
my $res = $scraper-&gt;scrape($uri);

print $res-&gt;{yen}; # ? 4,401
</code></pre> 
    <p>Web::Scraper ??use ??? <code>scraper</code> ????????????????<code>scraper</code> ??????????????????????????<code>{ }</code>???????<em>??????</em>????????????????????? <code>scrape()</code> ???????????? URL ?????????????????????????</p> 
    <h3>??</h3> 
    <p>scraper ????????????????????????</p> 
    <pre><code>process ????, ???????? =&gt; ??????????;
</code></pre> 
    <p>???????????<code>'#buyboxTable .price'</code> ????????<code>yen</code> ???????? <code>'TEXT'</code> ?????????????</p> 
    <h4>1. ????</h4> 
    <p>???? HTML ????????? CSS ???????? <a href="http://ja.wikipedia.org/wiki/XPath">XPath</a> ???????Amazon ?????? <code>id="buyboxTable"</code> ????? <code>&lt;b class="price"&gt;</code> ????? <code>'#buyboxTable b.price'</code> ?????????</p> 
    <p>???? XPath ? <code>'//table[ @id="buyboxTable" ]//b[ @class="price"]'</code> ???????? OK ????????? CSS ??????????????XPath ??????????? HTML ?????????????????????</p> 
    <h4>2. ???</h4> 
    <p>scraper ???????????????????????? process ???????????????????????????????????</p> 
    <pre><code>my $scraper = scraper {
    process '#buyboxTable .price', 'yen' =&gt; 'TEXT';
    process '#primaryUsedAndNew .price', 'used' =&gt; 'TEXT';
    process '//*[ @id="ftMessage" ]//b', 'delivery' =&gt; 'TEXT';
};
</code></pre> 
    <p>????<code>$scraper-&gt;scrape($uri)</code> ???????????????utf8 ???????</p> 
    <pre><code>{
    yen =&gt; "? 4,401",
    used =&gt; "? 3,639",
    delivery =&gt; "2007/12/28 ??? ????????",
}
</code></pre> 
    <p>???? process ???? result ??????????????????????????????????????????????????????????????????</p> 
    <p>???????????????????????????????????? <code>'item[]'</code> ???????????????????????????????????</p> 
    <pre><code># ? &lt;a&gt; ??? href ??? url ??????????
my $res = scraper { process 'a', 'url[]' =&gt; '@href'; }-&gt;scrape($uri);

use YAML;
print Dump $res;

# ??
---
url:
  - !!perl/scalar:URI::http http://www.amazon.co.jp/ref=bd_vg/250-9239974-3346614
  - !!perl/scalar:URI::http http://www.amazon.co.jp/gp/cart/view.html/ref=topnav__vg/250-9239974-3346614
  - !!perl/scalar:URI::http http://www.amazon.co.jp/gp/registry/wishlist/ref=topnav__vg/250-9239974-3346614
...
</code></pre> 
    <p>? <a href="http://search.cpan.org/perldoc?URI">URI</a> ?????????????????</p> 
    <h4>3. ????</h4> 
    <p><code>'TEXT'</code> ? <code>'@href'</code> ????????????????????????????????????????????????????????</p> 
    <p>??????http://example.com/ ?</p> 
    <pre><code>&lt;div&gt;
    &lt;a href="/2008.html" target="_blank"&gt;Happy New Year&lt;/a&gt;!
&lt;/div&gt;
</code></pre> 
    <p>??? HTML ??????????????????</p> 
    <ul> 
     <li><em>'HTML'</em> ????????? HTML??? <br> <code>process 'div', 'test' =&gt; 'HTML';</code> <br> ???? <code>'&lt;a href="/2008.html" target="_blank"&gt;Happy New Year&lt;/a&gt;!'</code></li> 
     <li><em>'TEXT'</em> ? HTML ???????????? <br> <code>process 'div', 'test' =&gt; 'TEXT';</code> <br> ???? <code>'Happy New Year!'</code></li> 
     <li><em>'@???'</em> ?????? <br> <code>process 'div a', 'test' =&gt; '@target';</code> <br> ???? <code>'_blank'</code></li> 
    </ul> 
    <p>??????????????????</p> 
    <ul> 
     <li><em>scraper {}</em> ?????????????</li> 
     <li><em>????</em> ??? <code>'TEXT'</code> ?????????????????????</li> 
     <li>??? <em>?????????</em>? <code>$_</code> ????? <a href="http://search.cpan.org/perldoc?HTML::Element">HTML::Element</a> ?????????????</li> 
    </ul> 
    <p>?????????????????????</p> 
    <p>???????????????????????scraper ????????????????</p> 
    <ul> 
     <li><p><em>????</em> ???????</p> <pre><code>process 'div a', 'link' =&gt; {
    text =&gt; 'TEXT',
    host =&gt; [ '@href', sub { $_-&gt;host } ],
};
</code></pre> <p>????????????</p> <pre><code>link =&gt; {
    text =&gt; 'Happy New Year',
    host =&gt; 'example.com',
}
</code></pre></li> 
    </ul> 
    <h3>???????????????</h3> 
    <p>Web::Scraper ?????????? scraper ???????????????????????HTML ?????????????????????????????????????????????????????????????????????????????????</p> 
    <pre><code>$ scraper &lt;??URL???html???????&gt;
</code></pre> 
    <p>?????? <br> ?????????????????? <a href="http://tv.yahoo.co.jp/bin/search?p=%A5%DF%A5%CB%A5%DF%A5%CB%A4%B5%A4%DE%A4%A1%A1%C1%A4%BA&amp;cate=0&amp;search222=%B8%A1%BA%F7&amp;area=tokyo">Yahoo?????????</a>??????????????</p> 
    <pre><code>$ scraper "http://tv.yahoo.co.jp/bin/sea...(??????)"

scraper&gt;
</code></pre> 
    <p>??<em>?????????? scraper ???</em>?????????????????? process ?????????????????? HTML ?????</p> 
    <pre><code>scraper&gt; s
</code></pre> 
    <p>??s ???????????????????????scraper + <a href="http://www.getfirebug.com/jp.html">Firebug</a> ????????</p> 
    <p><img src="/013-web-scraper/yahootv.jpg"></p> 
    <p>Firebug ??????? XPath ???? process ??????????scraper ??????? ????????? =&gt; ???????????????? WARN ???????????????????????????????????</p> 
    <pre><code>scraper&gt; process '/html/body/center/table[6]/tbody/tr[2]/td[2]/small', WARN;
</code></pre> 
    <p>?????????? Firebug ???? table ???? XPath ? Firefox ??????????????? HTML ???? tbody ???????????????????</p> 
    <pre><code>scraper&gt; process '/html/body/center/table[6]/tr[2]/td[2]/small', WARN;
&lt;small&gt;20:54?21:00&lt;/small&gt;
</code></pre> 
    <p>??????????????????????? tr ???????????????????????????? scraper ?????????????</p> 
    <pre><code>scraper&gt; process '/html/body/center/table[6]/tr/td[2]/small', WARN;
&lt;small&gt;20:54?21:00&lt;/small&gt;
&lt;small&gt;26:25?26:30&lt;/small&gt;
&lt;small&gt;17:54?18:00&lt;/small&gt;
...
</code></pre> 
    <p>?????????WARN ? <code>'list[]' =&gt; 'TEXT';</code> ????????????y ??????YAML::Dump ????????????</p> 
    <pre><code>scraper&gt; process '/html/body/center/table[6]/tr/td[2]/small', 'list[]' =&gt; 'TEXT';
scraper&gt; y
---
list:
  - 20:54?21:00
  - 26:25?26:30
  - 17:54?18:00
...
</code></pre> 
    <p>????c ????????????????????? process ??????????? c all ???</p> 
    <pre><code>scraper&gt; c
#!/usr/bin/perl
use strict;
use Web::Scraper;
use URI;

my $uri = URI-&gt;new("http://tv.yahoo.co.jp/bin/search?p=%A5%DF%A5%CB%A5%DF%A5%CB%A4%B5%A4%DE%A4%A1%A1%C1%A4%BA&amp;cate=0&amp;search222=%B8%A1%BA%F7&amp;area=tokyo");
my $scraper = scraper {
    process '/html/body/center/table[6]/tr/td[2]/small', 'list[]' =&gt; 'TEXT';
};
my $result = $scraper-&gt;scrape($uri);
</code></pre> 
    <p>??????????????????????????????????????????????????????????????</p> 
    <h3>TIPS</h3> 
    <p><em>UserAgent ????</em></p> 
    <pre><code>use LWP::UserAgent;
my $ua = new LWP::UserAgent( agent =&gt; 'Mozilla/5.0 ...' );

# ???
$scraper-&gt;user_agent($ua);

# ?? UA ????????
print Dumper $scraper-&gt;scrape($url);
</code></pre> 
    <p><em>Basic ??</em></p> 
    <pre><code># ?????????
my $url = new URI('http://user:pass@example.com/private/');
</code></pre> 
    <p><em>??????</em></p> 
    <p><code>$scraper-&gt;scrape()</code> ?? URI ??????????HTML ?????????????????????????? Mech ????????????? Web::Scraper ?????????</p> 
    <pre><code>use WWW::Mechanize;
my $mech = new WWW::Mechanize;

# mech ????...?????????
$mech-&gt;get('http://www.nicovideo.jp/ranking/view/daily/all');
$mech-&gt;submit_form(
    fields =&gt; {
      mail =&gt; 'me@example.jp',
      password =&gt; 'p4ssw0rd',
    },
);

# ???????????????
my $scraper = scraper {
    process 'a.video', 'ranking[]' =&gt; '@href';
};

# mech ?? HTML????????????
my $res = $scraper-&gt;scrape($mech-&gt;content);
</code></pre> 
    <p>HTML ??????????????????? URL ?????????????? Web::Scraper ??? URL ?????????????<code>scrape()</code> ??????????????mech ????????????????????</p> 
    <pre><code>my $res = $scraper-&gt;scrape($mech-&gt;content, $mech-&gt;uri);
</code></pre> 
    <h3>??</h3> 
    <ul> 
     <li>Web::Scraper? <a href="http://svn.bulknews.net/repos/public/Web-Scraper/trunk/eg">???????</a> ? <a href="http://svn.bulknews.net/repos/public/Web-Scraper/trunk/t">????????</a></li> 
     <li><a href="http://b.hatena.ne.jp/t/webscraper?sort=eid">????????? - ?? webscraper</a></li> 
     <li><a href="http://coderepos.org/share/browser/lang/perl/Encode-JP-Mobile/trunk/tools">Encode::JP::Mobile ? tools ??????</a>???????????????????????????????????????????</li> 
    </ul> 
    <h3>Happy holidays!</h3> 
    <p>????????????????????????<em>???????????????</em>???????????????????????????????? ???????????????????????????????</p> 
    <p>????????????</p> 
   </div> 
  </div> 
  <div class="side"> 
   <center> 
    <script type="text/javascript"><!--
google_ad_client = "pub-1968093116178894";
//120x600, e8y.net/mag
google_ad_slot = "8989667467";
google_ad_width = 120;
google_ad_height = 600;
//--></script> 
    <script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script> 
   </center> 
   <center class="onlyarchivepage"> 
    <script type="text/javascript"><!--
amazon_ad_tag = "ele-22";
amazon_ad_width = "120";
amazon_ad_height = "600";
amazon_ad_logo = "hide";
amazon_ad_border = "hide";
amazon_color_border = "FFFFFF";
amazon_color_text = "333333";
amazon_color_link = "1975A3";
amazon_color_price = "333333";
amazon_color_logo = "333333";//--></script> 
    <script type="text/javascript" src="http://www.assoc-amazon.jp/s/ads.js"></script> 
   </center> 
  </div>  
 </body>
</html>